# TITRE PROPAGATION D'UNE FISSURE X-FEM DANS UNE PLAQUE EN FLEXION 3 POINTS AVEC 3 TROUS
# ======================================================================
# COPYRIGHT (C) 1991 - 2015  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY  
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY  
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR     
# (AT YOUR OPTION) ANY LATER VERSION.                                                    
#                                                                       
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT   
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF            
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU      
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.                              
#                                                                       
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE     
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,         
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.        
# ======================================================================
# person_in_charge: samuel.geniaut at edf.fr
# MODELISATION A : METHODE MAILLAGE

DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON'),DEBUG=_F(SDVERI='OUI'))

PRE_GMSH()

#----------------------------------------------
#                 MAILLAGE
#----------------------------------------------

MA_INI=LIRE_MAILLAGE()

#Nb de pas de propagation
NPAS = 35

#Pas de propagation
DA = 0.1 

# RAYONS INFERIEUR ET SUPERIEUR DES COURONNES D'INTEGRATION POUR CALC_G
# RQ : ce choix n'est pas optimal car on se rapproche des trous a une distance de moins de 0.1
RI = 0.1
RS = 0.2

#longueur de fissure initiale
xinit = 5. 
yinit = 1.5 

#----------------------------------------------
#                   MODELE
#----------------------------------------------
MA_INI=DEFI_GROUP(reuse =MA_INI,
                  MAILLAGE=MA_INI,
                  CREA_GROUP_NO=(_F(NOM='P1',GROUP_NO='GM2',),
                                 _F(NOM='P2',GROUP_NO='GM3'),
                                 _F(NOM='P3',GROUP_NO='GM4'),),
                  CREA_GROUP_MA=(_F(NOM='Surface',GROUP_MA='GM1')))
                    
IMPR_RESU(FORMAT='MED',UNITE=80,RESU=_F(MAILLAGE=MA_INI))

MODEL = [None]*(NPAS+1)
MODE = [None]*(NPAS+1)
MOD = [None]*(NPAS+1)

MOD[0]=AFFE_MODELE(MAILLAGE=MA_INI,
                      AFFE=_F(GROUP_MA='Surface',
                              PHENOMENE='MECANIQUE',
                              MODELISATION='D_PLAN'))

#----------------------------------------------
#                   MATERIAU
#----------------------------------------------

E=205000E6
nu=0.3

ACIER=DEFI_MATERIAU(ELAS=_F(E=E,NU=nu))

#----------------------------------------------
#                FISSURE INITIALE
#----------------------------------------------

FISS = [None]*(NPAS+2)
MAT  = [None]*(NPAS+2)
MAX  = [None]*(NPAS+2)
MAX[0]=CO('MAX_0')
MAT[0]=CO('MAT_0')

# Initialisation
PROPA_FISS(METHODE_PROPA='INITIALISATION',
           MAIL_STRUC=MA_INI,
           MAIL_FISS = MAX[0],
           MAIL_TOTAL = MAT[0],
           FORM_FISS='DEMI_DROITE',
           INFO=2,
           PFON = (xinit, yinit, 0.),
           DTAN = (0., 1., 0.),
           )

RESU  = [None]*(NPAS+1)
RESV  = [None]*(NPAS+1)
SIF   = [None]*(NPAS+1)
LSN   = [None]*(NPAS+1)
LST   = [None]*(NPAS+1)
CHAMA = [None]*(NPAS+1)
CHRIG = [None]*(NPAS+1)

 
for i in range(NPAS+1) :
    
    MODEL[i]=AFFE_MODELE(MAILLAGE=MAT[i],
                      AFFE=_F(GROUP_MA='Surface',
                              PHENOMENE='MECANIQUE',
                              MODELISATION='D_PLAN')
                            )
 
                                                                       
    FISS[i]=DEFI_FISS_XFEM(MAILLAGE=MAT[i],    
                           DEFI_FISS=_F(GROUP_MA_FISS='FISS_'+str(i),
                                        GROUP_MA_FOND='FOND_'+str(i))
                           )              
                                             
    MODE[i]=MODI_MODELE_XFEM(MODELE_IN=MODEL[i],FISSURE=FISS[i])

    CHAMA[i]=AFFE_MATERIAU(MAILLAGE=MAT[i],
                           MODELE=MODE[i],
                           AFFE=_F(TOUT = 'OUI',
                                   MATER=ACIER)
                           )
                                                                      
    CHRIG[i]=AFFE_CHAR_MECA(MODELE=MODE[i],
                            DDL_IMPO=(_F(GROUP_NO='P1',DX=0.,DY=0.),
                                      _F(GROUP_NO='P2',DY=0.)),
                            FORCE_NODALE=_F(GROUP_NO='P3',FY=-1.),
                            )

    RESV[i]=MECA_STATIQUE(MODELE=MODE[i],
                          CHAM_MATER=CHAMA[i],
                          EXCIT=_F(CHARGE=CHRIG[i]))
       
    SIF[i]=CALC_G(RESULTAT=RESV[i],
                  OPTION='CALC_K_G',
                  THETA=_F(FISSURE=FISS[i],
                           R_INF=RI,
                           R_SUP=RS)
                  )         
               
    if ( i != NPAS+1 ) :
        MAX[i+1]=CO('MAX_%d' %(i+1));
        MAT[i+1]=CO('MAT_%d'%(i+1));
        PROPA_FISS(METHODE_PROPA='MAILLAGE',
                   MAIL_STRUC=MA_INI,
                   MAIL_TOTAL = MAT[i+1],
                   ITERATION = i+1,
                   FISSURE=_F(MAIL_ACTUEL = MAX[i],
                              MAIL_PROPAGE = MAX[i+1],
                              FISS_ACTUELLE = FISS[i],
                              TABLE = SIF[i],
                              ),
                   DA_MAX=DA,
                   LOI_PROPA = _F(LOI='PARIS',
                                  M=1,C=1,
                                  MATER=ACIER,   ),
                   COMP_LINE=_F(COEF_MULT_MINI=0.,
                                COEF_MULT_MAXI=1.,
                               ),
                   )
                
        IMPR_RESU(FORMAT='MED',UNITE=81,RESU=_F(MAILLAGE=MAX[i+1]))

#----------------------------------------------
#         VISU
#----------------------------------------------

for i in range(NPAS+1) :

    MAXFE = [None]*(NPAS+1)
    MOVIS = [None]*(NPAS+1)
    DEPL  = [None]*(NPAS+1)

    MAXFE[i]=POST_MAIL_XFEM(MODELE=MODE[i]);

    MOVIS[i]=AFFE_MODELE(MAILLAGE=MAXFE[i],
                         AFFE=_F(TOUT='OUI',
                                 PHENOMENE='MECANIQUE',
                                 MODELISATION='D_PLAN')) 

    DEPL[i]=POST_CHAM_XFEM(MODELE_VISU=MOVIS[i],
                           RESULTAT=RESV[i])

    IMPR_RESU(FORMAT='MED',UNITE=82,RESU=_F(RESULTAT=DEPL[i]))
             

# TEST DE KI ET KII AU DERNIER PAS
TEST_TABLE(CRITERE='RELATIF',
           VALE_CALC=1.14194685171,
           NOM_PARA='K1',
           TYPE_TEST='MAX',
           TABLE=SIF_35,
           )

# TEST DE KII PAR RAPPORT A KII MAILLAGE
TEST_TABLE(CRITERE='RELATIF',
           VALE_CALC=-0.0571068216349,
           NOM_PARA='K2',
           TYPE_TEST='MAX',
           TABLE=SIF_35,
           )

FIN();
