# MODIF  DATE 04/10/2010   AUTEUR GNICOLAS G.NICOLAS 
# TITRE VALIDATION DE LA MACRO-COMMANDE RAFF_XFEM SUR UNE PLAQUE MULTI-FISSUREE
# sslp317a.para = tps_job 60 mem_job 100Mo ncpus 1 liste_test S
#            CONFIGURATION MANAGEMENT OF EDF VERSION
# ======================================================================
# COPYRIGHT (C) 1991 - 2009  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY  
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY  
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR     
# (AT YOUR OPTION) ANY LATER VERSION.                                                    
#                                                                       
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT   
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF            
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU      
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.                              
#                                                                       
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE     
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,         
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.        
# ======================================================================

DEBUT(CODE=_F(NOM='SSLP317A',NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON'),DEBUG=_F(SDVERI='OUI'));

# nbre de raffinement
nb_raff = 3          

# initialisation
MA    = [None]*(nb_raff+1)
MO    = [None]*(nb_raff+1)
CHERR = [None]*(nb_raff+1)
FISS1 = [None]*(nb_raff+1)
FISS2 = [None]*(nb_raff+1)
FISS3 = [None]*(nb_raff+1)
FISS4 = [None]*(nb_raff+1)

PRE_GIBI();

def SIGN1(y) : 
   if y<0. : return 0. 
   if y>=0. : return 1.

def SIGN2(y) : 
   if y>=0. : return 0. 
   if y<0. : return 1.


r1 = 0.2       
LN1=FORMULE(NOM_PARA=('X','Y'),VALE='sqrt(X**2+Y**2)-r1');
LT1=FORMULE(NOM_PARA=('Y'),VALE='Y'); 


r2 = 0.05
LN2=FORMULE(NOM_PARA=('X','Y'),VALE='sqrt(X**2+Y**2)-r2');


def FLT4(x) :
     if ( x-0.3 ) >= 0. : return   x-0.3  -  0.1
     else :  return   -x+0.3 -  0.1
     
LN3=FORMULE(NOM_PARA=('X','Y'),VALE='Y-0.25');
LT3=FORMULE(NOM_PARA='X',VALE='FLT3(X)');


def FLT3(x) :
     if ( x+0.2 ) <= 0. : return   -x-0.2  -  0.1
     else :  return   x+0.2  -  0.1

LN4=FORMULE(NOM_PARA=('X','Y'),VALE='Y-0.25');
LT4=FORMULE(NOM_PARA='X',VALE='FLT4(X)');

num_calc=0   

MA[num_calc]=LIRE_MAILLAGE();
IMPR_RESU(FORMAT='GMSH',UNITE=89,RESU=_F(MAILLAGE=MA[num_calc]));

for num_calc in range(0,nb_raff+1) :
   MO[num_calc]=AFFE_MODELE(MAILLAGE=MA[num_calc],
                            AFFE=(_F(GROUP_MA=('SURF','LIG2','LIG3','LIG4'),
                                     PHENOMENE='MECANIQUE',
                                     MODELISATION='D_PLAN',),),);

   FISS1[num_calc]=DEFI_FISS_XFEM(MODELE=MO[num_calc],  
                                  DEFI_FISS=_F(FONC_LT=LT1,FONC_LN=LN1,),);

   FISS2[num_calc]=DEFI_FISS_XFEM(MODELE=MO[num_calc],  
                                  DEFI_FISS=_F(FONC_LN=LN2,),
                                  TYPE_DISCONTINUITE='INTERFACE',)

   FISS3[num_calc]=DEFI_FISS_XFEM(MODELE=MO[num_calc],  
                                  DEFI_FISS=_F(FONC_LT=LT3,FONC_LN=LN3,),);

   FISS4[num_calc]=DEFI_FISS_XFEM(MODELE=MO[num_calc],  
                                  DEFI_FISS=_F(FONC_LT=LT4,FONC_LN=LN4,),);

   # on ne raffine pas la derniere iteration
   if num_calc < nb_raff :

      CHERR[num_calc] = RAFF_XFEM(FISSURE=(FISS1[num_calc],FISS2[num_calc],FISS3[num_calc],FISS4[num_calc]),)

      IMPR_RESU(FORMAT='GMSH',UNITE=85,RESU=_F(CHAM_GD = CHERR[num_calc]));
      IMPR_RESU(RESU=_F(CHAM_GD = CHERR[num_calc]));

      # SUBTILITE MACRO_COMMANDE VIS A VIS DES ENTREES  
      MA[num_calc+1]=CO('MA_%d' % (num_calc+1))

      MACR_ADAP_MAIL(ADAPTATION='RAFFINEMENT',
                  CHAM_GD = CHERR[num_calc],
                  CRIT_RAFF_PE = 0.10,
                  TYPE_VALEUR_INDICA='V_RELATIVE',
                  MAILLAGE_N = MA[num_calc],
                  MAILLAGE_NP1 = MA[num_calc+1],
                  ELEMENTS_NON_HOMARD='IGNORER')


# definition group de noeuds pour bloquer l'inclusion centrale
MA[nb_raff]=DEFI_GROUP( reuse =MA[nb_raff],
                        MAILLAGE=MA[nb_raff],
                        CREA_GROUP_NO=_F(NOM='NC',OPTION='ENV_SPHERE',POINT=(0.,0.),PRECISION=1/200.,RAYON=1/200.),
                        INFO=2 );
                        
# impression du dernier maillage
IMPR_RESU(FORMAT='GMSH',UNITE=80,RESU=_F(MAILLAGE=MA[nb_raff]));
IMPR_RESU(FORMAT='GMSH',UNITE=81,RESU=_F(CHAM_GD=CHERR[nb_raff-1]));
#IMPR_RESU(RESU=_F(MAILLAGE=MA[nb_raff]));

MODELEK=MODI_MODELE_XFEM(MODELE_IN=MO[nb_raff],FISSURE=(FISS1[nb_raff],FISS2[nb_raff],FISS3[nb_raff],FISS4[nb_raff]),);

CHXFEM=AFFE_CHAR_MECA(MODELE=MODELEK,LIAISON_XFEM='OUI',INFO=1,);

ACIER=DEFI_MATERIAU(ELAS=_F(E=205000000000.0,
                            NU=0.3),);

CHAMPMAT=AFFE_MATERIAU(MAILLAGE=MA[nb_raff],
                       MODELE=MODELEK,
                       AFFE=_F(GROUP_MA='SURF',MATER=ACIER,),
                       );


#*********************************************************************
#                          CONDITIONS AUX LIMITES                    *
#*********************************************************************

CHARBLO=AFFE_CHAR_MECA(MODELE=MODELEK,
                       DDL_IMPO=_F(GROUP_MA='LIG1',
                                   DX=0.0,
                                   DY=0.0,),
                       );

# pour bloquer les modes rigides de l'inclusion centrale
CHARINC=AFFE_CHAR_MECA(MODELE=MODELEK,
                       DDL_IMPO=_F(GROUP_NO='NC',
                                   DX=0.0,DY=10.0,),
                       );

CHpres=AFFE_CHAR_MECA(MODELE=MODELEK,
                      PRES_REP=_F(GROUP_MA=('LIG2','LIG3','LIG4'),PRES=-1.e6,),);


L_INST=DEFI_LIST_REEL(DEBUT=0.0,
                      INTERVALLE=_F(JUSQU_A=1.0,
                                    NOMBRE=1),);

UTOT=STAT_NON_LINE(MODELE=MODELEK,
                   CHAM_MATER=CHAMPMAT,
                   EXCIT=(_F(CHARGE=CHARBLO,),
                          _F(CHARGE=CHARINC,),
                          _F(CHARGE=CHpres,),
                          _F(CHARGE=CHXFEM,),),
                   COMP_ELAS=_F(RELATION='ELAS',
                                GROUP_MA='SURF',),
                   INCREMENT=_F(LIST_INST=L_INST),
                   INFO=1,);

#---------------POST--------------------------------------------

MA_XFEM=POST_MAIL_XFEM(
                       MODELE        = MODELEK,
                       INFO          = 2)

MOD_VISU=AFFE_MODELE(MAILLAGE=MA_XFEM,
                     AFFE=_F(TOUT='OUI',
                              PHENOMENE='MECANIQUE',
                              MODELISATION='D_PLAN',),) 

RES_XFEM=POST_CHAM_XFEM(
                        MODELE_VISU   = MOD_VISU,
                        RESULTAT      = UTOT,
                        INFO          = 2)


IMPR_RESU(FORMAT='GMSH',UNITE=37,RESU=_F(RESULTAT=RES_XFEM,NOM_CHAM='DEPL',TYPE_CHAM='VECT_2D',NOM_CMP=('DX','DY')),);

#---------------TEST--------------------------------------------

MA[nb_raff]=DEFI_GROUP(reuse=MA[nb_raff],
                       MAILLAGE=MA[nb_raff],
                       CREA_GROUP_NO=_F(GROUP_MA='SURF'))

UN=FORMULE(NOM_PARA=('X','Y'),VALE='1.');         

GEOM=CREA_CHAMP(TYPE_CHAM='NOEU_GEOM_R',
                OPERATION='EXTR',
                MAILLAGE=MA[nb_raff],
                NOM_CHAM='GEOMETRIE',);  

CHF=CREA_CHAMP(TYPE_CHAM='NOEU_NEUT_F',
               OPERATION='AFFE',
               MAILLAGE=MA[nb_raff],
               AFFE=_F(TOUT='OUI',
                       NOM_CMP='X1',
                       VALE_F=UN));

CHUN=CREA_CHAMP(TYPE_CHAM='NOEU_NEUT_R',
                OPERATION='EVAL',
                CHAM_F=CHF,
                CHAM_PARA=GEOM);
                    
TAB=POST_RELEVE_T(TITRE='TAB',
                  ACTION=_F(INTITULE='TAB',
                            NOM_CMP='X1',
                            GROUP_NO='SURF',
                            CHAM_GD=CHUN,
                            OPERATION='EXTRACTION'),);

#IMPR_TABLE(TABLE=TAB)

# NOMBRE DE NOEUDS DU MAILLAGE FINAL
nbno = 1271

TEST_TABLE(TABLE=TAB,
           TYPE_TEST='SOMM',
           NOM_PARA='X1',
           VALE=nbno,
           CRITERE='RELATIF',
           PRECISION=1.E-12,
           REFERENCE='NON_REGRESSION')

FIN();
