# MODIF  DATE 10/10/2012   AUTEUR COURTOIS M.COURTOIS 
# TITRE  MODELISATION D UN GRADIENT D'EAU SUR UN BARREAU SATURE EN LIQUIDE
#            CONFIGURATION MANAGEMENT OF EDF VERSION
# ======================================================================
# COPYRIGHT (C) 1991 - 2012  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
# INCOMPRESSIBLE
# wtnp127b.para = tps_job 60 mem_job 512Mo ncpus 1 liste_test R
#    LINEAIRE SOUMIS A UN CHOC DE PRESSION EN 3D
#    MODELISATION VF DECENTRE MAILLE (VFDM)


DEBUT(CODE=_F(NOM='WTNP127B', NIV_PUB_WEB='INTERNET'), DEBUG=_F(SDVERI='OUI'))

#=============================================================
#=============================================================
MODELISA = 'AXIS_HH2S'

#=============================================================
#                     donnees
#=============================================================

MOLVP = 1.E-10
EMMAG=1.E-10
UN_SUR_K= 0


#*********************************************************
# CI/CL
#*********************************************************
#
PGREF = 0.1

PVP0 = 0.0001
P0=10000.
PG0 = 0.
PCINI = PG0+PGREF - P0

PRE1GAUCHE=0

#*********************************************************
# PAS DE TEMPS
#*********************************************************
#
TFINAL=50000.
NBDECOUP=5

#*********************************************************
# CRITERES DE CONVERGENCE
#*********************************************************
#

RESI_GLOB_MAXI = 1.E-17
ITER_GLOB_MAXI = 5

#*********************************************************
# Definition des caracteristiques fluides
#**********************************************************

UN=DEFI_CONSTANTE(VALE=1.0);
ZERO=DEFI_CONSTANTE(VALE=0.0);
PERMINT=DEFI_CONSTANTE(VALE=1.E-13);
HENRY=DEFI_CONSTANTE(VALE=1.E10);

#*********************
# Lecture du maillage
#*********************
MAIL=LIRE_MAILLAGE(FORMAT='MED');


MAIL=MODI_MAILLAGE(reuse=MAIL,MAILLAGE=MAIL,
                   ORIE_PEAU_2D=(
                   _F(GROUP_MA='MMIL',
                      GROUP_MA_SURF='DROITE'),
                   _F(GROUP_MA=('MDROIT','MGAUCHE')))
                    );
MAIL=DEFI_GROUP(reuse =MAIL,
                MAILLAGE=MAIL,
                CREA_GROUP_NO=(
                _F(GROUP_MA='MHAUT'),
                _F(GROUP_MA='MBAS'),
                _F(GROUP_MA='MMIL'),
                _F(GROUP_MA='MDROIT'),
                _F(GROUP_MA='MGAUCHE'),
                   ));



#*********************************************************
# Modele de calcul
#*********************************************************
#
MODELT=AFFE_MODELE(MAILLAGE=MAIL,
                   VERI_JACOBIEN='NON',
                   AFFE=_F(TOUT='OUI',
                           PHENOMENE='MECANIQUE',
                           MODELISATION=MODELISA),
                  );

#*********************************************************
# DEFI_MATERIAU
#*********************************************************
#
MATERIAU=DEFI_MATERIAU(

   THM_LIQU=_F(
         RHO = 1.,
         UN_SUR_K = UN_SUR_K,
         ALPHA = 1.E-4,
         VISC = UN,
         D_VISC_TEMP = ZERO),

   COMP_THM = 'LIQU_AD_GAZ_VAPE',

   THM_AIR_DISS=_F(
                   CP=0.,
                   COEF_HENRY=HENRY,
                   ),

   THM_VAPE_GAZ    =_F(
                   MASS_MOL   = MOLVP,
                   CP         = 1.,
                   VISC       = UN,
                   D_VISC_TEMP= ZERO,
                       ),

   THM_GAZ=_F(
          MASS_MOL    = 1.,
          VISC        = UN,
          D_VISC_TEMP = ZERO,
             ),

   THM_DIFFU=_F(
            R_GAZ      = 8.315,
            EMMAG      = EMMAG,
            RHO        = 1.,
            BIOT_COEF  = 1.,
            SATU_PRES  = UN,
            D_SATU_PRES= ZERO,
            PESA_X     = 0.0,
            PESA_Y     = 0.,
            PESA_Z     = 0.,
            PERMIN_X   = PERMINT,
            PERMIN_Y   = PERMINT,
            PERMIN_Z   = ZERO,
            PERMINXY   = ZERO,
            PERMINYZ   = ZERO,
            PERMINZX   = ZERO,
            PERM_LIQU  = UN,
            D_PERM_LIQU_SATU=ZERO,
            PERM_GAZ   = UN,
            D_PERM_SATU_GAZ=ZERO,
            D_PERM_PRES_GAZ=ZERO,
            FICKV_T    = ZERO,
            FICKA_T    = ZERO,
            LAMB_T     = ZERO
              ),

   THM_INIT=_F(
         TEMP = 293.,
         PRE1 = 0.,
         PRE2 = PGREF,
         PORO = 0.5,
         PRES_VAPE=PVP0,
              ),
   )
#****************************************************************
# Affectation des materiaux
#****************************************************************
#

CHMAT=AFFE_MATERIAU(MAILLAGE=MAIL,
                    AFFE=(_F(GROUP_MA='TOUT',
                             MATER=MATERIAU)));

#*************************************************************
# Affectation de l etat initial
#*************************************************************
#
PINIT=CREA_CHAMP(MAILLAGE=MAIL,
                    OPERATION='AFFE',
                    TYPE_CHAM='NOEU_DEPL_R',
                    AFFE=(
                    _F( GROUP_MA = 'TOUT'  ,
                    NOM_CMP  = 'PRE1' ,
                    VALE = PCINI ),
                ))
#*************************************************************
# Affectation des CL
#*************************************************************

CHIMP=AFFE_CHAR_CINE(MODELE=MODELT,
       MECA_IMPO=(_F(TOUT='OUI',PRE2=0.),
                 _F(GROUP_MA = 'MGAUCHE',PRE1=PRE1GAUCHE),
                 _F(GROUP_MA = 'MDROIT',PRE1=PCINI),
                 ));

#
#
#*************************************************************
# Liste des instants de calculs
#*************************************************************
#

INST1=DEFI_LIST_REEL(DEBUT=0.0,
                     INTERVALLE=(_F(JUSQU_A=TFINAL,
                                    NOMBRE=NBDECOUP)),
                     );

LI =DEFI_LIST_INST(DEFI_LIST=_F(LIST_INST =INST1 ),
                                ECHEC=_F(EVENEMENT     = 'ERREUR',
                                 ACTION        = 'ARRET'))
#
#
#*************************************************************
#     STAT NON LINE
#*************************************************************
#
cal1=STAT_NON_LINE(MODELE=MODELT,
                 CHAM_MATER=CHMAT,

                 EXCIT=( _F(CHARGE=CHIMP)),

                 COMP_INCR=_F(RELATION='KIT_HH',
                              RELATION_KIT=('LIQU_AD_GAZ_VAPE','HYDR_UTIL'),
                 ),

                INCREMENT=_F(
                   LIST_INST = LI,
                     INST_FIN=TFINAL,
                ),

                 ETAT_INIT  = _F ( DEPL = PINIT  ,
                                  ),

                 SOLVEUR=_F(METHODE='MUMPS'),

                 NEWTON=_F(MATRICE='TANGENTE',
                           REAC_ITER=1),

                 CONVERGENCE=_F(
                                 RESI_GLOB_MAXI = RESI_GLOB_MAXI,
                                 ITER_GLOB_MAXI = ITER_GLOB_MAXI),

                 ARCHIVAGE=_F(LIST_INST     = INST1 ),
                 );
#
#*************************************************************
# Impressions
#*************************************************************
#
L_INST=DEFI_LIST_REEL(VALE=(0.,10000.,50000.));


PR1_BAS=POST_RELEVE_T(ACTION=_F(INTITULE='DEPL',
             GROUP_NO=('MBAS'),
             RESULTAT=cal1,
             NOM_CHAM='DEPL',
             LIST_INST=L_INST,
             NOM_CMP=('PRE1'),
             OPERATION='EXTRACTION'));

TEST_RESU(RESU=_F(NUME_ORDRE=5,
                  REFERENCE='ANALYTIQUE',
                  RESULTAT=cal1,
                  NOM_CHAM='DEPL',
                  NOEUD='N5',
                  NOM_CMP='PRE1',
                  VALE_CALC=-5.00204844E+03,
                  VALE_REFE=-5000.0,
                  CRITERE='RELATIF',
                  PRECISION=1.E-2,),
          )

cal1=CALC_CHAMP(reuse=cal1,CONTRAINTE=('SIEF_ELNO'),RESULTAT=cal1)


F_EAUG=POST_RELEVE_T(ACTION=_F(INTITULE='FLUX EAU GAUCHE',
                           GROUP_NO=('MGAUCHE'),
                           RESULTAT=cal1,
                           NOM_CHAM='SIEF_ELNO',
                           INST=TFINAL,
                           NOM_CMP=('FH11X','FH11Y'),
                           OPERATION='EXTRACTION'));

F_EAUD=POST_RELEVE_T(ACTION=_F(INTITULE='FLUX EAU DROITE',
                           GROUP_NO=('MDROIT'),
                           RESULTAT=cal1,
                           NOM_CHAM='SIEF_ELNO',
                           INST=TFINAL,
                           NOM_CMP=('FH11X','FH11Y','FH22X','FH22Y'),
                           OPERATION='EXTRACTION'));

F_EAUM=POST_RELEVE_T(ACTION=_F(INTITULE='FLUX EAU MILIEU',
                           GROUP_NO=('MMIL'),
                           RESULTAT=cal1,
                           NOM_CHAM='SIEF_ELNO',
                           INST=TFINAL,
                           NOM_CMP=('FH11X','FH11Y'),
                           OPERATION='EXTRACTION'));

cal1= CALC_CHAMP( reuse    = cal1,
                   RESULTAT = cal1,
                   CONTRAINTE='SIEF_NOEU'
                  )

cal1=CALC_CHAMP(reuse=cal1,HYDRAULIQUE=('FLHN_ELGA'),RESULTAT=cal1,INST=TFINAL)


TEST_RESU(RESU=(_F(NUME_ORDRE=5,
                   POINT=1,
                   RESULTAT=cal1,
                   NOM_CHAM='FLHN_ELGA',
                   NOM_CMP='FH11',
                   VALE_CALC=2.0013600000000001E-10,
                   TOLE_MACHINE=1.E-3,
                   MAILLE='M401',),
                _F(NUME_ORDRE=5,
                   POINT=1,
                   RESULTAT=cal1,
                   NOM_CHAM='FLHN_ELGA',
                   NOM_CMP='FH22',
                   VALE_CALC=1.99935E-21,
                   TOLE_MACHINE=1.E-3,
                   MAILLE='M401',),
                ),
          )

FLUXND = POST_ELEM(RESULTAT   = cal1,
              INST=TFINAL,
              MODELE     = MODELT,
              INTEGRALE=_F(GROUP_MA=('MDROIT'),
              NOM_CHAM='FLHN_ELGA',
              NOM_CMP=('FH11','FH12','FH21','FH22')))


TEST_TABLE(VALE_CALC=-1.E-10,
           TOLE_MACHINE=1.E-3,
           NOM_PARA='INTE_FH11',
           TABLE=FLUXND,)

FLUXNM = POST_ELEM(RESULTAT   = cal1,
              INST=TFINAL,
              MODELE     = MODELT,
              INTEGRALE=_F(GROUP_MA=('MMIL'),
              NOM_CHAM='FLHN_ELGA',
              NOM_CMP=('FH11','FH12','FH21','FH22')))

TEST_TABLE(VALE_CALC=1.E-10,
           TOLE_MACHINE=1.E-3,
           NOM_PARA='INTE_FH11',
           TABLE=FLUXNM,)

FLUXNG = POST_ELEM(RESULTAT   = cal1,
              INST=TFINAL,
              MODELE     = MODELT,
              INTEGRALE=_F(GROUP_MA=('MGAUCHE'),
              NOM_CHAM='FLHN_ELGA',
              NOM_CMP=('FH11','FH12','FH21','FH22')))

TEST_TABLE(VALE_CALC=1.E-10,
           TOLE_MACHINE=1.E-3,
           NOM_PARA='INTE_FH11',
           TABLE=FLUXNG,)

# ----------  VALIDATION : POST_ELEM/INTEGRALE (CHAM_NO) ------------ #

INT_SIEF=POST_ELEM(MODELE=MODELT,
                   INST=TFINAL,
                   RESULTAT=cal1,
                   INTEGRALE=(_F(NOM_CHAM='SIEF_ELGA',
                                NOM_CMP=('M11'),
                                TOUT='OUI'),
                              _F(NOM_CHAM='SIEF_ELNO',
                                NOM_CMP=('M11'),
                                TOUT='OUI'),
                              _F(NOM_CHAM='SIEF_NOEU',
                                NOM_CMP=('M11'),
                                TOUT='OUI')))

TEST_TABLE(VALE_CALC=-2.4992799999999998E-06,
           TOLE_MACHINE=1.E-3,
           NOM_PARA='INTE_M11',
           TABLE=INT_SIEF,
           FILTRE=_F(NOM_PARA='NOM_CHAM',
                     VALE_K='SIEF_ELGA',),
           )

TEST_TABLE(VALE_CALC=-2.4992799999999998E-06,
           TOLE_MACHINE=1.E-3,
           NOM_PARA='INTE_M11',
           TABLE=INT_SIEF,
           FILTRE=_F(NOM_PARA='NOM_CHAM',
                     VALE_K='SIEF_ELNO',),
           )

TEST_TABLE(VALE_CALC=-2.4992799999999998E-06,
           TOLE_MACHINE=1.E-3,
           NOM_PARA='INTE_M11',
           TABLE=INT_SIEF,
           FILTRE=_F(NOM_PARA='NOM_CHAM',
                     VALE_K='SIEF_NOEU',),
           )

CH1=CREA_CHAMP(OPERATION = 'EXTR',TYPE_CHAM='ELGA_SIEF_R',
               NOM_CHAM  = 'SIEF_ELGA',RESULTAT= cal1, INST=TFINAL)

CH2=CREA_CHAMP(TYPE_CHAM = 'ELGA_NEUT_R', OPERATION = 'ASSE',
               MODELE = MODELT, PROL_ZERO = 'OUI',
                  ASSE = _F(TOUT='OUI',
                            CHAM_GD = CH1,
                            NOM_CMP=('M11'),
                            NOM_CMP_RESU =('X1')))

CH3=CREA_CHAMP(OPERATION = 'DISC', TYPE_CHAM = 'NOEU_NEUT_R',
                 CHAM_GD=CH2, MODELE = MODELT, PROL_ZERO = 'OUI');

CH4=CREA_CHAMP(TYPE_CHAM = 'NOEU_SIEF_R', OPERATION = 'ASSE',
               MODELE = MODELT, PROL_ZERO = 'OUI',
                  ASSE = _F(TOUT='OUI',
                            CHAM_GD = CH3,
                            NOM_CMP_RESU=('M11'),
                            NOM_CMP =('X1')))

INTM11=POST_ELEM(  CHAM_GD=CH4,
                    CHAM_MATER=CHMAT,
                    MODELE=MODELT,
                    INTEGRALE=_F( NOM_CMP='M11',TOUT='OUI'))

TEST_TABLE(REFERENCE='AUTRE_ASTER',
           PRECISION=2.E-3,
           VALE_CALC=-2.49479470E-06,
           VALE_REFE=-2.4992799999999998E-06,
           NOM_PARA='INTE_M11',
           TABLE=INTM11,)

# ----------  VALIDATION : POST_ELEM/VOLUMOGRAMME (2D) -------------- #

VM11=POST_ELEM(MODELE=MODELT,
                RESULTAT=cal1,
                NUME_ORDRE=5,
                VOLUMOGRAMME=(_F(NOM_CHAM='SIEF_ELGA',
                                 NOM_CMP ='M11',
                                 GROUP_MA='GAUCHE'),
                              _F(NOM_CHAM='SIEF_ELNO',
                                 NOM_CMP ='M11',
                                 GROUP_MA='GAUCHE'),
                              _F(NOM_CHAM='SIEF_NOEU',
                                 NOM_CMP ='M11',
                                 GROUP_MA='GAUCHE')))

TEST_TABLE(
           VALE_CALC=20.0,
           TOLE_MACHINE=1.E-3,
           NOM_PARA='DISTRIBUTION',
           TABLE=VM11,
           FILTRE=(_F(NOM_PARA='NOM_CHAM',
                      VALE_K='SIEF_ELGA',),
                   _F(NOM_PARA='INTERVALLE',
                      VALE_I=3,),
                   ),
           )

TEST_TABLE(
           VALE_CALC=20.0,
           TOLE_MACHINE=1.E-3,
           NOM_PARA='DISTRIBUTION',
           TABLE=VM11,
           FILTRE=(_F(NOM_PARA='NOM_CHAM',
                      VALE_K='SIEF_ELNO',),
                   _F(NOM_PARA='INTERVALLE',
                      VALE_I=3,),
                   ),
           )

TEST_TABLE(
           VALE_CALC=20.0,
           TOLE_MACHINE=1.E-3,
           NOM_PARA='DISTRIBUTION',
           TABLE=VM11,
           FILTRE=(_F(NOM_PARA='NOM_CHAM',
                      VALE_K='SIEF_NOEU',),
                   _F(NOM_PARA='INTERVALLE',
                      VALE_I=3,),
                   ),
           )

def masque(X1):
    val=0.
    if (-7.99904E-07<=X1<-6.99861E-07):
      val=40.# 40 = 100 / volume = 100 / 2.5
    else:
      val=0.
    return val

MASQ = FORMULE(NOM_PARA=('X1'),VALE='masque(X1)')


CHFON=CREA_CHAMP(OPERATION='AFFE',
                 TYPE_CHAM='NOEU_NEUT_F',
                 MODELE=MODELT,
                 AFFE=_F( TOUT='OUI', NOM_CMP = 'X1', VALE_F = MASQ))

CHEXT=CREA_CHAMP(OPERATION = 'EXTR', TYPE_CHAM='NOEU_SIEF_R',
                 NOM_CHAM  = 'SIEF_NOEU', RESULTAT  = cal1, NUME_ORDRE=5);

CHNEXT=CREA_CHAMP(TYPE_CHAM = 'NOEU_NEUT_R', OPERATION = 'ASSE',MODELE = MODELT, PROL_ZERO = 'OUI',
                  ASSE = _F(TOUT='OUI',
                            CHAM_GD = CHEXT,
                            NOM_CMP='M11',
                            NOM_CMP_RESU ='X1'))

CHEVA=CREA_CHAMP(OPERATION='EVAL',
                 TYPE_CHAM='NOEU_NEUT_R',
                 CHAM_F=CHFON,
                 CHAM_PARA=CHNEXT);

INTVOL=POST_ELEM( CHAM_GD=CHEVA,
                  CHAM_MATER=CHMAT,
                  MODELE=MODELT,
                  INTEGRALE=_F( NOM_CMP='X1',GROUP_MA='GAUCHE'))

TEST_TABLE(REFERENCE='AUTRE_ASTER',
           VALE_CALC=20.000000000,
           VALE_REFE=20.0,
           NOM_PARA='INTE_X1',
           TABLE=INTVOL,)

FIN();
