# TITRE MODELISATION DE LA RUPTURE D'UN BARRAGE 2D A L'AIDE DES ELEMENT DE JOINT QUADRA ET DE LA LOI JOINT_MECA_FROT
# ======================================================================
# COPYRIGHT (C) 1991 - 2013  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================

DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='OUI'),PAR_LOT='OUI',DEBUG=_F(SDVERI='OUI'))
# MIS EN EAU DU BARRAGE 2D, OU LE JOINT EST MODELISE PAR LA LOI DE FROTTEMENT
######## PARAMETRES #############
tfin=4.

# PARAMETRES MECANIQUES DU BARRAGE DE LA TERRE ET DE L'EAU (VALEURS TESTS)
young=3.E12
poiss=0.25
rho_b=2400.
rho_t=0.
rho_e=1000.
ap=9.81
h=10.
long=5.

# NIVEAU D'EAU
niv_am=DEFI_FONCTION(NOM_PARA='INST',NOM_RESU='NRT_AM',VALE=(0,0, 1,3, 2,6, 3,8, 4,9),);
niv_av=DEFI_FONCTION(NOM_PARA='INST',NOM_RESU='NRT_AV',VALE=(0,0, 1,0, 2,0, 3,0, 4,0),);

# PARAMETRES MECANIQUES DES JOINTS
k_n=1E12
k_t=2*k_n
# JOINT FROTTEMENT
mu=0.35
adhe=1000.
ecrouissage=k_t*0.1

pres_ent = FORMULE(NOM_PARA=('INST'),VALE='rho_e*ap*(niv_am(INST))');
pres_sor = FORMULE(NOM_PARA=('INST'),VALE='0.0');

# PRESSION IMPOSEE DANS LE JOINT (LINEAIRE)
f_flu = FORMULE(NOM_PARA=('X','Y','INST'),VALE='(1/long)*(pres_sor(INST) - pres_ent(INST))*X + pres_ent(INST)');


##################################
# LECTURE DU MAILLAGE, OU LE JOINT EST PRESENTE PAR DEUX LEVRES MAILLES IDENTIQUEMENT
#MA_TMP=LIRE_MAILLAGE(FORMAT='MED');

MA_TMP=LIRE_MAILLAGE(FORMAT='MED');


# IL EST IMPORTANT D'ORDONNER LES GROUPES DE NOEUDS, QUI PRESENTE LES LEVRES DU JOINT
MA_TMP=DEFI_GROUP(reuse =MA_TMP,
              MAILLAGE=MA_TMP,
              CREA_GROUP_NO=(_F(GROUP_MA='JOINT_H',
                                OPTION = 'NOEUD_ORDO',
                                NOM='JH',),
                             _F(GROUP_MA='JOINT_B',
                                OPTION = 'NOEUD_ORDO',
                                NOM='JB',),
                               ),);

# LE NOUVEAU MAILLAGE EST CREE, LA OU LE JOINT EST DEJA MAILLE
MA0 = CREA_MAILLAGE(
  MAILLAGE = MA_TMP,
  CREA_FISS = _F(
    NOM = 'JOINT',
    GROUP_NO_2 = 'JH',
    GROUP_NO_1 = 'JB',
    PREF_MAILLE = 'MJ',
    ),);

# PASSAGE DU MAILLAGE EN QUADRATIQUE
MA=CREA_MAILLAGE(MAILLAGE=MA0,
                 LINE_QUAD=_F(TOUT='OUI'),)

MA=DEFI_GROUP(reuse =MA,
              MAILLAGE=MA,
              CREA_GROUP_NO=(_F(GROUP_MA='JOINT_H',
                                OPTION = 'NOEUD_ORDO',
                                NOM='JOINT_H',),
                               ),);

MA=MODI_MAILLAGE(reuse =MA,
                   MAILLAGE=MA,
                   ORIE_PEAU_2D=_F(GROUP_MA=('BAR_AMON','BAR_AVAL')),
                   INFO=1)


MO=AFFE_MODELE(MAILLAGE=MA,
               VERIF='MAILLE',
               AFFE=(_F(GROUP_MA=('BARRAGE','TERRE','BAR_AMON','BAR_AVAL'),
                        PHENOMENE='MECANIQUE',
                        MODELISATION='D_PLAN',),
                     _F(GROUP_MA='JOINT',
                        PHENOMENE='MECANIQUE',
                        MODELISATION='PLAN_JOINT',),),);

# MATERIAU BETON ET TERRE
MAT_B=DEFI_MATERIAU(ELAS=_F(
                              E   = young,
                              NU  = poiss,
                              RHO = rho_b),)

MAT_T=DEFI_MATERIAU(ELAS=_F(
                              E   = young,
                              NU  = poiss,
                              RHO = rho_t),)


# MATERIAU JOINT MECANIQUE AVEC FROTTEMENT ET PRESSION DE FLUIDE
MAT_JF=DEFI_MATERIAU(
                  JOINT_MECA_FROT=_F(K_N=k_n,
                                     K_T=k_t,
                                     PENA_TANG=ecrouissage,
                                     MU=mu,
                                     ADHESION=adhe,
                                     PRES_FLUIDE=f_flu,
                                ),);


CM_F=AFFE_MATERIAU(MAILLAGE=MA,
                 AFFE=(
                      _F(GROUP_MA='BARRAGE',MATER = MAT_B),
                      _F(GROUP_MA='TERRE',  MATER = MAT_T),
                      _F(GROUP_MA='JOINT',  MATER = MAT_JF))
                 );

# CONDITION AUX LIMITES SUR LA TERRE
TERRE=AFFE_CHAR_MECA(MODELE=MO,FACE_IMPO=_F(GROUP_MA='TERRE_BO',DX=0.0,DY=0.0,),);

# POIDS
PESBAR = AFFE_CHAR_MECA(
  MODELE = MO,
  FORCE_INTERNE = (_F(GROUP_MA='BARRAGE',FX=0, FY=-rho_b*ap))
  );
PESTER = AFFE_CHAR_MECA(
  MODELE = MO,
  FORCE_INTERNE = (_F(GROUP_MA='TERRE',  FX=0, FY=-rho_t*ap))
  );

# PRESSION D'EAU SUR LE BARRAGE
p_am = FORMULE(VALE='max(rho_e*ap*(niv_am(INST)-Y),0)',NOM_PARA=('Y','INST',),);
p_av = FORMULE(VALE='max(rho_e*ap*(niv_av(INST)-Y),0)',NOM_PARA=('Y','INST',),);

PAMONT=AFFE_CHAR_MECA_F(MODELE=MO,PRES_REP=_F(GROUP_MA=('BAR_AMON',),PRES=p_am,),);
PAVAL =AFFE_CHAR_MECA_F(MODELE=MO,PRES_REP=_F(GROUP_MA=('BAR_AVAL', ),PRES=p_av,),);

# LISTE D'INSTANTS
LR=DEFI_LIST_REEL(DEBUT=0.0,INTERVALLE=(_F(JUSQU_A=3, NOMBRE=3,),_F(JUSQU_A=tfin, NOMBRE=2,)));
L_INST =DEFI_LIST_INST(DEFI_LIST=_F(LIST_INST = LR ),
                        ECHEC=_F(
                                 SUBD_NIVEAU=6,
                                 SUBD_PAS  = 10,
                                 SUBD_PAS_MINI = 1.E-10,
                                 ),)

# CALCUL MECANIQUE AVEC FROTTEMENT
U_F=STAT_NON_LINE(MODELE=MO,
                  CHAM_MATER=CM_F,
                  EXCIT=(
                         _F(CHARGE=TERRE),
                         _F(CHARGE=PESBAR),
                         _F(CHARGE=PESTER),
                         _F(CHARGE=PAMONT),
                         _F(CHARGE=PAVAL),),
                  COMPORTEMENT=(_F(RELATION='JOINT_MECA_FROT',
                                GROUP_MA='JOINT',),
                             _F(RELATION='ELAS',
                                GROUP_MA=('TERRE','BARRAGE')),),
                  INCREMENT=_F(LIST_INST=L_INST,INST_FIN=tfin),
                  NEWTON=_F(MATRICE='TANGENTE',REAC_ITER=1,),
                  RECH_LINEAIRE=_F(ITER_LINE_MAXI=5,),
                  CONVERGENCE=_F(ITER_GLOB_MAXI=12,
                                 RESI_GLOB_RELA=1E-5),
                  SOLVEUR=_F(METHODE='MUMPS',),
                  ARCHIVAGE = _F(LIST_INST = LR)
                  );


################### POST TRAITEMENT U_F  #######################

U_F=CALC_CHAMP(reuse =U_F,

              RESULTAT=U_F,
               VARI_INTERNE=('VARI_ELNO'),
              GROUP_MA='JOINT');

U_F=CALC_CHAMP(reuse =U_F,

              RESULTAT=U_F,
               CONTRAINTE=('SIEF_ELNO'),
              GROUP_MA='JOINT');

U_F=CALC_CHAMP(reuse =U_F,
            RESULTAT=U_F,
            VARI_INTERNE='VARI_NOEU',CONTRAINTE='SIEF_NOEU',
            GROUP_MA='JOINT');

# SAUT NORMAL DANS LE JOINT (via VI)
SAUT_F=POST_RELEVE_T(ACTION=_F(OPERATION='EXTRACTION',
                               INTITULE='SAUT_N',
                               RESULTAT=U_F,
                               NOM_CHAM='VARI_NOEU',
                               INST=tfin,
                               GROUP_NO=('JOINT_H',),
                               NOM_CMP='V7',),);

# SAUT TANGENTIEL DANS LE JOINT (via DEPL)
SAUT_X=POST_RELEVE_T(ACTION=_F(OPERATION='EXTRACTION',
                               INTITULE='DEPL_X',
                               RESULTAT=U_F,
                               NOM_CHAM='DEPL',
                               INST=tfin,
                               GROUP_NO = ('JOINT_H'),
                               NOM_CMP='DX'));

# CONTRAINTE NORMALE DANS LE JOINT
SIGN_F=POST_RELEVE_T(ACTION=_F(OPERATION='EXTRACTION',
                               INTITULE='SIG_N',
                               RESULTAT=U_F,
                               NOM_CHAM='SIEF_NOEU',
                               INST=tfin,
                               GROUP_NO = ('JOINT_H',),
                               NOM_CMP='SIGN'),);

# PRESSION DE FLUIDE
PRE_HM=POST_RELEVE_T(ACTION=_F(OPERATION='EXTRACTION',
                               INTITULE='PRES_FLU',
                               RESULTAT=U_F,
                               NOM_CHAM='VARI_NOEU',
                               INST=tfin,
                               GROUP_NO=('JOINT_H',),
                               NOM_CMP='V18',),);

################### TESTS U_F  NON REGRESSION #######################


TEST_TABLE(
           VALE_CALC=8.210082738214E-08,
           NOM_PARA='V7',
           TABLE=SAUT_F,
           FILTRE=_F(NOM_PARA='COOR_X',
                     VALE=1.3,),
           )

TEST_TABLE(
           VALE_CALC=-62477.457142857,
           NOM_PARA='SIGN',
           TABLE=SIGN_F,
           FILTRE=_F(NOM_PARA='COOR_X',
                     VALE=1.3,),
           )

TEST_TABLE(
           VALE_CALC=-1.4257297785383E-07,
           NOM_PARA='V7',
           TABLE=SAUT_F,
           FILTRE=_F(NOM_PARA='COOR_X',
                     VALE=3.2,),
           )

TEST_TABLE(
           VALE_CALC=-1.7435737785383E+05,
           NOM_PARA='SIGN',
           TABLE=SIGN_F,
           FILTRE=_F(NOM_PARA='COOR_X',
                     VALE=3.2,),
           )

TEST_TABLE(
           VALE_CALC=-2.9822080078647E-07,
           NOM_PARA='V7',
           TABLE=SAUT_F,
           FILTRE=_F(NOM_PARA='COOR_X',
                     VALE=4.6,),
           )

TEST_TABLE(
           VALE_CALC=35316.0,
           NOM_PARA='V18',
           TABLE=PRE_HM,
           FILTRE=_F(NOM_PARA='COOR_X',
                     VALE=3.,),
           )
TEST_TABLE(
           VALE_CALC=-3.0528400078647E+05,
           NOM_PARA='SIGN',
           TABLE=SIGN_F,
           FILTRE=_F(NOM_PARA='COOR_X',
                     VALE=4.6,),
           )


FIN()
