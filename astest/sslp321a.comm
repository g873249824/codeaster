# ======================================================================
# COPYRIGHT (C) 1991 - 2016  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
# person_in_charge: samuel.geniaut at edf.fr

# MODELISATION A : METHODE MAILLAGE

DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON'),DEBUG=_F(SDVERI='OUI'))

#----------------------------------------------
#                 MAILLAGE
#----------------------------------------------
MAILLAG1=LIRE_MAILLAGE(INFO=1,FORMAT='MED',);

#Nb de pas de propagation
NPAS = 13

#Pas de propagation
DA = 3.5

#RAYONS INFERIEUR ET SUPERIEUR DES COURONNES D'INTEGRATION POUR CALC_G
RI = 3.
RS = 12.

#longueur de fissure initiale
xinit = 65.
yinit = 19.

#----------------------------------------------
#                   MODELE
#----------------------------------------------

MODEL = [None]*(NPAS+1)
MODE = [None]*(NPAS+1)
MOD = [None]*(NPAS+1)
MOD[0]=AFFE_MODELE(MAILLAGE=MAILLAG1,
                      AFFE=(_F(GROUP_MA=('Surface',),
                               PHENOMENE='MECANIQUE',
                               MODELISATION='D_PLAN',),),);

#----------------------------------------------
#                   MATERIAU
#----------------------------------------------

E=31370E6
nu=0.2

ACIER=DEFI_MATERIAU(ELAS=_F(E=E,NU=nu,),);

#----------------------------------------------
#                FISSURE INITIALE
#----------------------------------------------

FISS = [None]*(NPAS+2)
MAT    = [None]*(NPAS+2)
MAX    = [None]*(NPAS+2)
MAX[0]=CO('MAX_0')
MAT[0]=CO('MAT_0')

# Initialisation
PROPA_FISS(METHODE_PROPA='INITIALISATION',
         MAIL_STRUC=MAILLAG1,
         MAIL_FISS = MAX[0],
         MAIL_TOTAL = MAT[0],
         FORM_FISS='DEMI_DROITE',
         INFO=2,
         PFON = (xinit, yinit, 0.),
         DTAN = (0., 1., 0.),
         );

#----------------------------------------------
#         PROPAGATION SUR 3 PAS DE TEMPS
#----------------------------------------------

CHXFE = [None]*(NPAS+1)
RESU = [None]*(NPAS+1)
SIF = [None]*(NPAS+1)
LSN = [None]*(NPAS+1)
LST = [None]*(NPAS+1)
CHAMA = [None]*(NPAS+1)
CHRIG = [None]*(NPAS+1)

L_INS1=DEFI_LIST_REEL(DEBUT=0.0,INTERVALLE=_F(JUSQU_A=3.0,NOMBRE=3,),);

VALE_CALC=[
0.245840984011,
0.04284493048,
0.29220793291,
0.00336399630883,
0.335140048268,
0.00217601809749,
0.378084701296,
0.00401727691493,
0.438063880891,
0.000976200967426,
0.503374858967,
0.000416953793634,
0.580988553484,
-0.00121810813963,
0.67667780514,
-0.00345350461698,
0.800021266731,
-0.00489099611317,
0.953859838393,
-0.0101788412139,
1.18292815158,
-0.0169245681736,
1.50312266143,
-0.0262222379453,
1.99675854126,
-0.0345857439164,
2.85078053834,
-0.072371886582,]

for i in range(NPAS+1) :

    MODEL[i]=AFFE_MODELE(MAILLAGE=MAT[i],
                      AFFE=(_F(GROUP_MA=('Surface',),
                               PHENOMENE='MECANIQUE',
                               MODELISATION='D_PLAN',),
                            ),);


    FISS[i]=DEFI_FISS_XFEM(DEFI_FISS=_F(GROUP_MA_FISS='FISS_'+str(i),
                                    GROUP_MA_FOND='FOND_'+str(i),),
                   MAILLAGE=MAT[i],RAYON_ENRI=12.,
             );

    MODE[i]=MODI_MODELE_XFEM(MODELE_IN=MODEL[i],FISSURE=FISS[i],INFO=1,);


    CHAMA[i]=AFFE_MATERIAU(MAILLAGE=MAT[i],
                       MODELE=MODE[i],
                       AFFE=_F(TOUT = 'OUI',
                                MATER=ACIER,
                                ),
                             );

    CHRIG[i]=AFFE_CHAR_MECA(MODELE=MODE[i],
                      DDL_IMPO=( _F(GROUP_NO=('P1',), DX=0.0, DY=0.0),_F(GROUP_NO=('P2',), DY=0.0)),
                      FORCE_NODALE=_F(GROUP_NO=('P3',),FY=-1.,),
                                    );

    RESU[i]=MECA_STATIQUE(MODELE=MODE[i],
                         CHAM_MATER=CHAMA[i],
                         EXCIT=(
                                _F(CHARGE=CHRIG[i],),),
                         INFO=1,);



    SIF[i]=CALC_G        (RESULTAT=RESU[i],
                         OPTION='CALC_K_G',
                         THETA=_F( FISSURE=FISS[i],
                                   R_INF=RI,
                                   R_SUP=RS,),);

    IMPR_TABLE(TABLE=SIF[i],
                INFO=1,);

# TEST DE KI PAR RAPPORT A KI RERERENCE (MAILLAGE)
    TEST_TABLE(CRITERE='RELATIF',
               VALE_CALC=VALE_CALC[i*2],
               NOM_PARA='K1',
               TYPE_TEST='MAX',
               TABLE=SIF[i],)

# TEST DE KII PAR RAPPORT A KII REFERENCE (MAILLAGE)
    TEST_TABLE(CRITERE='ABSOLU',
               VALE_CALC=VALE_CALC[i*2+1],
               NOM_PARA='K2',
               TYPE_TEST='MAX',
               TABLE=SIF[i],)

    if ( i != NPAS+1 ) :
        MAX[i+1]=CO('MAX_%d' %(i+1));
        MAT[i+1]=CO('MAT_%d'%(i+1));
        PROPA_FISS(METHODE_PROPA='MAILLAGE',
            MAIL_STRUC=MAILLAG1,
            MAIL_TOTAL = MAT[i+1],
            ITERATION = i+1,
            FISSURE=_F(MAIL_ACTUEL = MAX[i],
                  MAIL_PROPAGE = MAX[i+1],
                  FISS_ACTUELLE = FISS[i],
                  TABLE = SIF[i],
                  ),
            DA_MAX=DA,
            LOI_PROPA = _F(LOI='PARIS',
                           M=1,C=1,
                           MATER=ACIER,   ),
            COMP_LINE=_F(COEF_MULT_MINI=0.,
                         COEF_MULT_MAXI=1.,
                        ),
            );

#----------------------------------------------
#         EDITION DE FICHIERS MED
#----------------------------------------------
for i in range(NPAS+1) :
    MAXFE = [None]*(NPAS+1)
    MOVIS = [None]*(NPAS+1)
    DEPL = [None]*(NPAS+1)

    MAXFE[i]=POST_MAIL_XFEM(MODELE=MODE[i]);

    MOVIS[i]=AFFE_MODELE(MAILLAGE=MAXFE[i],
                         AFFE=_F(TOUT='OUI',
                                 PHENOMENE='MECANIQUE',
                                 MODELISATION='D_PLAN',),)

    DEPL[i]=POST_CHAM_XFEM(
                          MODELE_VISU   = MOVIS[i],
                          RESULTAT=RESU[i],
                          );

    DEFI_FICHIER(UNITE=30,);
    IMPR_RESU(   FORMAT='MED',
             UNITE=30,
             RESU=_F(RESULTAT=DEPL[i],),);

FIN();
