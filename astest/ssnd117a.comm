#
# ======================================================================
# COPYRIGHT (C) 1991 - 2017  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
#
# --------------------------------------------------------------------------------------------------
#
#                   DISCRET COMPORTEMENT ECROUISSAGE TRACTION
#
#   Validation du comportement
#
#   Segment : K_T_D_L     K_TR_D_L
#   Noeud   : K_T_D_N     K_TR_D_N
#
# --------------------------------------------------------------------------------------------------
import numpy as NU

DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON',),)

MAIL=LIRE_MAILLAGE(FORMAT="ASTER",)

MODE=AFFE_MODELE(
    MAILLAGE=MAIL,
    AFFE=(
        _F(GROUP_MA='FUSIB01',  PHENOMENE='MECANIQUE', MODELISATION='DIS_T',),
        _F(GROUP_MA='FUSIB02',  PHENOMENE='MECANIQUE', MODELISATION='DIS_TR',),
        _F(GROUP_MA='FUSIB03',  PHENOMENE='MECANIQUE', MODELISATION='DIS_T',),
        _F(GROUP_MA='FUSIB04',  PHENOMENE='MECANIQUE', MODELISATION='DIS_TR',),
    ),
)

#
ZERO=DEFI_CONSTANTE(VALE=0.0)
def Sinus(t,freq):
    return sin(2.0*pi*freq*t)

Freq01=1.0 ; U01=2.00
# Le déplacement imposé
Depla01 =FORMULE(VALE='U01*Sinus(INST,Freq01)',   NOM_PARA='INST')
# Liste d'instant
TempsMaxi=1.50
DeltaPas =0.05

linstS=DEFI_LIST_REEL(
    DEBUT=0.0,
    INTERVALLE=_F(JUSQU_A=TempsMaxi, PAS=DeltaPas,), )

CONDLIM =AFFE_CHAR_MECA_F(MODELE=MODE,
    DDL_IMPO=(
        _F(GROUP_NO='PT1', LIAISON='ENCASTRE',),
        _F(GROUP_NO='PT2', DX=Depla01,  DY=Depla01,  DZ=Depla01,),
        _F(GROUP_NO='PT3', LIAISON='ENCASTRE',),
        _F(GROUP_NO='PT4', DX=Depla01,  DY=Depla01,  DZ=Depla01,
                           DRX=Depla01, DRY=Depla01, DRZ=Depla01),
        _F(GROUP_NO='PT5', DX=Depla01,  DY=Depla01,  DZ=Depla01,),
        _F(GROUP_NO='PT6', DX=Depla01,  DY=Depla01,  DZ=Depla01,
                           DRX=Depla01, DRY=Depla01, DRZ=Depla01),
    ),
)

Sy   =200.0
Su   =Sy + 250.0
Kp   =4.0*Sy/U01
Puiss=1.50

def FctRp(p):
    return Sy + Kp*p/pow(1.0+pow(Kp*p/(Su-Sy),Puiss),1.0/Puiss)

Lt_p =NU.arange(0.0,U01*4.0,0.01)
Lt_rp=map( FctRp , Lt_p )
Lt_p += Sy/Kp
Lt_p=list(Lt_p)
Lt_p.insert(0, 0.0)
Lt_rp.insert(0, 0.0)


fctsy=DEFI_FONCTION(NOM_PARA='DX',
    ABSCISSE=Lt_p,
    ORDONNEE=Lt_rp,
)

# Définition des matériaux
Fusib01 =DEFI_MATERIAU( DIS_ECRO_TRAC=_F(FX= fctsy ), )
Fusib02 =DEFI_MATERIAU( DIS_ECRO_TRAC=_F(FX= fctsy ), )
Fusib03 =DEFI_MATERIAU( DIS_ECRO_TRAC=_F(FX= fctsy ), )
Fusib04 =DEFI_MATERIAU( DIS_ECRO_TRAC=_F(FX= fctsy ), )

CHMAT=AFFE_MATERIAU(
    MAILLAGE=MAIL,
    AFFE=(
      _F(GROUP_MA='FUSIB01',  MATER=Fusib01,),
      _F(GROUP_MA='FUSIB02',  MATER=Fusib02,),
      _F(GROUP_MA='FUSIB03',  MATER=Fusib03,),
      _F(GROUP_MA='FUSIB04',  MATER=Fusib04,),
   ),
)

CARELEM=AFFE_CARA_ELEM(
    MODELE=MODE,
    DISCRET=(
        _F( REPERE='LOCAL',CARA='K_T_D_L',  GROUP_MA='FUSIB01',
            VALE=(Kp, 100.0*Kp, 100.0*Kp,), ),
        _F( REPERE='LOCAL',CARA='K_TR_D_L', GROUP_MA='FUSIB02',
            VALE=(Kp, 100.0*Kp, 100.0*Kp, 100.0*Kp, 100.0*Kp, 100.0*Kp), ),
        _F( REPERE='LOCAL',CARA='K_T_D_N',  GROUP_MA='FUSIB03',
            VALE=(Kp, 100.0*Kp, 100.0*Kp,), ),
        _F( REPERE='LOCAL',CARA='K_TR_D_N', GROUP_MA='FUSIB04',
            VALE=(Kp, 100.0*Kp, 100.0*Kp, 100.0*Kp, 100.0*Kp, 100.0*Kp), ),
   ),
)

LLinst =DEFI_LIST_INST(
    DEFI_LIST=_F(LIST_INST =linstS ),
)

RESU=STAT_NON_LINE(
    MODELE    =MODE,
    CHAM_MATER=CHMAT,
    CARA_ELEM =CARELEM,
    EXCIT=_F(CHARGE=CONDLIM),
    COMPORTEMENT=(
        _F(RELATION='DIS_ECRO_TRAC', GROUP_MA='FUSIB01',),
        _F(RELATION='DIS_ECRO_TRAC', GROUP_MA='FUSIB02',),
        _F(RELATION='DIS_ECRO_TRAC', GROUP_MA='FUSIB03',),
        _F(RELATION='DIS_ECRO_TRAC', GROUP_MA='FUSIB04',),
    ),
    INCREMENT=_F(LIST_INST=LLinst,),
    CONVERGENCE=_F(ARRET='OUI',  ITER_GLOB_MAXI=30,),
    NEWTON=_F(REAC_INCR=1,REAC_ITER=1, MATRICE='TANGENTE',),
)

# IMPR_RESU(FORMAT='RESULTAT', RESU=_F(RESULTAT=RESU,),)


# --------------------------------------------------------------------------------------------------
#   Résultat sur Fusib01
TABDEPL1=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB01',NOM_CHAM='DEPL',TOUT_CMP='OUI',),)
TABSIEF1=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB01',NOM_CHAM='SIEF_ELGA',TOUT_CMP='OUI',),)
TABVARI1=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB01',NOM_CHAM='VARI_ELGA',TOUT_CMP='OUI',),)

TABDEPL1=CALC_TABLE(reuse=TABDEPL1,TABLE=TABDEPL1,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='NOEUD',CRIT_COMP='EQ',VALE_K='N2'),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','DX'),)
    ),
)
TABSIEF1=CALC_TABLE(reuse=TABSIEF1,TABLE=TABSIEF1,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='POINT',CRIT_COMP='EQ',VALE=2),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','N',),)
    ),
)
TABVARI1=CALC_TABLE(reuse=TABVARI1,TABLE=TABVARI1,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='POINT',CRIT_COMP='EQ',VALE=2),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','V1','V2','V3','V4','V5',),)
    ),
)
TABRES1= CALC_TABLE(TABLE=TABDEPL1,
    ACTION=(
        _F(OPERATION='COMB',TABLE=TABSIEF1,NOM_PARA='NUME_ORDRE'),
        _F(OPERATION='COMB',TABLE=TABVARI1,NOM_PARA='NUME_ORDRE'),
    ),
)
# --------------------------------------------------------------------------------------------------
#   Résultat sur Fusib02
TABDEPL2=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB02',NOM_CHAM='DEPL',TOUT_CMP='OUI',),)
TABSIEF2=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB02',NOM_CHAM='SIEF_ELGA',TOUT_CMP='OUI',),)
TABVARI2=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB02',NOM_CHAM='VARI_ELGA',TOUT_CMP='OUI',),)
TABDEPL2=CALC_TABLE(reuse=TABDEPL2,TABLE=TABDEPL2,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='NOEUD',CRIT_COMP='EQ',VALE_K='N4'),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','DX'),)
    ),
)
TABSIEF2=CALC_TABLE(reuse=TABSIEF2,TABLE=TABSIEF2,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='POINT',CRIT_COMP='EQ',VALE=2),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','N',),)
    ),
)
TABVARI2=CALC_TABLE(reuse=TABVARI2,TABLE=TABVARI2,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='POINT',CRIT_COMP='EQ',VALE=2),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','V1','V2','V3','V4','V5',),)
    ),
)
TABRES2= CALC_TABLE(TABLE=TABDEPL2,
    ACTION=(
        _F(OPERATION='COMB',TABLE=TABSIEF2,NOM_PARA='NUME_ORDRE'),
        _F(OPERATION='COMB',TABLE=TABVARI2,NOM_PARA='NUME_ORDRE'),
    ),
)
# --------------------------------------------------------------------------------------------------
#   Résultat sur Fusib03
TABDEPL3=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB03',NOM_CHAM='DEPL',TOUT_CMP='OUI',),)
TABSIEF3=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB03',NOM_CHAM='SIEF_ELGA',TOUT_CMP='OUI',),)
TABVARI3=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB03',NOM_CHAM='VARI_ELGA',TOUT_CMP='OUI',),)
TABDEPL3=CALC_TABLE(reuse=TABDEPL3,TABLE=TABDEPL3,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='NOEUD',CRIT_COMP='EQ',VALE_K='N5'),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','DX'),)
    ),
)
TABSIEF3=CALC_TABLE(reuse=TABSIEF3,TABLE=TABSIEF3,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='POINT',CRIT_COMP='EQ',VALE=1),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','N',),)
    ),
)
TABVARI3=CALC_TABLE(reuse=TABVARI3,TABLE=TABVARI3,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='POINT',CRIT_COMP='EQ',VALE=1),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','V1','V2','V3','V4','V5',),)
    ),
)
TABRES3= CALC_TABLE(TABLE=TABDEPL3,
    ACTION=(
        _F(OPERATION='COMB',TABLE=TABSIEF3,NOM_PARA='NUME_ORDRE'),
        _F(OPERATION='COMB',TABLE=TABVARI3,NOM_PARA='NUME_ORDRE'),
    ),
)
# --------------------------------------------------------------------------------------------------
#   Résultat sur Fusib04
TABDEPL4=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB04',NOM_CHAM='DEPL',TOUT_CMP='OUI',),)
TABSIEF4=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB04',NOM_CHAM='SIEF_ELGA',TOUT_CMP='OUI',),)
TABVARI4=CREA_TABLE(RESU=_F(RESULTAT=RESU,GROUP_MA='FUSIB04',NOM_CHAM='VARI_ELGA',TOUT_CMP='OUI',),)
TABDEPL4=CALC_TABLE(reuse=TABDEPL4,TABLE=TABDEPL4,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='NOEUD',CRIT_COMP='EQ',VALE_K='N6'),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','DX'),)
    ),
)
TABSIEF4=CALC_TABLE(reuse=TABSIEF4,TABLE=TABSIEF4,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='POINT',CRIT_COMP='EQ',VALE=1),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','N',),)
    ),
)
TABVARI4=CALC_TABLE(reuse=TABVARI4,TABLE=TABVARI4,
    ACTION=(
        _F(OPERATION='FILTRE',NOM_PARA='POINT',CRIT_COMP='EQ',VALE=1),
        _F(OPERATION='EXTR',NOM_PARA=('NUME_ORDRE','INST','V1','V2','V3','V4','V5',),)
    ),
)
TABRES4=CALC_TABLE(TABLE=TABDEPL4,
    ACTION=(
        _F(OPERATION='COMB',TABLE=TABSIEF4,NOM_PARA='NUME_ORDRE'),
        _F(OPERATION='COMB',TABLE=TABVARI4,NOM_PARA='NUME_ORDRE'),
    ),
)
#
#IMPR_TABLE(UNITE=38,TABLE=TABRES1,FORMAT_R='E17.10')
#IMPR_TABLE(UNITE=38,TABLE=TABRES2,FORMAT_R='E17.10')
#IMPR_TABLE(UNITE=38,TABLE=TABRES3,FORMAT_R='E17.10')
#IMPR_TABLE(UNITE=38,TABLE=TABRES4,FORMAT_R='E17.10')
#
# --------------------------------------------------------------------------------------------------
#NUME_ORDRE
#    INST               DX                 N                  V1                 V2                 V3                 V4                V5
ResuIntgr={
 1: (5.0000000000E-02,  6.1803398875E-01,  2.4479166822E+02,  2.4479166822E+02,  6.1803398875E-01,  1.4059717530E+00,  6.0548182050E-03,  1.1801211592E-01,),
 2: (1.0000000000E-01,  1.1755705046E+00,  3.6355711236E+02,  3.6355711236E+02,  1.1755705046E+00,  8.6861063635E+01,  2.6667772369E-01,  6.7554863175E-01,),
 3: (1.5000000000E-01,  1.6180339887E+00,  3.9808395570E+02,  3.9808395570E+02,  1.6180339887E+00,  2.2347866256E+02,  6.2282409950E-01,  1.1180121159E+00,),
 4: (2.0000000000E-01,  1.9021130326E+00,  4.1014770446E+02,  4.1014770446E+02,  1.9021130326E+00,  3.2621107025E+02,  8.7674377144E-01,  1.4020911598E+00,),
 5: (2.5000000000E-01,  2.0000000000E+00,  4.1329784619E+02,  4.1329784619E+02,  2.0000000000E+00,  3.6327427060E+02,  9.6675538452E-01,  1.4999781272E+00,),
 6: (3.0000000000E-01,  1.9021130326E+00,  3.7413850618E+02,  3.7413850618E+02,  1.9021130326E+00,  3.6327897502E+02,  9.6676676714E-01,  1.4999904439E+00,),
 7: (3.5000000000E-01,  1.6180339887E+00,  2.6050688864E+02,  2.6050688864E+02,  1.6180339887E+00,  3.6327897502E+02,  9.6676676714E-01,  1.4999904439E+00,),
 8: (4.0000000000E-01,  1.1755705046E+00,  8.3521494977E+01,  8.3521494977E+01,  1.1755705046E+00,  3.6327897502E+02,  9.6676676714E-01,  1.4999904439E+00,),
 9: (4.5000000000E-01,  6.1803398875E-01, -1.3949311136E+02, -1.3949311136E+02,  6.1803398875E-01,  3.6327897502E+02,  9.6676676714E-01,  1.4999904439E+00,),
11: (5.5000000000E-01, -6.1803398875E-01, -4.2540653024E+02, -4.2540653024E+02, -6.1803398875E-01,  5.8224091873E+02,  4.4548233684E-01,  2.0515204727E+00,),
12: (6.0000000000E-01, -1.1755705046E+00, -4.3220374283E+02, -4.3220374283E+02, -1.1755705046E+00,  8.1419461415E+02, -9.5061147516E-02,  2.6090569886E+00,),
13: (6.5000000000E-01, -1.6180339887E+00, -4.3567039442E+02, -4.3567039442E+02, -1.6180339887E+00,  1.0024804754E+03, -5.2885800270E-01,  3.0515204727E+00,),
14: (7.0000000000E-01, -1.9021130326E+00, -4.3734911380E+02, -4.3734911380E+02, -1.9021130326E+00,  1.1246601280E+03, -8.0874024810E-01,  3.3355995166E+00,),
15: (7.5000000000E-01, -2.0000000000E+00, -4.3785405065E+02, -4.3785405065E+02, -2.0000000000E+00,  1.1669435107E+03, -9.0536487338E-01,  3.4334864840E+00,),
16: (8.0000000000E-01, -1.9021130326E+00, -3.9869343533E+02, -3.9869343533E+02, -1.9021130326E+00,  1.1669498906E+03, -9.0537944427E-01,  3.4335012388E+00,),
17: (8.5000000000E-01, -1.6180339887E+00, -2.8506181779E+02, -2.8506181779E+02, -1.6180339887E+00,  1.1669498906E+03, -9.0537944427E-01,  3.4335012388E+00,),
18: (9.0000000000E-01, -1.1755705046E+00, -1.0807642413E+02, -1.0807642413E+02, -1.1755705046E+00,  1.1669498906E+03, -9.0537944427E-01,  3.4335012388E+00,),
19: (9.5000000000E-01, -6.1803398875E-01,  1.1493818221E+02,  1.1493818221E+02, -6.1803398875E-01,  1.1669498906E+03, -9.0537944427E-01,  3.4335012388E+00,),
21: (1.0500000000E+00,  6.1803398875E-01,  4.3972415007E+02,  4.3972415007E+02,  6.1803398875E-01,  1.3530611702E+03, -4.8127638642E-01,  3.8622686355E+00,),
22: (1.1000000000E+00,  1.1755705046E+00,  4.4153135170E+02,  4.4153135170E+02,  1.1755705046E+00,  1.5967630843E+03,  7.1742125335E-02,  4.4198051513E+00,),
23: (1.1500000000E+00,  1.6180339887E+00,  4.4262153228E+02,  4.4262153228E+02,  1.6180339887E+00,  1.7911700019E+03,  5.1148015805E-01,  4.8622686355E+00,),
24: (1.2000000000E+00,  1.9021130326E+00,  4.4320479940E+02,  4.4320479940E+02,  1.9021130326E+00,  1.9163484311E+03,  7.9410103410E-01,  5.1463476793E+00,),
25: (1.2500000000E+00,  2.0000000000E+00,  4.4338838658E+02,  4.4338838658E+02,  2.0000000000E+00,  1.9595380035E+03,  8.9152903356E-01,  5.2442346467E+00,),
26: (1.3000000000E+00,  1.9021130326E+00,  4.0422761498E+02,  4.0422761498E+02,  1.9021130326E+00,  1.9595446373E+03,  8.9154399513E-01,  5.2442496772E+00,),
27: (1.3500000000E+00,  1.6180339887E+00,  2.9059599745E+02,  2.9059599745E+02,  1.6180339887E+00,  1.9595446373E+03,  8.9154399513E-01,  5.2442496772E+00,),
28: (1.4000000000E+00,  1.1755705046E+00,  1.1361060378E+02,  1.1361060378E+02,  1.1755705046E+00,  1.9595446373E+03,  8.9154399513E-01,  5.2442496772E+00,),
29: (1.4500000000E+00,  6.1803398875E-01, -1.0940400255E+02, -1.0940400255E+02,  6.1803398875E-01,  1.9595446373E+03,  8.9154399513E-01,  5.2442496772E+00,),
}

Lpara=[('DX',1),('N',2),('V1',3),('V2',4),('V3',5),('V4',6),('V5',7)]
for nume_ordre in ResuIntgr.keys():
    for para,indx in Lpara:
        TEST_TABLE(TABLE=TABRES1,
            FILTRE=_F(NOM_PARA='NUME_ORDRE', CRIT_COMP='EQ', VALE_I= nume_ordre),
            NOM_PARA=para, VALE_CALC=ResuIntgr[nume_ordre][indx],
            VALE_REFE=ResuIntgr[nume_ordre][indx], REFERENCE='ANALYTIQUE', PRECISION=1.0E-06,
        )
        TEST_TABLE(TABLE=TABRES2,
            FILTRE=_F(NOM_PARA='NUME_ORDRE', CRIT_COMP='EQ', VALE_I= nume_ordre),
            NOM_PARA=para, VALE_CALC=ResuIntgr[nume_ordre][indx],
            VALE_REFE=ResuIntgr[nume_ordre][indx], REFERENCE='ANALYTIQUE', PRECISION=1.0E-06,
        )
        TEST_TABLE(TABLE=TABRES3,
            FILTRE=_F(NOM_PARA='NUME_ORDRE', CRIT_COMP='EQ', VALE_I= nume_ordre),
            NOM_PARA=para, VALE_CALC=ResuIntgr[nume_ordre][indx],
            VALE_REFE=ResuIntgr[nume_ordre][indx], REFERENCE='ANALYTIQUE', PRECISION=1.0E-06,
        )
        TEST_TABLE(TABLE=TABRES4,
            FILTRE=_F(NOM_PARA='NUME_ORDRE', CRIT_COMP='EQ', VALE_I= nume_ordre),
            NOM_PARA=para, VALE_CALC=ResuIntgr[nume_ordre][indx],
            VALE_REFE=ResuIntgr[nume_ordre][indx], REFERENCE='ANALYTIQUE', PRECISION=1.0E-06,
        )

FIN()
