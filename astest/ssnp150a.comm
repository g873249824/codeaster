# ======================================================================
# COPYRIGHT (C) 1991 - 2016  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
import math

try:
  # Import du module de calcul symbolique Sympy
  import sympy
  sympy_available = True
except ImportError:
  sympy_available = False

DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',),
      DEBUG=_F(SDVERI='OUI'),
      IGNORE_ALARM='MODELE1_63')

#================================================================================================
# Definition des caracteristiques du materiau
#================================================================================================
E=1;
NU=0.3;

#================================================================================================
# Calcul de la solution de reference
#================================================================================================

INCLUDE(UNITE=38)

#================================================================================================
# Debut du modele
#================================================================================================


Mail=LIRE_MAILLAGE(FORMAT='MED',);

Mail=MODI_MAILLAGE(reuse=Mail,
                    MAILLAGE=Mail,
                    ORIE_PEAU_2D=(_F(GROUP_MA='MAITRE'),
                                  _F(GROUP_MA='BAS'),
                                  )
                            );


# Definition du materiau isotrope
Acier=DEFI_MATERIAU(ELAS=_F(E=E, NU=NU,),);

# Definition du transitoire
LINST=DEFI_LIST_REEL(DEBUT=0.0,
                     INTERVALLE=(
                                 _F(JUSQU_A=1., NOMBRE=10,),
                     ),);

RAMPE=DEFI_FONCTION(NOM_PARA='INST',
                    VALE=(0.0, 0.0,
                          1.,  1.0,),
                    PROL_DROITE='LINEAIRE',
                    PROL_GAUCHE='LINEAIRE',);


# Affectation du modele
Modele=AFFE_MODELE(MAILLAGE=Mail,
                 AFFE=_F(TOUT='OUI',
                         PHENOMENE='MECANIQUE',
                         MODELISATION='D_PLAN',),
                 );
# Affectation du materiau
Chmat=AFFE_MATERIAU(MAILLAGE=Mail,
                    AFFE=_F(TOUT='OUI',
                            MATER=Acier,),
                   );


# Affectation des conditions limites
Dirich=AFFE_CHAR_MECA_F(MODELE=Modele,
                        DDL_IMPO=_F(GROUP_MA='HAUT', DX=FUx, DY=FUy, ),
                        );

Neumann=AFFE_CHAR_MECA_F(MODELE=Modele,
                        FORCE_CONTOUR=(
                                       _F(GROUP_MA='DROITE', FX=FsurfXD, FY=FsurfYD,),
                                       _F(GROUP_MA='GAUCHE', FX=FsurfXG, FY=FsurfYG,),
                                       _F(GROUP_MA='BAS',    FX=FsurfTX, FY=FsurfTY,),
                                      ),
                          );

ForceInt=AFFE_CHAR_MECA_F(MODELE=Modele,
                          FORCE_INTERNE=_F(GROUP_MA='SURFACE', FX=FvolX, FY=FvolY,),
                         );

# Affectation des conditions limites
Contact=DEFI_CONTACT(MODELE=Modele,
                     FORMULATION='DISCRETE',
                     ZONE=_F(GROUP_MA_MAIT='MAITRE',
                             GROUP_MA_ESCL='BAS',),
                       );

BlocBase=AFFE_CHAR_CINE(MODELE=Modele,
                        MECA_IMPO=_F(GROUP_MA='MAITRE',
                                     DX=0,DY=0),
                       );
# Phase de resolution proprement dit
Evol=STAT_NON_LINE(MODELE=Modele,
                   CHAM_MATER=Chmat,
                   COMPORTEMENT=_F(RELATION='ELAS',
                                DEFORMATION='GROT_GDEP',
                                TOUT='OUI',),
                   INCREMENT=_F(LIST_INST=LINST,),
                   NEWTON=_F(REAC_ITER=1,),
                   CONVERGENCE=_F(ITER_GLOB_MAXI=100),
                   CONTACT=Contact,
                   EXCIT=(
                          _F(CHARGE=Neumann,FONC_MULT=RAMPE),
                          _F(CHARGE=Dirich,FONC_MULT=RAMPE),
                          _F(CHARGE=ForceInt,FONC_MULT=RAMPE),
                          _F(CHARGE=BlocBase,),
                          ),
                   INFO=1,
                   );

# ========================================================================================
#          Creation de la solution analytique
# ========================================================================================

CHXN=CREA_CHAMP(OPERATION='EXTR', TYPE_CHAM='NOEU_GEOM_R',
                NOM_CHAM='GEOMETRIE', MAILLAGE=Mail, INFO=1);

TEMP1=CREA_CHAMP(OPERATION='AFFE',
                 TYPE_CHAM='NOEU_NEUT_F',
                 MAILLAGE=Mail,
                 AFFE=(_F( GROUP_MA='SURFACE', NOM_CMP = 'X1', VALE_F = FUx),
                       _F( GROUP_MA='SURFACE', NOM_CMP = 'X2', VALE_F = FUy),
                      )
                );

TEMP2=CREA_CHAMP(OPERATION='EVAL',
                 TYPE_CHAM='NOEU_NEUT_R',
                 CHAM_F=TEMP1,
                 CHAM_PARA=CHXN);

Uana=CREA_CHAMP(OPERATION='ASSE',
                TYPE_CHAM='NOEU_DEPL_R',
                MAILLAGE=Mail,
                ASSE=(_F(GROUP_MA='SURFACE',
                         CHAM_GD = TEMP2,
                         NOM_CMP = 'X1',
                         NOM_CMP_RESU = 'DX',),
                      _F(GROUP_MA='SURFACE',
                         CHAM_GD = TEMP2,
                         NOM_CMP = 'X2',
                         NOM_CMP_RESU = 'DY',)
                      )
                );

# ========================================================================================
#          Calcul de l'erreur DIFF = Uana - Ucalc
# ========================================================================================

Ucalc=CREA_CHAMP(OPERATION='EXTR', INST=1.0,
                 NOM_CHAM = 'DEPL' , TYPE_CHAM = 'NOEU_DEPL_R',
                 RESULTAT = Evol ,);


DIFF=CREA_CHAMP(OPERATION='ASSE', TYPE_CHAM='NOEU_DEPL_R',MODELE=Modele,

                ASSE=(_F(GROUP_MA='SURFACE', CHAM_GD=Ucalc,CUMUL='OUI', COEF_R=+1., NOM_CMP='DX', NOM_CMP_RESU='DX',),
                      _F(GROUP_MA='SURFACE', CHAM_GD=Uana, CUMUL='OUI', COEF_R=-1., NOM_CMP='DX', NOM_CMP_RESU='DX',),
                      _F(GROUP_MA='SURFACE', CHAM_GD=Ucalc,CUMUL='OUI', COEF_R=+1., NOM_CMP='DY', NOM_CMP_RESU='DY',),
                      _F(GROUP_MA='SURFACE', CHAM_GD=Uana, CUMUL='OUI', COEF_R=-1., NOM_CMP='DY', NOM_CMP_RESU='DY',),
                      ),
                );


# ========================================================================================
#          Verifications
# ========================================================================================

TEST_RESU(CHAM_NO=_F(
                     TYPE_TEST='SOMM_ABS',
                     CHAM_GD=DIFF,
                     VALE_CALC=4.03888411513E-05,),
          )

IMPR_RESU(FORMAT='MED',
          UNITE=80,
          RESU=(_F(CHAM_GD=DIFF,),
                _F(CHAM_GD=Uana,),
                _F(CHAM_GD=Ucalc,),
               ),
          );


FIN();
