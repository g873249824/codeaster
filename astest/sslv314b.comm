# ======================================================================
# COPYRIGHT (C) 1991 - 2016  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY  
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY  
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR     
# (AT YOUR OPTION) ANY LATER VERSION.                                                    
#                                                                       
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT   
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF            
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU      
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.                              
#                                                                       
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE     
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,         
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.        
# ======================================================================
# METHODE PAR PROJECTION SUR UN MAILLAGE - FISSURE DROITE EN MODE 1 PUR

DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON'),DEBUG=_F(SDVERI='OUI'),)


#----------------------------------------------
#                 MAILLAGE
#----------------------------------------------

nbcalc= 3

MODELE = [None]*nbcalc
MODELX = [None]*nbcalc
CHXFEM = [None]*nbcalc
CHMAT = [None]*nbcalc
CHAR = [None]*nbcalc
RESU = [None]*nbcalc
SIF = [None]*nbcalc
LSN = [None]*nbcalc
LST = [None]*nbcalc
MA =  [None]*(nbcalc+1)
MAX =  [None]*(nbcalc+1)
FF = [None]*(nbcalc+1)

MAILLAG1=LIRE_MAILLAGE(FORMAT='MED',INFO=1,);


MAILLAG1=DEFI_GROUP(reuse =MAILLAG1,
                    MAILLAGE=MAILLAG1,
                    CREA_GROUP_NO=_F(GROUP_MA=('VOL','SURFINF','LIG1','LIG5'),),);


MAILLAG1=MODI_MAILLAGE(reuse =MAILLAG1,
                       MAILLAGE=MAILLAG1,
                       ORIE_PEAU_3D=_F(GROUP_MA=('SURFSUP','SURFINF',),),
                       );

#----------------------------------------------
#                   MATERIAU
#----------------------------------------------

E=205000.0E6
nu=0.3
rho=7800.
ACIER=DEFI_MATERIAU(ELAS=_F(E=E,NU=nu,RHO=rho,),);

#----------------------------------------------
#                   FISSURE INITIALE
#----------------------------------------------
MAX[0]=CO('MAX_0')
MA[0]=CO('MA_0')

PROPA_FISS(METHODE_PROPA='INITIALISATION',
         MAIL_STRUC=MAILLAG1,
         MAIL_FISS = MAX[0],
         MAIL_TOTAL = MA[0],
         FORM_FISS='DEMI_PLAN',
         INFO=2,
         POINT_ORIG = (0., 2., 9.),
         POINT_EXTR =  (1., 2., 9.),
         DTAN = (0., 1., 0.),
         NB_POINT_FOND = 5,
         );

#----------------------------------------------
#         PROPAGATION SUR 3 PAS DE TEMPS
#----------------------------------------------

L_INS1=DEFI_LIST_REEL(DEBUT=0.0,INTERVALLE=_F(JUSQU_A=3.0,NOMBRE=3,),);
RI = 0.2
RS = 0.8
PRES=-1.E6

for i in range(nbcalc) :

   MODELE[i]=AFFE_MODELE(MAILLAGE=MA[i],
                      AFFE=(_F(GROUP_MA=('VOL',),
                               PHENOMENE='MECANIQUE',
                               MODELISATION='3D',),
                            _F(GROUP_MA=('SURFINF','SURFSUP',),
                               PHENOMENE='MECANIQUE',
                               MODELISATION='3D',),),);
                               
   FF[i]=DEFI_FISS_XFEM(DEFI_FISS=_F(GROUP_MA_FISS='FISS_'+str(i),
                                 GROUP_MA_FOND='FOND_'+str(i)),
                      MAILLAGE=MA[i],
                      );

   MODELX[i]=MODI_MODELE_XFEM(MODELE_IN=MODELE[i],FISSURE=FF[i],INFO=1,);

   
   CHMAT[i]=AFFE_MATERIAU(MAILLAGE=MA[i],
                          MODELE=MODELX[i],
                          AFFE=_F(TOUT='OUI',MATER=ACIER,));

   CHAR[i]=AFFE_CHAR_MECA(MODELE=MODELX[i],
                   PRES_REP=_F(GROUP_MA=('SURFSUP',),PRES=PRES,),
                   DDL_IMPO=(_F(GROUP_NO='SURFINF',DZ=0.0,),
                             _F(GROUP_NO=('LIG1','LIG5'),DX=0.0,),
                             _F(GROUP_NO='P4',DY=0.0,),),);

   RESU[i]=MECA_STATIQUE(MODELE=MODELX[i],
                         CHAM_MATER=CHMAT[i],
                         EXCIT=(
                                _F(CHARGE=CHAR[i],),),
                         INFO=1,);
                         

   SIF[i]=CALC_G(RESULTAT=RESU[i],
                 OPTION='CALC_K_G',
                 THETA=_F(FISSURE=FF[i],
                          R_INF=RI,
                          R_SUP=RS,),
                 LISSAGE=_F(DEGRE=2))

   IMPR_TABLE(TABLE=SIF[i])

   if ( i != nbcalc) :
      MAX[i+1]=CO('MAX_%d' %(i+1) )
      MA[i+1] = CO('MA_%d'%(i+1))
      PROPA_FISS(METHODE_PROPA='MAILLAGE',
            MAIL_STRUC=MAILLAG1,
            MAIL_TOTAL = MA[i+1],
            ITERATION = i+1,
            FISSURE=_F(MAIL_ACTUEL = MAX[i],
                  MAIL_PROPAGE = MAX[i+1],
                  FISS_ACTUELLE = FF[i],
                  TABLE = SIF[i],
                  ),
            DA_MAX=0.3,
            LOI_PROPA = _F(LOI='PARIS',
                           M=1,C=1,
                           MATER=ACIER,   ),
            COMP_LINE=_F(COEF_MULT_MINI=0.,
                         COEF_MULT_MAXI=1.,
                        ),
            );

#----------------------------------------------
#   TEST DE NON-REGRESSION SUR LA POSITION FINALE DE LA FISSURE
#----------------------------------------------


# ON DEFINIT ICI LES NOEUDS VOISINANT LE FOND DE FISSURE
# A DES FINS DE COMPARAISON AVEC LES MODELISATIONS A ET D

MA[i+1]   =DEFI_GROUP( reuse =MA[i+1],
                     MAILLAGE=MA[i+1],
                     CREA_GROUP_NO=(_F(NOM='VOIS_CYL',
                                       OPTION='ENV_CYLINDRE',
                                       POINT=(1.,2.59968,9.),
                                       RAYON=1./3.,
                                       VECT_NORMALE=(1.,0.,0.),
                                       PRECISION=0.06,),
                                    _F(NOM='VOIS_PLA',
                                       OPTION='PLAN',
                                       POINT=(1.,2.59968,9.),
                                       VECT_NORMALE=(1.,0.,0.),
                                       PRECISION=0.01,),),  
                      INFO=1, );

MA[i+1]   =DEFI_GROUP( reuse =MA[i+1],
                     MAILLAGE=MA[i+1],
                     CREA_GROUP_NO=_F(NOM='VOISINS',
                                      INTERSEC=('VOL','VOIS_CYL','VOIS_PLA',),),
                      INFO=2,);


CHLN=CREA_CHAMP(TYPE_CHAM='NOEU_NEUT_R',
                OPERATION='EXTR',
                NOM_CHAM='LNNO',
                FISSURE=FF[i],);


MA[i]=DEFI_GROUP(reuse =MA[i],
                    MAILLAGE=MA[i],
                    CREA_GROUP_NO=_F(GROUP_MA='FOND_'+str(i),),)
                    
TAB= POST_RELEVE_T(ACTION=_F(INTITULE='test',
                                            GROUP_NO='FOND_'+str(i),
                                           CHAM_GD=CHLN,
                                            TOUT_CMP='OUI',
                                            OPERATION='EXTRACTION',),);               

TEST_TABLE(
           VALE_CALC=2.59815103079,
           NOM_PARA='COOR_Y',
           TYPE_TEST='MAX',
           TABLE=TAB,
           )

TEST_TABLE(
           VALE_CALC=2.5776160603,
           NOM_PARA='COOR_Y',
           TYPE_TEST='MIN',
           TABLE=TAB,
           )

FIN();
