# MODIF  DATE 02/04/2013   AUTEUR PROIX J-M.PROIX 
# RESPONSABLE PROIX J-M.PROIX
# TITRE CYLINDRE THERMOELASTICITE LINEAIRE - TEST UMAT AXIS GDEF_LOG
# umat001b.para = tps_job 120 mem_job 512Mo ncpus 1 liste_test S
#            CONFIGURATION MANAGEMENT OF EDF VERSION
# ======================================================================
# COPYRIGHT (C) 1991 - 2013  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================

import os
from asrun.toolbox import make_shared

# Juste pour les besoins du cas-test.
# Il est preferable d'utiliser :
#       as_run --make_shared -o libumat.so src.f
# avant de lancer l'etude.

# Special sur la Bull
from asrun.config import ASTER_CONFIG
conf = ASTER_CONFIG('config.txt')
if conf['ID_PERF'][0] == 'Bull':
    os.rename("fort.44", "libumat.so")
    os.chmod("libumat.so", 0755)
else:
    os.rename("fort.22", "fort.22.f")
    # On force la ligne de commande pour ne pas etre gene par les licences des compilateurs
    make_shared("libumat.so", "fort.22.f")


DEBUT(CODE=_F(NOM='UMAT001B',NIV_PUB_WEB='INTERNET'),DEBUG=_F(SDVERI='OUI'))


L_INST =DEFI_LIST_REEL(  DEBUT=0.0,
                        INTERVALLE=(
                        _F( PAS = 0.002,       JUSQU_A = 0.02),
                        _F( PAS = 0.004,       JUSQU_A = 0.06),
                        _F( PAS = 0.01,        JUSQU_A = 0.24),
)
                      )
MA = LIRE_MAILLAGE(FORMAT='MED');

MA = DEFI_GROUP(reuse =MA,
                MAILLAGE=MA,
                CREA_GROUP_NO =(
                       _F(GROUP_MA = 'DAB',),
                       _F(GROUP_MA = 'DCD',),
                       _F(GROUP_MA = 'DBC',),
                       _F(GROUP_MA = 'DDA',),
                        )
                )



FONC1= FORMULE(NOM_PARA=('X','INST'),VALE='(X**2)*INST ')

TP1=CREA_CHAMP(OPERATION='AFFE', TYPE_CHAM='NOEU_TEMP_F',
MAILLAGE=MA,
                            AFFE=_F(  TOUT ='OUI',
                                NOM_CMP = 'TEMP',
                               VALE_F = FONC1)   )


TEMPE=CREA_RESU(    OPERATION='AFFE', TYPE_RESU='EVOL_THER',    NOM_CHAM='TEMP',AFFE=(
                      _F(  CHAM_GD = TP1,   LIST_INST =L_INST),)  )
#CALCUL MECANIQUE

MO = AFFE_MODELE( MAILLAGE =MA,
                  AFFE=_F(
                       TOUT ='OUI',
                       PHENOMENE = 'MECANIQUE',
                       MODELISATION = 'AXIS',)
                 )

MAT = DEFI_MATERIAU(
            ELAS=_F( E = 1., NU = 0.3, ALPHA = 0.7E-1),
            LEMAITRE=_F( N = 1.,UN_SUR_K = 1.,UN_SUR_M = 0.),
            ECRO_LINE=_F(SY=1.E10, D_SIGM_EPSI=0.),
           )

CHMAT = AFFE_MATERIAU (MAILLAGE = MA,
                       AFFE =_F(TOUT='OUI',
                                MATER = MAT,),
                       AFFE_VARC=_F( TOUT='OUI',
                                  EVOL=TEMPE,
                                  NOM_VARC='TEMP',
                                  NOM_CHAM='TEMP',VALE_REF=0.),)

BLOC = AFFE_CHAR_MECA (MODELE = MO,
                       DDL_IMPO=_F(GROUP_NO =('DAB','DCD'),
                                   DY=0.)
                      )

RESU = STAT_NON_LINE (MODELE = MO,
                      CHAM_MATER = CHMAT,
                      EXCIT = _F( CHARGE = BLOC),
                      COMP_INCR =_F(RELATION ='VMIS_ISOT_LINE',DEFORMATION='SIMO_MIEHE'),
                      INCREMENT =_F(LIST_INST =L_INST),
                      NEWTON    =_F(REAC_ITER= 1),
                        )

IMPR_RESU(RESU=_F(RESULTAT=RESU,VALE_MAX='OUI',VALE_MIN='OUI',NUME_ORDRE=38))

RESU=CALC_CHAMP(reuse=RESU,RESULTAT=RESU,CONTRAINTE=('SIGM_ELNO'),DEFORMATION=('EPSG_ELGA'))

RESU = CALC_CHAMP ( reuse= RESU,
                  RESULTAT = RESU,
                  CONTRAINTE='SIGM_NOEU',
                  )

TEST_RESU(
          RESU= _F(RESULTAT = RESU,
                   INST=0.24,
                   NOM_CHAM ='DEPL',
                   GROUP_NO ='B',
                   NOM_CMP ='DX',
                   VALE_CALC=0.10295396313384,
                   VALE_REFE=0.102954,
                   TOLE_MACHINE=(1.E-6,1.E-6),
                   PRECISION=1.E-4,
                   REFERENCE='NON_DEFINI')
         )

TEST_RESU(
          RESU= _F(RESULTAT = RESU,
                   INST=0.24,
                   NOM_CHAM ='SIGM_NOEU',
                   GROUP_NO ='B',
                   NOM_CMP ='SIZZ',
                   VALE_CALC=-0.028952070277992,
                   VALE_REFE=-0.028952,
                   TOLE_MACHINE=(1.E-6,1.E-6),
                   PRECISION=1.E-4,
                   REFERENCE='NON_DEFINI')
         )


# UMAT - GDEF_LOG

E=1.
NU=0.3

LAMBDA=DEFI_CONSTANTE( VALE= E*NU/(1+NU)/(1-2.*NU) )
MU=DEFI_CONSTANTE( VALE= E/2/(1.0+NU) )
ZE=DEFI_CONSTANTE( VALE=0. )



UMAT = DEFI_MATERIAU(
            ELAS=_F( E = 1., NU = 0.3, ALPHA = 0.7E-1),
            UMAT_FO=_F( C1 = LAMBDA ,C2= MU , C3=ZE, C4= ZE, C5=ZE, )
           )

CHUMAT = AFFE_MATERIAU (MAILLAGE = MA,
                       AFFE =_F(TOUT='OUI',
                                MATER = UMAT,),
                       AFFE_VARC=_F( TOUT='OUI',
                                  EVOL=TEMPE,
                                  NOM_VARC='TEMP',
                                  NOM_CHAM='TEMP',VALE_REF=0.),)

RESUMAT = STAT_NON_LINE (MODELE = MO, INFO=1,
                      CHAM_MATER = CHUMAT,
                      EXCIT =(_F( CHARGE = BLOC),),
                      COMP_INCR =_F(RELATION ='UMAT',DEFORMATION='GDEF_LOG',
                                    NB_VARI=1,
                                    LIBRAIRIE='libumat.so',
                                    NOM_ROUTINE='umat'),
                      INCREMENT =_F(LIST_INST =L_INST),
                      NEWTON    =_F(
                                PREDICTION ='ELASTIQUE',
                                REAC_ITER= 1
                                ),
                        )

RESUMAT=CALC_CHAMP(reuse=RESUMAT,RESULTAT=RESUMAT,CONTRAINTE=('SIGM_ELNO'),DEFORMATION=('EPSG_ELGA'))

RESUMAT = CALC_CHAMP ( reuse= RESUMAT,
                  RESULTAT = RESUMAT,
                  CONTRAINTE='SIGM_NOEU',
                  )

IMPR_RESU(RESU=_F(RESULTAT=RESUMAT,VALE_MAX='OUI',VALE_MIN='OUI',NUME_ORDRE=38))

TEST_RESU(
          RESU= _F(RESULTAT = RESUMAT,
                   INST=0.24,
                   NOM_CHAM ='DEPL',
                   GROUP_NO ='B',
                   NOM_CMP ='DX',
                   VALE_CALC=0.11245447527981,
                   VALE_REFE= 0.102954 ,
                   TOLE_MACHINE=(1E-6,1.E-6),
                   PRECISION=0.1,
                   REFERENCE='AUTRE_ASTER')
         )

TEST_RESU(
          RESU= _F(RESULTAT = RESUMAT,
                   INST=0.24,
                   NOM_CHAM ='SIGM_NOEU',
                   GROUP_NO ='B',
                   NOM_CMP ='SIZZ',
                   VALE_CALC=-0.031225207274718,
                   VALE_REFE= -0.028952,
                   TOLE_MACHINE=(1E-6,1.E-6),
                   PRECISION=0.1,
                   REFERENCE='AUTRE_ASTER')
         )

TEST_RESU(
          RESU= _F(RESULTAT = RESUMAT,
                   INST=0.24,
                   NOM_CHAM ='DEPL',
                   GROUP_NO ='B',
                   NOM_CMP ='DX',
                   VALE_CALC=0.11245447527981,
                   VALE_REFE= 0.112454 ,
                   TOLE_MACHINE=(1E-6,1.E-6),
                   PRECISION=1.E-4,
                   REFERENCE='NON_DEFINI')
         )

TEST_RESU(
          RESU= _F(RESULTAT = RESUMAT,
                   INST=0.24,
                   NOM_CHAM ='SIGM_NOEU',
                   GROUP_NO ='B',
                   NOM_CMP ='SIZZ',
                   VALE_CALC=-0.031225207274718,
                   VALE_REFE= -0.031225,
                   TOLE_MACHINE=(1E-6,1.E-6),
                   PRECISION=1.E-4,
                   REFERENCE='NON_DEFINI')
         )


FIN()
