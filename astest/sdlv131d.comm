# TITRE  : POUTRE EN TRACTION (ELEMENTS VOLUMIQUES)
#            CONFIGURATION MANAGEMENT OF EDF VERSION
# ======================================================================
# COPYRIGHT (C) 1991 - 2013  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
# ======================================================================
#---------------------------------------------------------------------
#  - CALCUL DE MOYENNE DE LA DEFORMATION
#    JAUGE VIRTUELLE
#  - RESULTATS ISSUS DE MODE_ITER_SIMULT

#---------------------------------------------------------------------
#
import numpy as NP

DEBUT( CODE=_F( NOM = 'SDLV131D',NIV_PUB_WEB='INTERNET'),
       DEBUG=_F(SDVERI='OUI'),
       IMPR_MACRO='NON',
       PAR_LOT='OUI',
       ERREUR=_F(ERREUR_F='EXCEPTION',),
     )

force = 1.E3
young = 2.1E11
poisson = 0.3
rho = 7800.
longueur = 1.
section = 0.3*0.2

POUTRE=LIRE_MAILLAGE(FORMAT='MED',VERI_MAIL=_F(VERIF='OUI'), );

MODEL=AFFE_MODELE(MAILLAGE=POUTRE,
                  AFFE=_F( GROUP_MA = 'TOUT_ELT',
                           PHENOMENE = 'MECANIQUE',
                           MODELISATION = '3D',),);

POUTRE=DEFI_GROUP(reuse =POUTRE,
                MAILLAGE=POUTRE,
                CREA_GROUP_NO=(
                             _F(GROUP_MA='AY',NOM='AY',),
                             _F(GROUP_MA='AZ',NOM='AZ',),
                             _F(GROUP_MA='SURF2',NOM='SURF2',),
                              ),);
#
#---------------------------------------------------------------------
#                     CARACTERISTIQUES MATERIAUX
#---------------------------------------------------------------------
#
ACIER=DEFI_MATERIAU(ELAS=_F( E = young,
                             NU = poisson,
                             RHO = rho),);

MAT=AFFE_MATERIAU( MAILLAGE=POUTRE,
                   AFFE=_F( GROUP_MA = 'TOUT_ELT', MATER = ACIER)
                 );

#
#---------------------------------------------------------------------
#                     CHARGEMENTS
#---------------------------------------------------------------------
#
CHAR0=AFFE_CHAR_MECA( MODELE=MODEL,
                      DDL_IMPO=(  # traction - compression
                               _F( GROUP_NO = 'AY',DY=0.,),
                               _F( GROUP_NO = 'AZ',DZ=0.,),
                        ),
                      FACE_IMPO=( # encastrement
                               _F( GROUP_MA = 'SURF1',DX=0.,),
                        ),
                      LIAISON_UNIF=( # pour la force de traction
                               _F( GROUP_NO = 'SURF2',DDL=('DX',)),
                        ),
                      );
#
#---------------------------------------------------------------------
#                     RESOLUTION
#---------------------------------------------------------------------
#
M_EL_RIG=CALC_MATR_ELEM( MODELE=MODEL,
                         CHAM_MATER=MAT,
                         CHARGE=CHAR0,
                         OPTION='RIGI_MECA'
                           );

M_EL_MAS=CALC_MATR_ELEM( MODELE=MODEL,
                         CHAM_MATER=MAT,
                         CHARGE=CHAR0,
                         OPTION='MASS_MECA'
                           );

NU=NUME_DDL( MATR_RIGI=M_EL_RIG)
M_AS_RIG=ASSE_MATRICE( MATR_ELEM=M_EL_RIG,   NUME_DDL=NU)
M_AS_MAS=ASSE_MATRICE( MATR_ELEM=M_EL_MAS,   NUME_DDL=NU)

rota = 90.
rota_rad = rota*NP.pi/180.
cosinus = NP.cos(rota_rad)
sinus = NP.sin(rota_rad)

CHF=AFFE_CHAR_MECA(MODELE=MODEL,
                   FORCE_FACE=(_F(GROUP_MA='SURF2',FX=force),
                                  ),)

modes = 1
if modes:
  MODES=MODE_ITER_SIMULT( MATR_RIGI=M_AS_RIG,
                          MATR_MASS=M_AS_MAS,
                          METHODE='SORENSEN',
                          CALC_FREQ=_F(OPTION = 'BANDE',
                                       FREQ = (1000., 1500.,))
                          );


  MODES=CALC_CHAMP(reuse=MODES,RESULTAT=MODES,DEFORMATION=('EPSI_ELGA','EPSI_ELNO'))


  MODES=CALC_CHAMP( reuse=MODES, RESULTAT=MODES,
                 DEFORMATION='EPSI_NOEU'
                     )

projection = 0
if projection:
# MESURE
    MAILMESU=LIRE_MAILLAGE(UNITE=22)

    MODLMESU=AFFE_MODELE( MAILLAGE=MAILMESU,
                          AFFE=(
                              _F( MAILLE = ('P3','P4','P5','P6','L1','L2','L3',),
                                  PHENOMENE = 'MECANIQUE',
                                  MODELISATION = 'DIS_T'),
                                ),)

    OBSJAU = OBSERVATION(
                   RESULTAT = MODES,
                   MODELE_1 = MODEL,
                   MODELE_2 = MODLMESU,
                   PROJECTION = 'OUI',
                   TOUT_ORDRE = 'OUI',
                   NOM_CHAM = 'EPSI_NOEU',
                   EPSI_MOYENNE = (  # pour JAUGE : une occ par jauge
                              _F( GROUP_MA='SURF3',SEUIL_VARI=(0.1,),MASQUE=('EPYY','EPXY','EPXZ','EPYZ'),),
                              _F( GROUP_MA='SURF4',MASQUE=('EPZZ','EPXY','EPXZ','EPYZ'),),
                              ),
                   MODI_REPERE = _F(
                                    TYPE_CHAM = 'TENS_3D',
                                    GROUP_MA=('P4',),  # sur le modele mesure (rotation 90 degre)
                                    REPERE = 'DIR_JAUGE',  VECT_X = (cosinus,sinus,0.),  VECT_Y = (-sinus,cosinus,0.),
                              ),
                   FILTRE =(
                              _F( GROUP_NO = 'P3',
                                NOM_CHAM = 'EPSI_NOEU',
                                DDL_ACTIF = ('EPXX','EPZZ',),),
                              _F( GROUP_NO = 'P4',
                                NOM_CHAM = 'EPSI_NOEU',
                                DDL_ACTIF = ('EPXX','EPYY',),),
                              ),
                  );

    OBSMXT = OBSERVATION(
                   RESULTAT = MODES,
                   MODELE_1 = MODEL,
                   MODELE_2 = MODLMESU,
                   PROJECTION = 'OUI',
                   TOUT_ORDRE = 'OUI',
                   NOM_CHAM = ('EPSI_NOEU','DEPL'),
                   FILTRE =(
                              _F( GROUP_NO = 'P3',
                                NOM_CHAM = 'EPSI_NOEU',
                                DDL_ACTIF = ('EPXX','EPZZ',),),
                              _F( GROUP_NO = 'P3',
                                NOM_CHAM = 'DEPL',
                                DDL_ACTIF = ('DX','DY',),),
                              ),
                  );

else:
    OBSJAU = OBSERVATION(
                   RESULTAT = MODES,
                   MODELE_1 = MODEL,
                   MODELE_2 = MODEL,
                   PROJECTION = 'NON',
                   TOUT_ORDRE = 'OUI',
                   NOM_CHAM = 'EPSI_NOEU',
                   MATR_RIGI=M_AS_RIG,
                   MATR_MASS=M_AS_MAS,
                   EPSI_MOYENNE = (  # pour JAUGE : une occ par jauge
                              _F(
                                 GROUP_MA=('SURF3',),
                                 SEUIL_VARI=(0.1,),
                                 MASQUE=('EPYY','EPXY','EPXZ','EPYZ'),
                                 ),
                              _F( GROUP_MA='SURF4',MASQUE=('EPZZ','EPXY','EPXZ','EPYZ'),),
                              ),
                   MODI_REPERE = (
                               _F( TYPE_CHAM = 'TENS_3D',
                                    GROUP_MA=('SURF4','SURF6',), # (rotation 90 degre)
                                    REPERE = 'DIR_JAUGE',  VECT_X = (cosinus,sinus,0.),  VECT_Y = (-sinus,cosinus,0.),),
                              ),
                   FILTRE = (
                              _F( GROUP_NO = 'P3',
                                  NOM_CHAM = 'EPSI_NOEU',
                                  DDL_ACTIF = ('EPXX','EPZZ',),),
                              _F( GROUP_NO = 'P4',
                                  NOM_CHAM = 'EPSI_NOEU',
                                  DDL_ACTIF = ('EPXX','EPYY',),),
                             ),
                  );

    OBSMXT = OBSERVATION(
                   RESULTAT = MODES,
                   MODELE_1 = MODEL,
                   MODELE_2 = MODEL,
                   PROJECTION = 'NON',
                   TOUT_ORDRE = 'OUI',
                   MATR_RIGI=M_AS_RIG,
                   MATR_MASS=M_AS_MAS,
                   NOM_CHAM = ('DEPL','EPSI_NOEU'),
                   FILTRE = (
                              _F( GROUP_NO = 'P3',
                                  NOM_CHAM = 'EPSI_NOEU',
                                  DDL_ACTIF = ('EPXX','EPZZ',),),
                              _F( GROUP_NO = 'P3',
                                  NOM_CHAM = 'DEPL',
                                  DDL_ACTIF = ('DX','DY',),),),
                  );

#---------------------------------------------------------------------
#                     VERIFICATION DES RESULTATS
#---------------------------------------------------------------------
#


modes = 1
if modes:
  TEST_RESU(RESU=(_F(GROUP_NO='P3',
                     NUME_MODE=1,
                     RESULTAT=OBSJAU,
                     NOM_CHAM='EPSI_NOEU',
                     NOM_CMP='EPXX',
                     VALE_CALC=1.012,
                     TOLE_MACHINE=1.E-3,
                     CRITERE='RELATIF',
                     ),
                  _F(GROUP_NO='P3',
                     NUME_MODE=1,
                     RESULTAT=OBSJAU,
                     NOM_CHAM='EPSI_NOEU',
                     NOM_CMP='EPZZ',
                     VALE_CALC=-0.30630000000000002,
                     TOLE_MACHINE=1.E-3,
                     CRITERE='RELATIF',
                     ),
# rotation 90 degres : EPXX <-> EPYY
                  _F(GROUP_NO='P4',
                     NUME_MODE=1,
                     RESULTAT=OBSJAU,
                     NOM_CHAM='EPSI_NOEU',
                     NOM_CMP='EPYY',
                     VALE_CALC=1.0169999999999999,
                     TOLE_MACHINE=1.E-3,
                     CRITERE='RELATIF',
                     ),
                  _F(GROUP_NO='P4',
                     NUME_MODE=1,
                     RESULTAT=OBSJAU,
                     NOM_CHAM='EPSI_NOEU',
                     NOM_CMP='EPXX',
                     VALE_CALC=-0.31180000000000002,
                     TOLE_MACHINE=1.E-3,
                     CRITERE='RELATIF',
                     ),
# observation mixte
                  _F(GROUP_NO='P3',
                     NUME_MODE=1,
                     RESULTAT=OBSMXT,
                     NOM_CHAM='EPSI_NOEU',
                     NOM_CMP='EPXX',
                     VALE_CALC=1.014,
                     TOLE_MACHINE=1.E-3,
                     CRITERE='RELATIF',
                     ),
                  _F(GROUP_NO='P3',
                     NUME_MODE=1,
                     RESULTAT=OBSMXT,
                     NOM_CHAM='DEPL',
                     NOM_CMP='DX',
                     VALE_CALC=0.75700000000000001,
                     TOLE_MACHINE=1.E-3,
                     CRITERE='RELATIF',
                     ),
                  ),
            )

FIN();
