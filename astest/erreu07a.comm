# TITRE  VALIDATION DE STAT_NON_LINE / ETAT_INIT (ERREURS ET ALARMES)
# ======================================================================
# COPYRIGHT (C) 1991 - 2015  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
# ======================================================================
# DANS CE TEST, ON VALIDE LES 2 MESSAGES D'ERREURS EMIS LORSQUE L'ON TENTE
# DE CHANGER DE COMPORTEMENT SUR CERTAINES MAILLES ET QUE LE CODE NE LE PERMET PAS.
# IL Y A 2 MESSAGES DIFFERENTS SELON QEU L'ON UTILISE :
#   * ETAT_INIT / EVOL_NOLI + INST
#   * ETAT_INIT / DEPL + SIGM + VARI
#-----------------------------------------------------------------------------
DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET', VISU_EFICAS='NON'),DEBUG=_F(SDVERI='OUI'),
      ERREUR=_F(ERREUR_F='EXCEPTION',),
      PAR_LOT='NON',)

import re
fmt_raison='-'*80+"""

   Exception interceptee
   Raison : %s

"""+'-'*80+'\n'

MAIL=LIRE_MAILLAGE()
DEFI_GROUP(reuse =MAIL, MAILLAGE=MAIL,
              CREA_GROUP_MA=(
                    _F(NOM='GXXXXXX_GM2', MAILLE=('M2',)),
                    _F(NOM='GXXXXXX_GM89', MAILLE=('M8','M9',)),
                    _F(NOM='GXXXXXX_GMS2',  DIFFE=('GXXXXXX_CARRE','GXXXXXX_GM2',)),
                    _F(NOM='GXXXXXX_GMS89', DIFFE=('GXXXXXX_CARRE','GXXXXXX_GM89',)),
             ))

SIGMF=DEFI_FONCTION( NOM_PARA='EPSI', VALE=(0.1,   200.,
                                            1.0,   500. ))
MATER=DEFI_MATERIAU(
          ELAS=     _F(E= 2000., NU = 0.3),
          PRAGER=   _F(C= 0.1),
          TRACTION= _F(SIGM= SIGMF),
          ECRO_LINE=_F(D_SIGM_EPSI=100., SY=100.,),
          )
CHMAT=AFFE_MATERIAU( MAILLAGE=MAIL, AFFE=_F( TOUT = 'OUI',MATER = MATER))

L_INST=DEFI_LIST_REEL( DEBUT=0.,INTERVALLE= _F( JUSQU_A = 100.,   NOMBRE = 5))


# 1. CALCUL SUR LE MODELE MOMEC1 (TOUTES LES MAILLES SAUF M8 ET M9) :
#--------------------------------------------------------------------

MOMEC1=AFFE_MODELE(  MAILLAGE=MAIL,
          AFFE=_F( GROUP_MA = 'GXXXXXX_GMS89',
                   MODELISATION = 'D_PLAN',     PHENOMENE = 'MECANIQUE'))


CHMEC1=AFFE_CHAR_MECA( MODELE=MOMEC1,DDL_IMPO=(
           _F( GROUP_MA = 'GXXXXXX_BORD1',  DX = 0.,  DY=0. ),
           _F( GROUP_MA = 'GXXXXXX_BORD2',  DX = 0.3, DY=0.6 )),)


U1=STAT_NON_LINE(MODELE=MOMEC1,  CHAM_MATER=CHMAT,
                 EXCIT=_F( CHARGE = CHMEC1),
                 COMPORTEMENT=(
                       _F( RELATION = 'VMIS_CINE_LINE', MAILLE=('M1','M2','M3')),
                       _F( RELATION = 'VMIS_ISOT_TRAC', MAILLE=('M4','M5')),
                       _F( RELATION = 'VMIS_ISOT_LINE', MAILLE=('M6')),
                       _F( RELATION = 'ELAS',           MAILLE=('M7')),
                       ),
                 INCREMENT=_F( LIST_INST = L_INST),
                 CONVERGENCE=_F( ITER_GLOB_MAXI=50),
                 NEWTON=_F(REAC_ITER=2,),
                 )


# 2. CALCUL SUR LE MODELE MOMEC2 (TOUTES LES MAILLES SAUF M2) :
#--------------------------------------------------------------------

MOMEC2=AFFE_MODELE(  MAILLAGE=MAIL,
          AFFE=_F( GROUP_MA = 'GXXXXXX_GMS2',
                   MODELISATION = 'D_PLAN',     PHENOMENE = 'MECANIQUE'))


CHMEC2=AFFE_CHAR_MECA( MODELE=MOMEC2,DDL_IMPO=(
           _F( GROUP_MA = 'GXXXXXX_BORD1',  DX = 0.,  DY=0. ),
           _F( GROUP_MA = 'GXXXXXX_BORD2',  DX = 0.3, DY=0.6 )),)

#  CHANGEMENTS DE COMPORTEMENT:
#       M1 :   'VMIS_CINE_LINE'   ->   'VMIS_ISOT_TRAC'
#       M2 :   'VMIS_CINE_LINE'   ->   'RIEN'
#       M3 :   'VMIS_CINE_LINE'   ->   'VMIS_CINE_LINE'
#       M4 :   'VMIS_ISOT_TRAC'   ->   'VMIS_ISOT_LINE'
#       M5 :   'VMIS_ISOT_TRAC'   ->   'ELAS'
#       M6 :   'VMIS_ISOT_LINE'   ->   'VMIS_ISOT_TRAC'
#       M7 :   'ELAS'             ->   'VMIS_ISOT_LINE'
#       M8 :   'RIEN'             ->   'VMIS_ISOT_LINE'
#       M9 :   'RIEN'             ->   'VMIS_ISOT_LINE'

# 2.1 ETAT_INIT / EVOL_NOLI + INST :
#--------------------------------------------------------------------
is_ok = 0
try :
   U2_1=STAT_NON_LINE(MODELE=MOMEC2,  CHAM_MATER=CHMAT,
                 ETAT_INIT=_F( EVOL_NOLI = U1, INST=60.),
                 EXCIT=_F( CHARGE = CHMEC2),
                 COMPORTEMENT=(
                       _F( RELATION = 'VMIS_CINE_LINE', MAILLE=('M3','M7','M8','M9')),
                       _F( RELATION = 'VMIS_ISOT_TRAC', MAILLE=('M1','M6')),
                       _F( RELATION = 'VMIS_ISOT_LINE', MAILLE=('M4')),
                       _F( RELATION = 'ELAS',           MAILLE=('M5')),
                       ),
                 INCREMENT=_F( LIST_INST = L_INST,INST_INIT=60. ),
                 CONVERGENCE=_F( ITER_GLOB_MAXI=50),
                 NEWTON=_F(REAC_ITER=2,),
               )
except aster.error,err:
   print fmt_raison % str(err)
   # on verifie que l'erreur fatale est bien celle que l'on attendait :
   if err.id_message == "MECANONLINE5_2" :
      is_ok = 1

# TEST_RESU
TAB1=CREA_TABLE(LISTE=(_F(PARA='TEST',TYPE_K='K8',LISTE_K='VALEUR  ',),
                       _F(PARA='BOOLEEN',LISTE_I=is_ok,),),)

TEST_TABLE(REFERENCE='ANALYTIQUE',
           VALE_CALC_I=1,
           VALE_REFE_I=1,
           NOM_PARA='BOOLEEN',
           TABLE=TAB1,
           FILTRE=_F(NOM_PARA='TEST',
                     VALE_K='VALEUR  ',),
           )

DETRUIRE(CONCEPT=_F(NOM=(TAB1),),)

# 2.2 ETAT_INIT / EVOL_NOLI + DEPL, SIGM, VARI :
#--------------------------------------------------------------------

D1=CREA_CHAMP(TYPE_CHAM='NOEU_DEPL_R', OPERATION='EXTR', RESULTAT=U1, NOM_CHAM='DEPL',      INST=60.)
S1=CREA_CHAMP(TYPE_CHAM='ELGA_SIEF_R', OPERATION='EXTR', RESULTAT=U1, NOM_CHAM='SIEF_ELGA', INST=60.)
V1=CREA_CHAMP(TYPE_CHAM='ELGA_VARI_R', OPERATION='EXTR', RESULTAT=U1, NOM_CHAM='VARI_ELGA', INST=60.)

is_ok = 0
try :
   U2_2=STAT_NON_LINE(MODELE=MOMEC2,  CHAM_MATER=CHMAT,
                 ETAT_INIT=_F( DEPL=D1, SIGM=S1, VARI=V1),
                 EXCIT=_F( CHARGE = CHMEC2),
                 COMPORTEMENT=(
                       _F( RELATION = 'VMIS_CINE_LINE', MAILLE=('M3','M7','M8','M9')),
                       _F( RELATION = 'VMIS_ISOT_TRAC', MAILLE=('M1','M6')),
                       _F( RELATION = 'VMIS_ISOT_LINE', MAILLE=('M4')),
                       _F( RELATION = 'ELAS',           MAILLE=('M5')),
                       ),
                 INCREMENT=_F( LIST_INST = L_INST,INST_INIT=60. ),
                 CONVERGENCE=_F( ITER_GLOB_MAXI=50),
                 NEWTON=_F(REAC_ITER=2,),
               )
except aster.error,err:
   print fmt_raison % str(err)
   # on verifie que l'erreur fatale est bien celle que l'on attendait :
   if err.id_message == "MECANONLINE5_2":
      is_ok = 1

# TEST_RESU
TAB1=CREA_TABLE(LISTE=(_F(PARA='TEST',TYPE_K='K8',LISTE_K='VALEUR  ',),
                       _F(PARA='BOOLEEN',LISTE_I=is_ok,),),)

TEST_TABLE(REFERENCE='ANALYTIQUE',
           VALE_CALC_I=1,
           VALE_REFE_I=1,
           NOM_PARA='BOOLEEN',
           TABLE=TAB1,
           FILTRE=_F(NOM_PARA='TEST',
                     VALE_K='VALEUR  ',),
           )

DETRUIRE(CONCEPT=_F(NOM=(TAB1),),)

FIN()
