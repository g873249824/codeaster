# TITRE INTERACTION STRUCTURE SOL STRUCTURE PARAMETRIQUE
# ======================================================================
# COPYRIGHT (C) 1991 - 2012  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================

# Pour des raisons de performances, on force SDVERI='NON'. 
DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON'),DEBUG=_F(SDVERI='NON'));

MAIL1=LIRE_MAILLAGE(UNITE=23,FORMAT='MED',);

MAIL2=LIRE_MAILLAGE(FORMAT='MED',);

MAILLAGE=ASSE_MAILLAGE(MAILLAGE_1=MAIL1,
                       MAILLAGE_2=MAIL2,
                       OPERATION ='SOUS_STR',);

MAILLAGE=DEFI_GROUP(reuse =MAILLAGE,
                    MAILLAGE=MAILLAGE,
                    CREA_GROUP_NO=_F(GROUP_MA=('SBAS','SBAS1','SBAS2',
                                               'SBASM','SBAST',)),
                    );
MAILLAGE=DEFI_GROUP(reuse =MAILLAGE,
                    MAILLAGE=MAILLAGE,
                    CREA_GROUP_NO=_F(DIFFE=('SBASM','SBAS1'),
                                     NOM='SBASI',),);
MAILLAGE=DEFI_GROUP(reuse =MAILLAGE,
                    MAILLAGE=MAILLAGE,
                    CREA_GROUP_NO=_F(DIFFE=('SBASI','SBAS2'),
                                     NOM='SBASF',),);
MODELE=AFFE_MODELE(MAILLAGE=MAILLAGE,
                   AFFE=(_F(GROUP_MA='POU_D_T',
                            PHENOMENE='MECANIQUE',
                            MODELISATION='POU_D_T',),
                         _F(GROUP_MA='MASSES',
                            PHENOMENE='MECANIQUE',
                            MODELISATION='DIS_TR',),
                         _F(GROUP_MA='SBAST',
                            PHENOMENE='MECANIQUE',
                            MODELISATION='DST',),),);
# FIN DE DEFINITION DU MODELE.
#
# ----------------------------------------------------------------------
#  DEFINITION DES MATERIAUX
#  DEFINITION DES MATERIAUX "UTILISATEURS"

MAT_1=DEFI_MATERIAU(ELAS=_F(E=31000000000.0,
                            NU=0.16,
                            RHO=0.0,
                            ALPHA=0.0,),);

MAT_2=DEFI_MATERIAU(ELAS=_F(
                            E=31000000000.0e3,
                            NU=0.16,
                            RHO=0.001,
                            ALPHA=0.0,),);
#

CHAMPMAT=AFFE_MATERIAU(MAILLAGE=MAILLAGE,
                       AFFE=(_F(GROUP_MA='MAT_1',
                                MATER=MAT_1,),
                             _F(GROUP_MA='SBAS',
                                MATER=MAT_1,),
                             _F(GROUP_MA='SBASM',
                                MATER=MAT_2,),
                            ),
                        );
#
# ----------------------------------------------------------------------
#       CONDITIONS LIMITES

CON_LIM=AFFE_CHAR_MECA(MODELE=MODELE,
                       DDL_IMPO=(
                                 _F(GROUP_NO='ENCASTRE',
                                   DX=0.0,
                                   DY=0.0,
                                   DZ=0.0,
                                   DRX=0.0,
                                   DRY=0.0,
                                   DRZ=0.0,),
                                 _F(GROUP_NO='SBASF',
                                   DX=0.0,
                                   DY=0.0,
                                   DZ=0.0,
                                    ),
                                 ),
                       LIAISON_SOLIDE=(_F(GROUP_NO=('PA0','SBAS1',),),
                                       _F(GROUP_NO=('PB0','SBAS2',),),
                                      ),
                      );
# FIN CONDITIONS LIMITES
#
#
# AFFECTATION DES CARACTERISTIQUES ELEMENTAIRES

CARA_ELE=AFFE_CARA_ELEM(MODELE=MODELE,
                        POUTRE=(_F(GROUP_MA='SEC_1',
                                   SECTION='GENERALE',
                                   CARA=('A','IZ','IY','AY','AZ','JX','EZ','EY','RY','RZ','RT',),
                                   VALE=(59.5,341.33,341.33,1./0.93,1./0.93,682.7,0.0,0.0,1.0,1.0,1.0,),),
                                _F(GROUP_MA='SEC_2',
                                   SECTION='GENERALE',
                                   CARA=('A','IZ','IY','AY','AZ','JX','EZ','EY','RY','RZ','RT',),
                                   VALE=(8.28,39.51,54.77,2.94,1.47,94.3,0.0,0.0,1.0,1.0,1.0,),),
                                _F(GROUP_MA='SEC_3',
                                   SECTION='GENERALE',
                                   CARA=('A','IZ','IY','AY','AZ','JX','EZ','EY','RY','RZ','RT',),
                                   VALE=(63.19,341.33,341.33,1./0.99,1./0.99,682.7,0.0,0.0,1.0,1.0,1.0,),),
                                _F(GROUP_MA='SEC_4',
                                   SECTION='GENERALE',
                                   CARA=('A','IZ','IY','AY','AZ','JX','EZ','EY','RY','RZ','RT',),
                                   VALE=(19.78,148.34,149.14,2.13,2.11,297.5,0.0,0.0,1.0,1.0,1.0,),),
                                _F(GROUP_MA='SEC_5',
                                   SECTION='GENERALE',
                                   CARA=('A','IZ','IY','AY','AZ','JX','EZ','EY','RY','RZ','RT',),
                                   VALE=(64.0,341.33,341.33,1.0,1.0,682.7,0.0,0.0,1.0,1.0,1.0,),),
                                ),
                        COQUE=(_F(GROUP_MA='SBAS',
                                 EPAIS=0.001,),
                               _F(GROUP_MA='SBASM',
                                 EPAIS=1.6,),
                              ),
                        DISCRET=(_F(MAILLE=('MASA1','MBSA1',),
                                    CARA='M_TR_D_N',
                                    VALE=(79250.0,410720.0,482340.0,893060.0,0.0,0.0,0.0,0.0,0.0,0.0,),),
                                 _F(MAILLE=('MASA1','MBSA1',),
                                    CARA='K_TR_D_N',
                                    VALE=(0.0,0.0,0.0,0.0,0.0,0.0,),),
                                 _F(MAILLE=('MASA2','MBSA2',),
                                    CARA='M_TR_D_N',
                                    VALE=(104090.0,574750.0,694040.0,1268790.0,0.0,0.0,0.0,0.0,0.0,0.0,),),
                                 _F(MAILLE=('MASA2','MBSA2',),
                                    CARA='K_TR_D_N',
                                    VALE=(0.0,0.0,0.0,0.0,0.0,0.0,),),
                                 _F(MAILLE=('MASA3','MBSA3',),
                                    CARA='M_TR_D_N',
                                    VALE=(156710.0,1020850.0,1071220.0,2092070.0,0.0,0.0,0.0,0.0,0.0,0.0,),),
                                 _F(MAILLE=('MASA3','MBSA3',),
                                    CARA='K_TR_D_N',
                                    VALE=(0.0,0.0,0.0,0.0,0.0,0.0,),),
                                 _F(MAILLE=('MASA4','MBSA4',),
                                    CARA='M_TR_D_N',
                                    VALE=(316970.0,1846700.0,1844020.0,3690720.0,0.0,0.0,0.0,0.0,0.0,0.0,),),
                                 _F(MAILLE=('MASA4','MBSA4',),
                                    CARA='K_TR_D_N',
                                    VALE=(0.0,0.0,0.0,0.0,0.0,0.0,),),
                                 ),);
# FIN DE AFFE_CARA_ELEM  ------------
#
# MASSES ET INERTIES DE LA STRUCTURE

MASSE_TO=POST_ELEM(MODELE=MODELE,
                   CHAM_MATER=CHAMPMAT,
                   CARA_ELEM=CARA_ELE,
                   MASS_INER=(_F(TOUT='OUI',),
                              _F(GROUP_MA=('MASSES','POU_D_T','SBAST',),),
                                ),
                  );
#

IMPR_TABLE(TABLE=MASSE_TO,);
#
# MATRICE DE RIGIDITE ELEMENTAIRE

RIGI_ELE=CALC_MATR_ELEM(OPTION='RIGI_MECA',
                        MODELE=MODELE,
                        CHAM_MATER=CHAMPMAT,
                        CARA_ELEM=CARA_ELE,
                        CHARGE=CON_LIM,);
#
# NUMEROTATION DES DDL

NUMEDDL=NUME_DDL(MATR_RIGI=RIGI_ELE,);
#
# MATRICE DE RIGIDITE GLOBALE

RIGIDITE=ASSE_MATRICE(MATR_ELEM=RIGI_ELE,
                      NUME_DDL=NUMEDDL,);
#
# MATRICE DE MASSE ELEMENTAIRE

MASS_ELE=CALC_MATR_ELEM(OPTION='MASS_MECA',
                        MODELE=MODELE,
                        CHAM_MATER=CHAMPMAT,
                        CARA_ELEM=CARA_ELE,
                        CHARGE=CON_LIM,);
#
# MATRICE DE MASSE GLOBALE

MASSE=ASSE_MATRICE(MATR_ELEM=MASS_ELE,
                   NUME_DDL=NUMEDDL,);
#
# MODE MECANIQUE

MODE=MACRO_MODE_MECA(MATR_RIGI=RIGIDITE,
                     MATR_MASS=MASSE,
                     CALC_FREQ=_F(FREQ=(1.0,600.0,),),
                     IMPRESSION=_F(),);


INTERDYN=DEFI_INTERF_DYNA(NUME_DDL=NUMEDDL,
                          INTERFACE=_F(NOM='DROITE',
                                       TYPE='CRAIGB',
                                       GROUP_NO=('ENCASTRE','SBASF'),
                                       ),
                         );

BAMO=DEFI_BASE_MODALE(CLASSIQUE=_F(INTERF_DYNA=INTERDYN,
                                   MODE_MECA=MODE,
                                   NMAX_MODE=999,),);

MAEL=MACR_ELEM_DYNA(BASE_MODALE=BAMO,);

FO1=DEFI_FONCTION(NOM_PARA='FREQ',
                  VALE=(0.0,1.0,100.0,1.0,),);

CHA1=AFFE_CHAR_MECA(MODELE=MODELE,
                    FORCE_NODALE=_F(NOEUD='NA1',
                                    FX=10000.0,),);

VEC1_ELE=CALC_VECT_ELEM(OPTION='CHAR_MECA',
                        CHARGE=CHA1,
                        CHAM_MATER=CHAMPMAT,
                        CARA_ELEM=CARA_ELE,);

VECAS1=ASSE_VECTEUR(VECT_ELEM=VEC1_ELE,
                    NUME_DDL=NUMEDDL,);
#

CHA2=AFFE_CHAR_MECA(MODELE=MODELE,
                    FORCE_NODALE=_F(NOEUD='NA1',
                                    FY=10000.0,),);

VEC2_ELE=CALC_VECT_ELEM(OPTION='CHAR_MECA',
                        CHARGE=CHA2,
                        CHAM_MATER=CHAMPMAT,
                        CARA_ELEM=CARA_ELE,);

VECAS2=ASSE_VECTEUR(VECT_ELEM=VEC2_ELE,
                    NUME_DDL=NUMEDDL,);
#

IMPR_MACR_ELEM(MACR_ELEM_DYNA=MAEL,
               FORMAT='MISS_3D',
               SOUS_TITRE='NUPEC RIGIDE',
               AMOR_REDUIT=0.01,
               GROUP_MA_INTERF='SBAST',
               IMPR_MODE_MECA='NON',
               IMPR_MODE_STAT='OUI',);

IMPR_MISS_3D(MACR_ELEM_DYNA=MAEL,
             EXCIT=_F(VECT_ASSE=VECAS1,
                      FONC_MULT=FO1,),
             FREQ_INIT=0.1,
             FREQ_FIN=20.0,
             PAS=0.1,
             TITRE='NUPEC DX',);

IMPR_MISS_3D(MACR_ELEM_DYNA=MAEL,
             EXCIT=_F(VECT_ASSE=VECAS2,
                      FONC_MULT=FO1,),
             FREQ_INIT=0.1,
             FREQ_FIN=20.0,
             PAS=0.1,
             TITRE='NUPEC DY',);


# TRAITEMENT DE MISS3D PAR EXEC_LOGICIEL
#---------------------------------------

MACRO_MISS_3D(
  OPTION =_F (TOUT= 'OUI'),
  PROJET    = 'SDLX102A',
  REPERTOIRE= './SDLX102A',
  UNITE_IMPR_ASTER= 26,
  UNITE_OPTI_MISS = 31,
  UNITE_MODELE_SOL= 22,
  VERSION='V1_4',
              PARAMETRE=_F(
               FREQ_MIN=0.1,
               FREQ_MAX=20.,
               FREQ_PAS=0.1,
               Z0= 0.,
               TYPE='BINAIRE',
               DREF=4.,
               SURF='OUI',
               # RFIC = 1.,
               ALGO = 'DEPL',
               OFFSET_MAX=30,
               OFFSET_NB=300,
               FICH_RESU_IMPE='../fort.38',
               FICH_RESU_FORC='../fort.28',
              ),
             ) ;

DYHA1=LIRE_MISS_3D(MACR_ELEM_DYNA=MAEL,
                   UNITE=27,
                   NOM='SDLX102A.01.h',
                   TYPE_RESU='HARMO',
                   TITRE='HARMO NUPEC DX',);

DYHA2=LIRE_MISS_3D(MACR_ELEM_DYNA=MAEL,
                   UNITE=29,
                   NOM='SDLX102A.02.h',
                   TYPE_RESU='HARMO',
                   TITRE='HARMO NUPEC DY',);


nddlgen = NUME_DDL_GENE( BASE= BAMO,
                          STOCKAGE= 'PLEIN',);

rigigen=PROJ_MATR_BASE(  BASE=BAMO,  NUME_DDL_GENE=nddlgen,
                            MATR_ASSE=RIGIDITE );

massgen=PROJ_MATR_BASE(  BASE=BAMO,  NUME_DDL_GENE=nddlgen,
                            MATR_ASSE=MASSE );

vecgen1=PROJ_VECT_BASE(  BASE=BAMO,  NUME_DDL_GENE=nddlgen,
                            VECT_ASSE=VECAS1 );

vecgen2=PROJ_VECT_BASE(  BASE=BAMO,  NUME_DDL_GENE=nddlgen,
                            VECT_ASSE=VECAS2 );

DEFI_FICHIER(ACTION='LIBERER', UNITE=38, );
DEFI_FICHIER(ACTION='LIBERER', UNITE=28, );

NF = 201
impe=[None]*NF
rito=[None]*NF

for k in range(1,NF):

  impe[k] = LIRE_IMPE_MISS(BASE=BAMO,  NUME_DDL_GENE=nddlgen,
                       UNITE_RESU_IMPE=38, FREQ_EXTR=0.+0.1*k,
                       TYPE='BINAIRE',
                          );

  rito[k]=COMB_MATR_ASSE(COMB_C=(
                                _F(MATR_ASSE=impe[k],
                                 COEF_C=1.0+0.j,),
                                _F(MATR_ASSE=rigigen,
                                 COEF_C=1.0+0.j,),
                                 ),
                                 SANS_CMP='LAGR',
                                 );

  if k==1:
    dyge1 = DYNA_VIBRA(TYPE_CALCUL='HARM',BASE_CALCUL='GENE',
                          MATR_MASS = massgen,
                          MATR_RIGI = rito[k],
                          SOLVEUR=_F( METHODE='LDLT', ),
                          FREQ = 0.+0.1*k,
                          AMOR_MODAL=_F(AMOR_REDUIT= (0.01,0.01,0.01,
                                        0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.0,),),
                          EXCIT =_F ( VECT_ASSE_GENE = vecgen1,
                                      COEF_MULT= 1.,
                                  ),
                        );

    dyge2 = DYNA_VIBRA(TYPE_CALCUL='HARM',BASE_CALCUL='GENE',
                          MATR_MASS = massgen,
                          MATR_RIGI = rito[k],
                          SOLVEUR=_F( METHODE='LDLT', ),
                          FREQ = 0.+0.1*k,
                          AMOR_MODAL=_F(AMOR_REDUIT= (0.01,0.01,0.01,
                                        0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.0,),),
                          EXCIT =_F ( VECT_ASSE_GENE = vecgen2,
                                      COEF_MULT= 1.,
                                  ),
                        );

  else:
    dyge1 = DYNA_VIBRA(TYPE_CALCUL='HARM',BASE_CALCUL='GENE',
                          reuse=dyge1, RESULTAT=dyge1,
                          MATR_MASS = massgen,
                          MATR_RIGI = rito[k],
                          SOLVEUR=_F( METHODE='LDLT', ),
                          FREQ = 0.+0.1*k,
                          AMOR_MODAL=_F(AMOR_REDUIT= (0.01,0.01,0.01,
                                        0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.0,),),
                          EXCIT =_F ( VECT_ASSE_GENE = vecgen1,
                                      COEF_MULT= 1.,
                                  ),
                        );

    dyge2 = DYNA_VIBRA(TYPE_CALCUL='HARM',BASE_CALCUL='GENE',
                          reuse=dyge2, RESULTAT=dyge2,
                          MATR_MASS = massgen,
                          MATR_RIGI = rito[k],
                          SOLVEUR=_F( METHODE='LDLT', ),
                          FREQ = 0.+0.1*k,
                          AMOR_MODAL=_F(AMOR_REDUIT= (0.01,0.01,0.01,
                                        0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.01,0.01,0.01,0.01,0.01,0.01,
                                        0.0,),),
                          EXCIT =_F ( VECT_ASSE_GENE = vecgen2,
                                      COEF_MULT= 1.,
                                  ),
                        );

DYNA1 = REST_GENE_PHYS (RESU_GENE = dyge1,
                       NOM_CHAM='DEPL',
                      );

DYNA2 = REST_GENE_PHYS (RESU_GENE = dyge2,
                       NOM_CHAM='DEPL',
                      );

DXA1=RECU_FONCTION(RESULTAT=DYNA1,
                   NOM_CHAM='DEPL',
                   NOM_CMP='DX',
                   NOEUD='NA1',);

DYA1=RECU_FONCTION(RESULTAT=DYNA2,
                   NOM_CHAM='DEPL',
                   NOM_CMP='DY',
                   NOEUD='NA1',);

MDXA1=CALC_FONCTION(EXTRACTION=_F(FONCTION=DXA1,
                                  PARTIE='MODULE',),);


MDYA1=CALC_FONCTION(EXTRACTION=_F(FONCTION=DYA1,
                                  PARTIE='MODULE',),);


DXB1=RECU_FONCTION(RESULTAT=DYNA1,
                   NOM_CHAM='DEPL',
                   NOM_CMP='DX',
                   NOEUD='NB1',);


DYB1=RECU_FONCTION(RESULTAT=DYNA2,
                   NOM_CHAM='DEPL',
                   NOM_CMP='DY',
                   NOEUD='NB1',);


MDXB1=CALC_FONCTION(EXTRACTION=_F(FONCTION=DXB1,
                                  PARTIE='MODULE',),);


MDYB1=CALC_FONCTION(EXTRACTION=_F(FONCTION=DYB1,
                                  PARTIE='MODULE',),);

TEST_FONCTION(VALEUR=(_F(VALE_CALC=0.000113210871228,
                         VALE_REFE=1.13207E-4,CRITERE='ABSOLU',
                         VALE_PARA=7.2999999999999998,
                         REFERENCE='AUTRE_ASTER',
                         PRECISION=1.E-3,
                         FONCTION=MDXA1,),
                      _F(VALE_CALC=0.000112618510152,
                         VALE_REFE=1.12606E-4,CRITERE='ABSOLU',
                         VALE_PARA=7.2999999999999998,
                         REFERENCE='AUTRE_ASTER',
                         PRECISION=1.E-3,
                         FONCTION=MDXB1,),
                      _F(VALE_CALC=2.50591561058e-05,
                         VALE_REFE=2.5023499999999999E-05,CRITERE='ABSOLU',
                         VALE_PARA=10.300000000000001,
                         REFERENCE='AUTRE_ASTER',
                         PRECISION=2.E-3,
                         FONCTION=MDYA1,),
                      _F(VALE_CALC=2.45365421447e-05,
                         VALE_REFE=2.4512399999999999E-05,CRITERE='ABSOLU',
                         VALE_PARA=10.4,
                         REFERENCE='AUTRE_ASTER',
                         PRECISION=2.E-3,
                         FONCTION=MDYB1,),
                      ),
              )

FIN( );
