# ======================================================================
# ======================================================================
# COPYRIGHT (C) 1991 - 2016  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
# ----- LA LOI DE COMPORTEMENT DE TYPE DRUCKER-PRAGER ------------------
# ----- LA MODELISATION D_PLAN PREND EN COMPTE UN MATERIAU AVEC UN -----
# ----- ENDOMMAGEMENT AU NIVEAU D'UNE MAILLE QUI SE TRADUIT PAR UNE ----
# ----- PERTE DE COHESION DE 5% DANS LA MAILLE (M1) EN QUESTION. -------
# ======================================================================

DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON',),PAR_LOT='NON',DEBUG=_F(SDVERI='OUI'))

MAILLAGE=LIRE_MAILLAGE(FORMAT='MED', );

MODELE=AFFE_MODELE( MAILLAGE=MAILLAGE,
                    AFFE=( _F( GROUP_MA     = ('ROCHE',),
                               PHENOMENE    = 'MECANIQUE',
                               MODELISATION = 'D_PLAN'),
                           _F( GROUP_MA     = ('BAS',
                                               'EXTREM',
                                               'HAUT',
                                               'GAUCHE',),
                               PHENOMENE    = 'MECANIQUE',
                               MODELISATION = 'D_PLAN',),),
                           );

MATER1 = DEFI_MATERIAU(ELAS = _F( E  = 5800.0E6,
                                      NU = 0.3,),
                     DRUCK_PRAGER = _F(
                                    SY_ULTM     =    0.47E6    ,
                                   ALPHA = 0.33,
                                   SY = 2.11E6,
                                   P_ULTM = 0.01,
                                   ECROUISSAGE = 'PARABOLIQUE',),);

MATER2 = DEFI_MATERIAU(ELAS = _F( E  = 5800.0E6,
                                      NU = 0.3,),
                     DRUCK_PRAGER = _F( SY_ULTM     =    0.44E6    ,
                                   ALPHA = 0.33,
                                   SY = 2.E6,
                                   P_ULTM = 0.01,
                                   ECROUISSAGE = 'PARABOLIQUE',),);

MAILLAGE=MODI_MAILLAGE( reuse=MAILLAGE,
                        MAILLAGE=MAILLAGE,
                        ORIE_PEAU_2D=_F( GROUP_MA = ('BAS',
                                                     'EXTREM',
                                                     'HAUT',
                                                     'GAUCHE',),)
                       )

CHMAT = AFFE_MATERIAU( MAILLAGE = MAILLAGE,
                       AFFE = (
                              _F( TOUT   = 'OUI',
                                  MATER  = MATER1,),
                              _F( MAILLE = 'M1',
                                  MATER = MATER2),
                                  ),);

SIGINIT=CREA_CHAMP( TYPE_CHAM='CART_SIEF_R',
                    OPERATION='AFFE',
                    MODELE=MODELE,
                    AFFE=_F( TOUT='OUI',
                             NOM_CMP=( 'SIXX',
                                       'SIYY',
                                       'SIZZ',
                                       'SIXY',
                                       'SIXZ',
                                       'SIYZ',
                                       'SIP',
                                       'M11',
                                       'FH11X',
                                       'FH11Y',),
                             VALE   =( -2.E6,
                                       -2.E6,
                                       -2.E6,
                                         0.0,
                                         0.0,
                                         0.0,
                                         0.0,
                                         0.0,
                                         0.0,
                                         0.0,),),);

CHAR_DR=AFFE_CHAR_MECA(    MODELE=MODELE,
                           PRES_REP=_F(   GROUP_MA = 'EXTREM',
                                         PRES = 2.0E6)
                        )

CHAR_GA=AFFE_CHAR_MECA(    MODELE=MODELE,
                             PRES_REP=_F(   GROUP_MA = 'GAUCHE',
                                         PRES = 2.0E6)
                        )

DEPL_BA=AFFE_CHAR_MECA(    MODELE=MODELE,
                              DDL_IMPO=_F(  GROUP_MA = 'BAS',
                                            DY = 0.)
                           )

DEPL_GA=AFFE_CHAR_MECA(    MODELE=MODELE,
                              DDL_IMPO=_F(  GROUP_MA = 'GAUCHE',
                                          DX = 0.), ) ;

DEPL_HA=AFFE_CHAR_MECA(MODELE=MODELE,
                    FACE_IMPO=_F(  GROUP_MA = 'HAUT',
                                          DY = 1.)
                           )

COEF=DEFI_FONCTION(      NOM_PARA='INST',
                           PROL_DROITE='CONSTANT',
                          PROL_GAUCHE='CONSTANT',
                         VALE=( 0.0,    0.00,
                                2.0,   -0.030, )
                       )

TEMPS=DEFI_LIST_REEL(   DEBUT=0.,
                         INTERVALLE=(
                         _F(  JUSQU_A = 2.00,        NOMBRE =  100, ),),
                    )

DEFLIST =DEFI_LIST_INST(DEFI_LIST=_F(LIST_INST =TEMPS ),
                        ECHEC=_F(EVENEMENT     = 'ERREUR',
                                 ACTION        = 'DECOUPE',
                                 SUBD_METHODE  = 'MANUEL',
                                 SUBD_NIVEAU   = 3,
                                 SUBD_PAS      = 10,
                                 SUBD_PAS_MINI = 0.000001),)

try :
     U=STAT_NON_LINE(MODELE=MODELE,
                     CHAM_MATER=CHMAT,
                 EXCIT=( _F( CHARGE=CHAR_DR,  ),
                         _F( CHARGE=CHAR_GA,  ),
                         _F( CHARGE = DEPL_BA, ),
                         _F( CHARGE = DEPL_GA,),
                         _F( CHARGE = DEPL_HA,
                             FONC_MULT = COEF,),),
                 COMPORTEMENT=_F( RELATION = 'DRUCK_PRAGER'),
                 INCREMENT=_F( LIST_INST = DEFLIST,),
                 NEWTON=_F( MATRICE = 'TANGENTE',
                            REAC_ITER = 1,),
                 ETAT_INIT   = _F( SIGM  = SIGINIT,),
                 CONVERGENCE=_F( RESI_GLOB_RELA = 1.E-6,
                                ITER_GLOB_MAXI =  26,),
                           );
except aster.NonConvergenceError:
     print """\nProbleme de convergence pour cause de localisation\n"""
# ON RECUPERE LE DERNIER INSTANT PROPREMENT CALCULE DANS STAT_NON_LINE
# POUR FAIRE UNE VERIFICATION EN NON-REGRESSION SUR CE NUMERO D'ORDRE

     last_iter=U.LIST_VARI_ACCES()['NUME_ORDRE'][-1]


U=CALC_CHAMP(reuse=U,CRITERES=('INDL_ELGA'),RESULTAT=U,NUME_ORDRE=(19,last_iter))

############################################################
#IMPR_RESU(RESU=_F(RESULTAT=U,
#                  NUME_ORDRE = (19,last_iter),
#                  NOM_CHAM   = ('INDL_ELGA',),),);
############################################################

TEST_RESU(RESU=(_F(NUME_ORDRE=19,
                   POINT=1,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=19,
                   POINT=2,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=19,
                   POINT=3,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=19,
                   POINT=4,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=19,
                   POINT=5,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=19,
                   POINT=6,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=19,
                   POINT=7,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=19,
                   POINT=8,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=19,
                   POINT=9,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=19,
                   POINT=1,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M11',
                   ),
                _F(NUME_ORDRE=19,
                   TYPE_TEST='SOMM',
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   VALE_CALC=284.94887633337,
                   ),
                _F(NUME_ORDRE=30,
                   POINT=1,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=30,
                   POINT=2,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=30,
                   POINT=3,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=30,
                   POINT=4,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=30,
                   POINT=5,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=30,
                   POINT=6,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=30,
                   POINT=7,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=30,
                   POINT=8,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=30,
                   POINT=9,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M1',
                   ),
                _F(NUME_ORDRE=30,
                   POINT=1,
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   NOM_CMP='INDICE',
                   VALE_CALC=1.0,
                   MAILLE='M11',
                   ),
                _F(NUME_ORDRE=30,
                   TYPE_TEST='SOMM',
                   RESULTAT=U,
                   NOM_CHAM='INDL_ELGA',
                   VALE_CALC=332.22337579073,
                   ),
                ),
          )

FIN();
