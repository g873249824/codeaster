# TITRE CYLINDRE AVEC ARMATURES SOUS PRESSION
# ======================================================================
# COPYRIGHT (C) 1991 - 2015  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
#       TEST DE LA MODELISATION GRILLE_MEMBRANE AVEC
#       DES MAILLES TRIA6

# CARACTERISTIQUES DU BETON
E = 2e10
nu = .2

# CARACTERISTIQUES DE L'ARMATURE
Ea = 2e11
sec = .1

# CARACTERISTIQUES DU CYLINDRE
# a : RAYON INTERNE
# b : RAYON EXTERNE

a= 10.
b= 20.

# PRESSION INTERNE
P=1e6


# SOLUTION ANALYTIQUE
#--------------------
l  = nu*E/(1.-2.*nu)/(1.+nu)
m  = 1/2.*E/(1.+nu)

Pb = 4.*P*a**2*(l+m)/(b*(3*l+2*m)*2*m*(b**2-a**2)/Ea/sec+b**2*(l+2*m)+a**2*(3*l+2*m))

C1 = (P*a**2-Pb*b**2)/(b**2-a**2)
C2 = a**2*b**2*(P-Pb)/(b**2-a**2)
e  = 2./3./(3*l+2*m)*C1
c  = l/m/(3*l+2*m)*C1
def f_srr(r) :
  y = C1-C2/r**2
  return y
def f_stt(r) :
  y = C1+C2/r**2
  return y

# Deplacements, deformations contraintes dans le Beton en R=a
DX_a = (c+3*e)*a/2+C2/2./m/a
EPSRR_a=(c+3*e)/2.-C2/2./m/a/a
EPSTT_a=(c+3*e)/2.+C2/2./m/a/a
SIGRR_a=f_srr(a)
SIGTT_a=f_stt(a)

# Deplacement, deformations contraintes dans le Beton en R=b
DX_b = (c+3*e)*b/2+C2/2./m/b
EPSRR_b=(c+3*e)/2.-C2/2./m/b/b
EPSTT_b=(c+3*e)/2.+C2/2./m/b/b
SIGRR_b=f_srr(b)
SIGTT_b=f_stt(b)

# Deformations, Contraintes dans l'armature

ESPXX_armature=EPSTT_b
SIGXX_armature=ESPXX_armature*Ea

#----------------------------------------------------
DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON'),DEBUG=_F(SDVERI='OUI'))

MA=LIRE_MAILLAGE(FORMAT='MED',INFO=2);

BETON=DEFI_MATERIAU(ELAS=_F(E=E,
                            NU=nu,),);

ACIER=DEFI_MATERIAU(
            ELAS=_F(  E = Ea,   NU = 0.0),
            ECRO_LINE=_F( D_SIGM_EPSI = 2.E10,   SY = 2.E11, )
                          )

MATE=AFFE_MATERIAU(MAILLAGE=MA,
                   AFFE=(
                         _F(GROUP_MA=('CYLINDRE',
                                      'SURF_INT',
                                      'SURF_INF','SURF_SUP',
                                      'SURF_DRO','SURF_GAU'),
                           MATER=BETON,),
                        _F(  GROUP_MA = ('SURF_EXT',),MATER = ACIER,),),);

MO=AFFE_MODELE(MAILLAGE=MA,INFO=2,
               AFFE=(
                     _F(GROUP_MA=('CYLINDRE',
                                  'SURF_INT',
                                  'SURF_INF','SURF_SUP',
                                  'SURF_DRO','SURF_GAU'),
                       PHENOMENE='MECANIQUE',
                       MODELISATION='3D',),
                    _F(  GROUP_MA = 'SURF_EXT',
                          PHENOMENE = 'MECANIQUE',
                          MODELISATION = 'GRILLE_MEMBRANE'),));

MA=MODI_MAILLAGE( reuse=MA,
                 MAILLAGE=MA,
                 ORIE_PEAU_3D=_F(  GROUP_MA = ('SURF_INT','SURF_EXT',
                                               'SURF_INF','SURF_SUP',
                                               'SURF_DRO','SURF_GAU')
                      ))

CAREL=AFFE_CARA_ELEM(    MODELE=MO,
                       GRILLE=(_F( GROUP_MA = 'SURF_EXT',
                                SECTION = sec,
                                ANGL_REP = (90., 0.0,),
                                EXCENTREMENT = 0.0,
                              ),
                              )
                        )
CHAR_1=AFFE_CHAR_MECA(MODELE=MO,
                    FACE_IMPO=(_F(GROUP_MA='SURF_DRO',DNOR=0.0,),
                               _F(GROUP_MA='SURF_GAU',DNOR=0.0,),
                              ),
                     )
CHAR_2=AFFE_CHAR_MECA(MODELE=MO,
                    PRES_REP=_F(GROUP_MA='SURF_INT',
                                PRES=P,),
      )
CHAR_3=AFFE_CHAR_MECA(MODELE=MO,
                    DDL_IMPO=_F(GROUP_MA = ('SURF_SUP'),
                                DZ = 0.),
      )

FM=DEFI_FONCTION(NOM_PARA='INST',
                 VALE=(0.0,0.0,1.0,1.0,),);

LINST=DEFI_LIST_REEL(DEBUT=0.0,
                     INTERVALLE=_F(JUSQU_A=1.0,
                                   NOMBRE=1,),);

RESU=STAT_NON_LINE(MODELE=MO,
                   CHAM_MATER=MATE,
                   CARA_ELEM=CAREL,
                   EXCIT=(_F(CHARGE=CHAR_1),
                          _F(CHARGE=CHAR_2,FONC_MULT=FM,),
                          _F(CHARGE=CHAR_3)
                    ,),
                     NEWTON=_F(MATRICE='TANGENTE',
                               ),
                   COMPORTEMENT=(_F(RELATION='ELAS',
                                GROUP_MA='CYLINDRE',),
                             _F(RELATION='GRILLE_ISOT_LINE',
                                GROUP_MA='SURF_EXT',),),
                   INCREMENT=_F(LIST_INST=LINST,),);

CALC_CHAMP(reuse=RESU,CONTRAINTE=('SIGM_ELNO'),RESULTAT=RESU)

CALC_CHAMP(reuse=RESU,DEFORMATION=('EPSI_ELNO'),GROUP_MA='BETON',RESULTAT=RESU)

RESU=CALC_CHAMP(reuse = RESU,
            CRITERE='RELATIF',
            RESULTAT=RESU,
            CONTRAINTE='SIGM_NOEU',DEFORMATION='EPSI_NOEU',
            GROUP_MA=('BETON'),
            PRECISION=1.E-3,
            );

#
# -------------------------------------------------
# POST TRAITEMENT DES RESULTATS
# -------------------------------------------------
#

# TESTS DES DEPLACEMENTS, DEFORMATIONS ET DES CONTRAINTES DANS LE BETON (R=a)

TEST_RESU(RESU=(_F(GROUP_NO='A',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='DEPL',
                   NOM_CMP='DX',
                   VALE_CALC= 0.000891925797272,
                   VALE_REFE=8.9192546583850927E-4,),
                _F(GROUP_NO='A',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='EPSI_NOEU',
                   NOM_CMP='EPXX',
                   VALE_CALC=-6.58335943559E-05,
                   VALE_REFE=-6.5838509316770184E-05,),
                _F(GROUP_NO='A',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='EPSI_NOEU',
                   NOM_CMP='EPYY',
                   VALE_CALC= 8.91855427189E-05,
                   VALE_REFE=8.9192546583850943E-05,),
                _F(GROUP_NO='A',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='SIGM_NOEU',
                   NOM_CMP='SIXX',
                   VALE_CALC=-999940.495938,
                   VALE_REFE=-1.E6,),
                _F(GROUP_NO='A',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='SIGM_NOEU',
                   NOM_CMP='SIYY',
                   VALE_CALC= 1583711.78864,
                   VALE_REFE=1.5838509316770188E6,),
                ),
          )

# TESTS DES DEPLACEMENTS, DEFORMATIONS ET DES CONTRAINTES DANS LE BETON (R=b)

TEST_RESU(RESU=(_F(GROUP_NO='B',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='DEPL',
                   NOM_CMP='DX',
                   VALE_CALC= 0.00062111350707,
                   VALE_REFE=6.2111801242236027E-4,),
                _F(GROUP_NO='B',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='EPSI_NOEU',
                   NOM_CMP='EPXX',
                   VALE_CALC=-7.65668505728E-06,
                   VALE_REFE=-7.7018633540372683E-06,
                   PRECISION=1.E-2,),
                _F(GROUP_NO='B',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='EPSI_NOEU',
                   NOM_CMP='EPYY',
                   VALE_CALC= 3.10783725455E-05,
                   VALE_REFE=3.1055900621118014E-05,),
                _F(GROUP_NO='B',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='SIGM_NOEU',
                   NOM_CMP='SIXX',
                   VALE_CALC=-29992.2937938,
                   VALE_REFE=-3.1055900621118024E4,
                   PRECISION=0.055,),
                _F(GROUP_NO='B',
                   INST=1.0,
                   REFERENCE='ANALYTIQUE',
                   RESULTAT=RESU,
                   NOM_CHAM='SIGM_NOEU',
                   NOM_CMP='SIYY',
                   VALE_CALC= 615591.999587,
                   VALE_REFE=6.1490683229813667E5,
                   PRECISION=2.E-3,),
                ),
          )

# TESTS DES CONTRAINTES DANS L'ARMATURE (R=b)

TEST_RESU(RESU=_F(GROUP_NO='B',
                  INST=1.0,
                  REFERENCE='ANALYTIQUE',
                  RESULTAT=RESU,
                  NOM_CHAM='SIGM_ELNO',
                  NOM_CMP='SIXX',
                  VALE_CALC= 6210637.95811,
                  VALE_REFE=6.2111801242236029E6,
                  MAILLE='M1403',),
          )

FIN()
"""
#Post traitements - attention : se placer en par_lot=non
#Mise en commentaires : CD 16/02/06
CHAMELG=CALC_CHAM_ELEM(MODELE=MO,
                       CARA_ELEM=CAREL,
                       GROUP_MA='BETON',
                       OPTION='COOR_ELGA',);

x=CHAMELG.EXTR_COMP("X",[])
y=CHAMELG.EXTR_COMP("Y",[])
w=CHAMELG.EXTR_COMP("W",[])

r=sqrt(x.valeurs**2+y.valeurs**2)
theta=arctan(y.valeurs/x.valeurs)

CONT  = CREA_CHAMP(
             TYPE_CHAM = 'ELGA_SIEF_R',
             OPERATION = 'EXTR',
             RESULTAT  = RESU,
             NOM_CHAM  = 'SIEF_ELGA',
             INST      = 1.,
             )

sxx=CONT.EXTR_COMP("SIXX",['BETON']).valeurs
syy=CONT.EXTR_COMP("SIYY",['BETON']).valeurs
sxy=CONT.EXTR_COMP("SIXY",['BETON']).valeurs

srr=sxx*cos(theta)**2+syy*sin(theta)**2+2*sxy*sin(theta)*cos(theta)
stt=sxx*sin(theta)**2+syy*cos(theta)**2-2*sxy*sin(theta)*cos(theta)

ax=sort(r)
ay=array(map(f_srr,ax))
az=take(srr,argsort(r))

bx=ax
by=array(map( f_stt,bx))
bz=take(stt,argsort(r))
#fichier=open('./REPE_OUT/resu_grille_lin_1.dat','w')
#for i in xrange(len(r)) :
#  fichier.writelines('%E %E %E %E %E\n'%(ax[i],ay[i],az[i],by[i],bz[i]))
#fichier.close()

"""
