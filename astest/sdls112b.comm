# TITRE EXTRAPOLATION DE MESURES SUR UN MODELE 2D
#            CONFIGURATION MANAGEMENT OF EDF VERSION
# ======================================================================
# COPYRIGHT (C) 1991 - 2013  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY  
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY  
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR     
# (AT YOUR OPTION) ANY LATER VERSION.                                                    
#                                                                       
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT   
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF            
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU      
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.                              
#                                                                       
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE     
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,         
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.        
# ======================================================================

#       TEST DU GARTEUR : BASE D'EXPANSION = MODES STATIQUES

DEBUT(CODE=_F(NOM='SDLS112B', NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON'), 
      DEBUG=_F(SDVERI='NON'),
     )


#********************************
# CALCUL DE LA BASE DE PROJECTION
#********************************

MAYAFEM=LIRE_MAILLAGE(UNITE=20);


MAYAFEM=DEFI_GROUP(reuse =MAYAFEM,
                   MAILLAGE=MAYAFEM,
                   CREA_GROUP_MA=_F(NOM='ALL_EL',
                                    TOUT='OUI',),
                   CREA_GROUP_NO=_F(TOUT_GROUP_MA='OUI',),);

MATER1=DEFI_MATERIAU(ELAS=_F(E=72000000000.0,
                             NU=0.34,
                             RHO=2700.0,),);

MATER2=DEFI_MATERIAU(ELAS=_F(E=210000000000.0,
                             NU=0.29,
                             RHO=7800.0,),);

MODFEM=AFFE_MODELE(MAILLAGE=MAYAFEM,
                   AFFE=(_F(GROUP_MA=('GROUP1','GROUP2','GROUP3','GROUP4','GROUP5','GROUP6','GROUP7','GROUP8',),
                            PHENOMENE='MECANIQUE',
                            MODELISATION='DKT',),
                         _F(GROUP_MA='GROUP9',
                            PHENOMENE='MECANIQUE',
                            MODELISATION='DIS_TR',),
                         _F(GROUP_NO='GROUP10',
                            PHENOMENE='MECANIQUE',
                            MODELISATION='DIS_T',),),);

CHMAT=AFFE_MATERIAU(MAILLAGE=MAYAFEM,
                    AFFE=(_F(GROUP_MA=('GROUP1','GROUP2','GROUP3','GROUP4','GROUP5','GROUP6','GROUP7','GROUP9',),
                             MATER=MATER1,),
                          _F(GROUP_MA='GROUP8',
                             MATER=MATER2,),),);

CHCAR=AFFE_CARA_ELEM(MODELE=MODFEM,
                     COQUE=(_F(GROUP_MA=('GROUP2','GROUP3','GROUP4','GROUP5','GROUP7',),
                               EPAIS=0.01,),
                            _F(GROUP_MA='GROUP8',
                               EPAIS=0.016,),
                            _F(GROUP_MA='GROUP1',
                               EPAIS=0.05,),
                            _F(GROUP_MA='GROUP6',
                               EPAIS=0.011,),),
                     DISCRET=(_F(GROUP_MA='GROUP9',
                                 REPERE='GLOBAL',
                                 CARA='K_TR_D_L',
                                 VALE=(1e+12,1e+12,1e+12,100000000.0,100000000.0,100000000.0,),),
                                _F(GROUP_MA='GROUP9',
                                 REPERE='GLOBAL',
                                 CARA='M_TR_L',
                                 VALE=(0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,
                                 0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,
                                 0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,
                                 0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,),),
                              _F(GROUP_NO='GROUP10',
                                 CARA='M_T_D_N',
                                 VALE=0.5,),),);


CHARGE=AFFE_CHAR_MECA(MODELE=MODFEM,
                      DDL_IMPO=_F(NOEUD='N58',
                                  DX=0.0,
                                  DY=0.0,
                                  DZ=0.0,
                                  DRX=0.0,
                                  DRY=0.0,
                                  DRZ=0.0,),);

KELEM=CALC_MATR_ELEM(OPTION='RIGI_MECA',
                     MODELE=MODFEM,
                     CHAM_MATER=CHMAT,
                     CARA_ELEM=CHCAR,
                     CHARGE=CHARGE,
                     );

MELEM=CALC_MATR_ELEM(OPTION='MASS_MECA',
                     MODELE=MODFEM,
                     CHAM_MATER=CHMAT,
                     CARA_ELEM=CHCAR,
                     CHARGE=CHARGE,
                     );

NUME=NUME_DDL(MATR_RIGI=KELEM,);

KASS=ASSE_MATRICE(MATR_ELEM=KELEM,
                  NUME_DDL=NUME,);

MASS=ASSE_MATRICE(MATR_ELEM=MELEM,
                  NUME_DDL=NUME,);

MASSE=POST_ELEM(MASS_INER=_F(TOUT='OUI',),
                MODELE=MODFEM,
                CHAM_MATER=CHMAT,
                CARA_ELEM=CHCAR,
                CHARGE=CHARGE,);




#######################################################
# CALCUL D'UNE BASE DE MODES STATIQUES POUR L'EXPANSION
#######################################################

# On va calculer les deformees statiques pour les noeuds
# situes "a cote" de noeuds experimentaux. La liste de ces noeuds
# reduite a ete obtenue grace au tableau de correspondance imprime dans 
# PROJ_MESU_MODAL
l_noeud = (124,137,144,142,112,103,12,
           9,1,25,34,62,63,43,94,77,88,90,85)

## on peut aussi realiser l'expansion avec une liste de noeuds complete
## mais il faudra regulariser le probleme dans MACRO_EXPANS sous risque
## d'avoir un probleme mal conditionne.
#l_noeud = (1,2,4,5,7,8,9,10,11,13,14,25,26,28,29,34,35,37,38,43,44,62,63,64,65,
#           76,77,78,79,82,83,84,85,86,87,88,89,90,91,92,93,94,95,100,101,103,104,
#           109,110,112,113,123,124,125,126,136,137,139,140,142,144,146,147)

noeuds = [ 'N'+ str(kk) for kk in l_noeud]
nb_noeuds = len(noeuds)
nb_ddl = nb_noeuds*3


CHSTAT = AFFE_CHAR_MECA( MODELE=MODFEM,
                         DDL_IMPO=_F(NOEUD=noeuds,
                                     DX=0.0,DY=0.0,DZ=0.0,),);

KELSTAT = CALC_MATR_ELEM( OPTION='RIGI_MECA',
                          MODELE=MODFEM,
                          CHAM_MATER=CHMAT,
                          CARA_ELEM=CHCAR,
                          CHARGE=CHSTAT
                          );

NUMSTAT = NUME_DDL( MATR_RIGI = KELSTAT,);

KASTAT = ASSE_MATRICE( MATR_ELEM=KELSTAT,
                       NUME_DDL=NUMSTAT,);


MODSTAT = MODE_STATIQUE( MATR_RIGI = KASTAT,
                         MODE_STAT = _F(NOEUD = noeuds,
                                        AVEC_CMP = ('DX','DY','DZ')))



#********************************
# CREATION DU MODELE EXPERIMENTAL
#********************************


MAYAtmp=LIRE_MAILLAGE(UNITE=22);



MAYAtmp=DEFI_GROUP(reuse =MAYAtmp,
                   MAILLAGE=MAYAtmp,
                   CREA_GROUP_MA=_F(NOM='ALL_EXP',
                                    TOUT='OUI',),
                   CREA_GROUP_NO=_F(TOUT_GROUP_MA='OUI',),);


MAYAEXP=CREA_MAILLAGE(MAILLAGE=MAYAtmp,
                      TITRE='         AUTEUR=INTERFACE_IDEAS                 ',
                      CREA_POI1=_F(TOUT='OUI',NOM_GROUP_MA='NOEU'),
                      )


MODEXP=AFFE_MODELE(MAILLAGE=MAYAEXP,
                   AFFE=_F(GROUP_MA='NOEU',
                           PHENOMENE='MECANIQUE',
                           MODELISATION='DIS_T',),);

CHCAREXP=AFFE_CARA_ELEM(MODELE=MODEXP,
                     DISCRET=(_F(GROUP_MA='NOEU',
                                 REPERE='GLOBAL',
                                 CARA='K_T_D_N',
                                 VALE=(1e+12,1e+12,1e+12,),
                                ),
                              _F(GROUP_MA='NOEU',
                                 REPERE='GLOBAL',
                                 CARA='M_T_D_N',
                                 VALE=(0.,),
                                ),));

KELEXP=CALC_MATR_ELEM(OPTION='RIGI_MECA',
                     MODELE=MODEXP,
                     CARA_ELEM=CHCAREXP,
                     );

MELEXP=CALC_MATR_ELEM(OPTION='MASS_MECA',
                     MODELE=MODEXP,
                     CARA_ELEM=CHCAREXP,
                     );


NUMEXP=NUME_DDL(MATR_RIGI=KELEXP );

KASSEXP=ASSE_MATRICE(MATR_ELEM=KELEXP, NUME_DDL=NUMEXP,);

MASSEXP=ASSE_MATRICE(MATR_ELEM=MELEXP, NUME_DDL=NUMEXP,);



#**********************************************************
# LECTURE DE MODES EXPERIMENTAUX (UNV DS55) ET EXENSION DE
# CEUX-CI SUR LE MAILLAGE NUMERIQUE
#**********************************************************

# lecture des modes experimentaux
MODMES=LIRE_RESU(TYPE_RESU='MODE_MECA',
                 FORMAT='IDEAS',
                 MODELE=MODEXP,
                 UNITE=21,
                 NOM_CHAM='DEPL',
                 MATR_RIGI =KASSEXP,
                 MATR_MASS =MASSEXP,
                 FORMAT_IDEAS=_F(NOM_CHAM='DEPL',
                                 NUME_DATASET=55,
                                 RECORD_6=(1,2,3,8,2,6,),
                                 POSI_ORDRE=(7,4,),
                                 POSI_NUME_MODE=(7,4),
                                 POSI_FREQ=(8,1,),
                                 POSI_MASS_GENE=(8,2),
                                 POSI_AMOR_GENE=(8,3),
                                 NOM_CMP=('DX','DY','DZ','DRX','DRY','DRZ'),),
                 TOUT_ORDRE='OUI',);


## On effectue les memes operations d'expnsion avec une macro
## englobant les trois op ci-dessus. On obtient 4 concepts sortants :
##  - RESU_NX : on extrait un groupe de modes de la base numerique
##  - RESU_EX : idem pour la base experimentale
##  - RESU_ET : modes etendus
##  - RESU_RD : modes etendus reduits, pour comparaison avec les modes exp
##             du debut (validation de la procedure d'expansion)
MACRO_EXPANS( MODELE_CALCUL = _F(MODELE = MODFEM,
                                 BASE = MODSTAT,
                                 NUME_ORDRE = range(1,nb_ddl+1)),
              MODELE_MESURE = _F(MODELE  = MODEXP,
                                 MESURE  = MODMES,),
              NUME_DDL      = NUMEXP,
              RESU_ET       = CO("RES_MODE"),
              RESU_RD       = CO("RED_MODE"),
              RESOLUTION    = _F(METHODE='SVD',
#                                 EPS=1.E-5,
#                                 REGUL='NORM_MIN',
#                                 COEF_PONDER = 1.0E-6
                                 ),
             );

# Calcul du MAC apres expansion sur tout le maillage
MAC_ET=MAC_MODES(BASE_1=RES_MODE,
                 BASE_2=RES_MODE,
                 INFO       =2);


# Calcul du MAC aux points de mesure
MAC_RDEX=MAC_MODES(BASE_1=RED_MODE,
                   BASE_2=MODMES,
                   INFO       =2,
                  );


# Verification : la diagonale du MAC entre modes etendus reduits 
# et modes experimentaux doit valoir 1. La resultat est ici normalement
# aussi bon que dans la modelisation a.
for ind in range(1,22):
    TEST_TABLE(REFERENCE='ANALYTIQUE',
               VALE_CALC=1.0,
               VALE_REFE=1.0,
               NOM_PARA='MAC',
               TOLE_MACHINE=1.E-3,
               TABLE=MAC_RDEX,
               FILTRE=(_F(NOM_PARA='NUME_MODE_1',
                          VALE_I=ind,),
                       _F(NOM_PARA='NUME_MODE_2',
                          VALE_I=ind,),
                       ),
               )


# On peut lancer la totalite du test en interactif en utilisant CALC_ESSAI
#CALC_ESSAI()

FIN();
