# TITRE  POUTRE EULER_BERNOULLI MULTIFIBRES (STATIQUE NON-LINEAIRE)
#            CONFIGURATION MANAGEMENT OF EDF VERSION
# ======================================================================
# COPYRIGHT (C) 1991 - 2013  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================

DEBUT(CODE=_F( NOM = 'SSNL119A',NIV_PUB_WEB='INTERNET'))

# lecture maillage lineique
MAPOU=LIRE_MAILLAGE(UNITE=17,FORMAT='MED',);

# lecture maillage section1
MASEC=LIRE_MAILLAGE(UNITE=18,FORMAT='MED',);


GF=DEFI_GEOM_FIBRE(INFO=2,
   FIBRE = (
      _F(GROUP_FIBRE='SACI', CARA = 'DIAMETRE',
         COOR_AXE_POUTRE = (0.,0.,),
         VALE =(   0.066, -0.218, 32.E-3,
                  -0.066, -0.218, 32.E-3,
                   0.066,  0.218,  8.E-3,
                  -0.066,  0.218,  8.E-3,),),
               ),
   SECTION = _F(
      GROUP_FIBRE='SBET',
      MAILLAGE_SECT = MASEC, TOUT_SECT = 'OUI',
      COOR_AXE_POUTRE = (0., 0.,),
   ),
)


MOPOU=AFFE_MODELE(
   MAILLAGE=MAPOU,
   AFFE=_F(TOUT='OUI', PHENOMENE='MECANIQUE', MODELISATION='POU_D_EM',),)


BETON=DEFI_MATERIAU(
   ELAS=_F(E=3.7272000000E10, NU=0.0,  RHO=2400.0,),
   LABORD_1D=_F(Y01 = 310. , Y02 = 0.070E+5, A1  = 9.E-3 ,  A2  = .52E-5 ,
                B1  = 1.2 ,  B2  = 2. , BETA1  = .1E+7 ,  BETA2  =  -.4E+8, SIGF = 3.5E+6),
)

ACIER=DEFI_MATERIAU(
   ELAS=_F(E=2.E11,  NU=0.0, RHO=7800.0,),
   ECRO_LINE=_F(D_SIGM_EPSI=3.28E9, SY=4.E8,),
)

MATOR=DEFI_MATERIAU(ELAS=_F(E=2.E11,  NU=0.0, RHO=7800.0,), )



POUCA=AFFE_CARA_ELEM(MODELE=MOPOU, INFO=1,
           POUTRE=_F(GROUP_MA=('POUTRE'),
                     SECTION='RECTANGLE',
                     CARA=('HY','HZ'),
                     VALE=(0.2,0.5),),
           ORIENTATION=_F(GROUP_MA=('POUTRE'),
                          CARA='ANGL_VRIL',
                          VALE=-90.0,),
           GEOM_FIBRE=GF,
           MULTIFIBRE=(_F(GROUP_MA=('POUTRE'),
                         GROUP_FIBRE=('SBET','SACI'),
                     PREC_AIRE=2.0E-02,
                     PREC_INERTIE=2.5E-01,
                     ),
                       )
)

COMPPMF=DEFI_COMPOR(GEOM_FIBRE=GF,
                    MATER_SECT=MATOR,
                     MULTIFIBRE=(
                                 _F(GROUP_FIBRE='SACI',
                                    MATER=ACIER,
                                    RELATION='VMIS_CINE_LINE'),
                                 _F(GROUP_FIBRE='SBET',
                                    MATER=BETON,
                                    RELATION='LABORD_1D'),
                                  ),
                      )

CHMAT=AFFE_MATERIAU(MAILLAGE=MAPOU,
                    AFFE=_F(GROUP_MA='POUTRE', MATER=(ACIER,BETON,MATOR),),
                    AFFE_COMPOR=_F(GROUP_MA='POUTRE',COMPOR=COMPPMF),
                          );

BLOCAGE=AFFE_CHAR_MECA(MODELE=MOPOU,
                       DDL_IMPO=(_F(GROUP_NO='A', DX=0.0, DY=0.0, DZ=0.0, DRX=0.0, DRY=0.0,),
                                 _F(GROUP_NO='B', DY=0.0,),
                                 ),);


DEPIMP=AFFE_CHAR_MECA(MODELE=MOPOU,
                      DDL_IMPO=_F(GROUP_NO='C', DY=-1.E-2,),);


FOFO=DEFI_FONCTION(NOM_PARA='INST',
                   VALE=(0.0,0.0,3.5,3.5),
                   PROL_DROITE='EXCLU',
                   PROL_GAUCHE='EXCLU',);


LINST=DEFI_LIST_REEL(DEBUT=0.0,
   INTERVALLE=(
      _F(JUSQU_A=0.1,  NOMBRE=2,),
      _F(JUSQU_A=1.4,  NOMBRE=10,),
      _F(JUSQU_A=3. ,  NOMBRE=10,),
   ),
)

U1=STAT_NON_LINE(
   MODELE=MOPOU,
   CHAM_MATER=CHMAT,
   CARA_ELEM=POUCA,
   EXCIT=(
      _F(CHARGE=BLOCAGE,),
      _F(CHARGE=DEPIMP, FONC_MULT=FOFO,),),
   COMP_INCR=(_F(RELATION='MULTIFIBRE'),),
   INCREMENT=_F(LIST_INST=LINST,),
   SOLVEUR=_F(METHODE='MUMPS',),
   NEWTON=_F(MATRICE='TANGENTE',REAC_ITER=1),
   CONVERGENCE=_F(RESI_GLOB_RELA=1.E-5, ITER_GLOB_MAXI=250,),
)

U1=CALC_CHAMP(reuse= U1, RESULTAT= U1, FORCE='REAC_NODA',)
U1=CALC_CHAMP(reuse= U1, RESULTAT= U1, DEFORMATION=('EPSI_ELGA'),)

#IMPR_RESU(RESU=(_F(RESULTAT=U1,NOM_CHAM='REAC_NODA',GROUP_NO = 'A',NOM_CMP='DY'),
#                _F(RESULTAT=U1,NOM_CHAM='SIEF_ELGA',MAILLE='M9',NOM_CMP='SIXX'),
#                ))

# SOURCE_EXTERNE
# Instants
Temps = [  0.100    ,  1.400    ,  2.680    ]
# reactions                  : (valeur, critere, Erreur)
React = [ ( 1.7786E+04,3.0e-05),( 1.097E+05,2.5e-04),( 1.2003E+05,1.5e-03) ]
# contraintes acier tendu    : (valeur, critere, Erreur)
Aciet = [ ( 1.8860E+07,3.0e-04),( 4.001E+08,3.0e-04),( 4.3100E+08,2.0e-02) ]
# contraintes acier comprime : (valeur, critere, Erreur)
Aciec = [ (-2.1890E+07,3.0e-04),(-1.811E+08,1.0e-03),(-4.0210E+08,3.5e-03) ]
# Deformations acier tendu   : (valeur, critere, Erreur)
Eacit = [ ( 9.4320E-05,3.5e-03),( 2.026E-03,5.0e-04),( 1.1460E-02,9.0e-02) ]
# contraintes beton comprime : (valeur, critere, Erreur)
Betoc = [ (-4.4180E+06,6.0e-05),(-3.338E+07,3.0e-03),(-2.8480E+07,2.0e-01) ]
# contraintes beton tendu    : (valeur, critere, Erreur)
Betot = [ ( 3.8550E+06,1.0e-04),( 2.641E+04,2.0e-02),( 3.3660E+03,3.0e-01) ]

# NON_REGRESSION
# Instants
NRTemps = [  2.680    ]
# Deformations acier tendu   : (valeur, critere, Erreur)
NREacit = [ ( 1.0755E-02,2.5e-02) ]
# contraintes beton comprime : (valeur, critere, Erreur)
NRBetoc = [ (-2.5620E+07,5.5e-02) ]
# contraintes beton tendu    : (valeur, critere, Erreur)
NRBetot = [ ( 2.8013E+03,8.0e-02) ]


for indx in range(len(Temps)):
   TEST_RESU(RESU=(
      # Reactions
      _F(RESULTAT=U1, INST=Temps[indx], NOM_CHAM='REAC_NODA', GROUP_NO = 'A', NOM_CMP='DY',
         VALE_CALC=React[indx][0], VALE_REFE=React[indx][0],
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=React[indx][1], TOLE_MACHINE=(React[indx][1],1.0E-05), ),
      # Contraintes acier tendu
      _F(RESULTAT=U1, INST=Temps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=41, NOM_CMP='SIXX',
         VALE_CALC=Aciet[indx][0], VALE_REFE=Aciet[indx][0],
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Aciet[indx][1], TOLE_MACHINE=(Aciet[indx][1],1.0E-05), ),
      # Contraintes acier comprime
      _F(RESULTAT=U1, INST=Temps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=44, NOM_CMP='SIXX',
         VALE_CALC=Aciec[indx][0], VALE_REFE=Aciec[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Aciec[indx][1], TOLE_MACHINE=(Aciec[indx][1],1.0E-05), ),
      # Deformations acier tendu
      _F(RESULTAT=U1, INST=Temps[indx], NOM_CHAM='EPSI_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=41, NOM_CMP='EPXX',
         VALE_CALC=Eacit[indx][0], VALE_REFE=Eacit[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Eacit[indx][1], TOLE_MACHINE=(Eacit[indx][1],1.0E-05), ),
      # Contraintes beton comprime
      _F(RESULTAT=U1, INST=Temps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=1,  NOM_CMP='SIXX',
         VALE_CALC=Betoc[indx][0], VALE_REFE=Betoc[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Betoc[indx][1], TOLE_MACHINE=(Betoc[indx][1],1.0E-05), ),
      # Contraintes beton tendu
      _F(RESULTAT=U1, INST=Temps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=40, NOM_CMP='SIXX',
         VALE_CALC=Betot[indx][0], VALE_REFE=Betot[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Betot[indx][1], TOLE_MACHINE=(Betot[indx][1],1.0E-05), ),
      )
   )

for indx in range(len(NRTemps)):
   TEST_RESU(RESU=(
      # Deformations acier tendu
      _F(RESULTAT=U1, INST=NRTemps[indx], NOM_CHAM='EPSI_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=41, NOM_CMP='EPXX',
         VALE_CALC=NREacit[indx][0],
         CRITERE=('RELATIF','ABSOLU'),
         TOLE_MACHINE=(NREacit[indx][1], 1.0E-05), ),
      # Contraintes beton comprime
      _F(RESULTAT=U1, INST=NRTemps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=1,  NOM_CMP='SIXX',
         VALE_CALC=NRBetoc[indx][0],
         CRITERE=('RELATIF','ABSOLU'),
         TOLE_MACHINE=(NRBetoc[indx][1], 1.0E-05), ),
      # Contraintes beton tendu
      _F(RESULTAT=U1, INST=NRTemps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=40, NOM_CMP='SIXX',
         VALE_CALC=NRBetot[indx][0],
         CRITERE=('RELATIF','ABSOLU'),
         TOLE_MACHINE=(NRBetot[indx][1], 1.0E-05), ),
      )
   )




# **************************************************************
#
#              Methode de subdivision (celle par defaut)
#                 EXTRAPOLE,  OPTION = 'IGNORE_PREMIERES'
#
# **************************************************************

LINSTD=DEFI_LIST_REEL(DEBUT=0.0,
   INTERVALLE=(
      _F(JUSQU_A= 0.100,  NOMBRE=2,),
      _F(JUSQU_A= 1.400,  NOMBRE=2,),
      _F(JUSQU_A= 2.680,  NOMBRE=10,),
   ),
)

LINST3 = DEFI_LIST_INST(
   DEFI_LIST=_F(
      METHODE   = 'MANUEL',
      LIST_INST =  LINSTD,
   ),
   ECHEC=_F(
      EVENEMENT       = 'ERREUR',
      ACTION          = 'ITER_SUPPL',
      SUBD_PAS_MINI   = 0.10E-10,
      SUBD_NIVEAU     = 50,
      PCENT_ITER_PLUS = 100,
   ),
)

U3=STAT_NON_LINE(
   MODELE=MOPOU,
   CHAM_MATER=CHMAT,
   CARA_ELEM=POUCA,
   EXCIT=(
      _F(CHARGE=BLOCAGE,),
      _F(CHARGE=DEPIMP, FONC_MULT=FOFO,),),
   COMP_INCR=(_F(RELATION='MULTIFIBRE',      GROUP_MA='POUTRE',), ),
   INCREMENT= _F(LIST_INST=LINST3,),
   NEWTON=_F(MATRICE='TANGENTE', REAC_ITER=1),
   SOLVEUR=_F(METHODE='MUMPS',),
   CONVERGENCE=_F( RESI_GLOB_RELA = 1.0E-6,ITER_GLOB_MAXI = 50,),
)

U3=CALC_CHAMP(reuse= U3, RESULTAT= U3, FORCE='REAC_NODA', )
U3=CALC_CHAMP(reuse= U3, RESULTAT= U3, DEFORMATION=('EPSI_ELGA'),)

for indx in range(len(Temps)):
   TEST_RESU(RESU=(
      # Reactions
      _F(RESULTAT=U3, INST=Temps[indx], NOM_CHAM='REAC_NODA', GROUP_NO = 'A', NOM_CMP='DY',
         VALE_CALC=React[indx][0], VALE_REFE=React[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=React[indx][1], TOLE_MACHINE=(React[indx][1],1.0E-05), ),
      # Contraintes acier tendu
      _F(RESULTAT=U3, INST=Temps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=41, NOM_CMP='SIXX',
         VALE_CALC=Aciet[indx][0], VALE_REFE=Aciet[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Aciet[indx][1], TOLE_MACHINE=(Aciet[indx][1],1.0E-05), ),
      # Contraintes acier comprime
      _F(RESULTAT=U3, INST=Temps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=44, NOM_CMP='SIXX',
         VALE_CALC=Aciec[indx][0], VALE_REFE=Aciec[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Aciec[indx][1], TOLE_MACHINE=(Aciec[indx][1],1.0E-05), ),
      # Deformations acier tendu
      _F(RESULTAT=U3, INST=Temps[indx], NOM_CHAM='EPSI_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=41, NOM_CMP='EPXX',
         VALE_CALC=Eacit[indx][0], VALE_REFE=Eacit[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Eacit[indx][1], TOLE_MACHINE=(Eacit[indx][1],1.0E-05), ),
      # Contraintes beton comprime
      _F(RESULTAT=U3, INST=Temps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=1,  NOM_CMP='SIXX',
         VALE_CALC=Betoc[indx][0], VALE_REFE=Betoc[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Betoc[indx][1], TOLE_MACHINE=(Betoc[indx][1],1.0E-05), ),
      # Contraintes beton tendu
      _F(RESULTAT=U3, INST=Temps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=40, NOM_CMP='SIXX',
         VALE_CALC=Betot[indx][0], VALE_REFE=Betot[indx][0],    #TODO vale_calc
         REFERENCE='SOURCE_EXTERNE', CRITERE=('RELATIF','ABSOLU'),
         PRECISION=Betot[indx][1], TOLE_MACHINE=(Betot[indx][1],1.0E-05), ),
      )
   )

for indx in range(len(NRTemps)):
   TEST_RESU(RESU=(
      # Deformations acier tendu
      _F(RESULTAT=U3, INST=NRTemps[indx], NOM_CHAM='EPSI_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=41, NOM_CMP='EPXX',
         VALE_CALC=NREacit[indx][0],
         CRITERE=('RELATIF','ABSOLU'),
         TOLE_MACHINE=(NREacit[indx][1],1.0E-05), ),
      # Contraintes beton comprime
      _F(RESULTAT=U3, INST=NRTemps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=1,  NOM_CMP='SIXX',
         VALE_CALC=NRBetoc[indx][0],
         CRITERE=('RELATIF','ABSOLU'),
         TOLE_MACHINE=(NRBetoc[indx][1],1.0E-05), ),
      # Contraintes beton tendu
      _F(RESULTAT=U3, INST=NRTemps[indx], NOM_CHAM='SIEF_ELGA', MAILLE='M9', POINT=1, SOUS_POINT=40, NOM_CMP='SIXX',
         VALE_CALC=NRBetot[indx][0],
         CRITERE=('RELATIF','ABSOLU'),
         TOLE_MACHINE=(NRBetot[indx][1],1.0E-05), ),
      )
   )

"""
#####################################################################
# COURBES DES FIGURES DE LA DOCUMENTATION : EN COMMENTAIRE CI-DESSOUS
######################################################################
# reaction
DEPCY=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='DEPL',           NOM_CMP='DY', GROUP_NO='C', )
DEPBX=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='DEPL',           NOM_CMP='DX', GROUP_NO='B', )
REACA=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='REAC_NODA',      NOM_CMP='DY', GROUP_NO='A', )
# defo acier tendu
DEFAT=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='EPSI_ELGA', NOM_CMP='EPXX', MAILLE='M9', POINT=1, SOUS_POINT=41)
# defo acier comprime
DEFAC=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='EPSI_ELGA', NOM_CMP='EPXX', MAILLE='M9', POINT=1, SOUS_POINT=44)
# defo beton tendu
DEFBT=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='EPSI_ELGA', NOM_CMP='EPXX', MAILLE='M9', POINT=1, SOUS_POINT=40)
# defo beton comprime
DEFBC=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='EPSI_ELGA', NOM_CMP='EPXX', MAILLE='M9', POINT=1, SOUS_POINT= 1)
# cont acier tendu
CONAT=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='SIEF_ELGA', NOM_CMP='SIXX', MAILLE='M9', POINT=1, SOUS_POINT=41)
# cont acier comprime
CONAC=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='SIEF_ELGA', NOM_CMP='SIXX', MAILLE='M9', POINT=1, SOUS_POINT=44)
# cont beton tendu
CONBT=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='SIEF_ELGA', NOM_CMP='SIXX', MAILLE='M9', POINT=1, SOUS_POINT=40)
# cont beton comprime
CONBC=RECU_FONCTION(RESULTAT=U1, NOM_CHAM='SIEF_ELGA', NOM_CMP='SIXX', MAILLE='M9', POINT=1, SOUS_POINT= 1)

fic = './REPE_OUT/courbes.post'
unit = DEFI_FICHIER(FICHIER = fic, ACTION='ASSOCIER', TYPE='ASCII',ACCES='NEW')
IMPR_FONCTION(UNITE=unit,FORMAT='TABLEAU',
   COURBE=(
      _F(FONCTION=DEPCY), _F(FONCTION=DEPBX),
      _F(FONCTION=REACA),
      _F(FONCTION=DEFAT), _F(FONCTION=DEFAC), _F(FONCTION=DEFBT), _F(FONCTION=DEFBC),
      _F(FONCTION=CONAT), _F(FONCTION=CONAC), _F(FONCTION=CONBT), _F(FONCTION=CONBC),
   )
)
DEFI_FICHIER(UNITE = unit, ACTION='LIBERER',)
DETRUIRE(INFO=1,ALARME='NON',CONCEPT=(_F(NOM=unit,),),)
"""
FIN()
