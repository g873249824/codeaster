# ======================================================================
# COPYRIGHT (C) 1991 - 2016  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
#  PAR COUCHES AVEC LOI DE HUJEUX PAR REPONSE DIRECTE EXPLICITE

# Nombre de couches
# (dont la couche elastique correspondant au BEDROCK)
nbcouche  = 11    ;

UN        = 1.0   ;
ZERO      = 0.0   ;
P_PELOUSE = 1.E+2;

YOUNG = 1.E+9;          # [Pa]
NU    = 0.3   ;
RHO   = 2105;          # Valeur homogeneisee

K_EAU     = 2000.E+6;   # coefficient de compressibilite de l eau
INV_K_EAU = 1./K_EAU ;
#INV_K_EAU = 1.E-7 ;

# Parametres Hujeux

PRES0     =  -20.E+3 ;   # pression de consolidation initiale
PCO       = -250.E+3 ;   # pression critique
PREF      = -1.E+6   ;
R_ELA_DEV = 0.025    ;
R_ELA_ISO = .01      ;   # on desactive le mecanisme isotrope

import pdb

# Pour des raisons de performances, on force SDVERI='NON'.
DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',),
      IGNORE_ALARM=('CALCULEL4_9','DYNAMIQUE_2','MECANONLINE_78'),
      DEBUG=_F(SDVERI='NON'));

VISCOLIQ = DEFI_CONSTANTE(VALE=0.001 );
DVISCOL  = DEFI_CONSTANTE(VALE=0.0   );
KINT     = DEFI_CONSTANTE(VALE=1.E-12);
# KINT correspond a une conductivite lambda =1E-9
#      soit a une permeabilite de K = 9.81E-6 m/s

MA=LIRE_MAILLAGE(FORMAT='MED',);

#IMPR_RESU(FORMAT='IDEAS',RESU=_F(MAILLAGE=MA,));

# Definition des differents modeles associes a chaque couche
MOD=[None]*(nbcouche-1);
U  =[None]*(nbcouche-1);
SIG=[None]*(nbcouche-1);
DEP=[None]*(nbcouche-1);
VAR=[None]*(nbcouche-1);

# -->5: debut boucle for
list_group_ma=['ELEM0'];
for n in range(nbcouche-1):

  list_group_ma.append('ELEM'+str(n+1));
  print '   n=',n,'; liste=',list_group_ma

  MOD[n] = AFFE_MODELE(MAILLAGE=MA,
                       AFFE=(_F(GROUP_MA    =tuple(list_group_ma),
                               PHENOMENE   ='MECANIQUE',
                               MODELISATION='D_PLAN_HM'),
                            _F(GROUP_MA    ='BAS',
                               PHENOMENE   ='MECANIQUE',
                               MODELISATION='D_PLAN_ABSO'),
                             ),);

# <--5: fin boucle for


#  -------------------------------------------------------------------
#  Definition du sol sature en eau ACTIF, affectation global materiau,
#  liste d instants
#  -------------------------------------------------------------------

# ---- COUCHE1 : ELASTIQUE TRES RIGIDE
MAT0=DEFI_MATERIAU(ELAS=_F(E     = 5.0*YOUNG,
                           NU    = NU,
                           RHO   = RHO,
                           ALPHA = 0.0),
                   COMP_THM='LIQU_SATU',
                   THM_INIT=_F(PRE1 = 0.0,
                               PORO = 0.35),
                   THM_DIFFU=_F(RHO       = 2105.0,
                                BIOT_COEF = 1.0,
                                PESA_X    = 0.0,
                                PESA_Y    = -9.81,
                                PESA_Z    = 0.0,
                                PERM_IN   = KINT),
                   THM_LIQU=_F(RHO        = 1000.0,
                               UN_SUR_K   = INV_K_EAU,
                               VISC       = VISCOLIQ,
                               D_VISC_TEMP= DVISCOL,),);

# ---- COUCHES SUIVANTES : HUJEUX

Mater_Hujeux =_F(N      = 0.89,
                 BETA    = 10.,
                 D       = 1.7,
                 B       = 1.,
                 PHI     = 21.,
                 ANGDIL  = 21.,
                 PCO     = PCO,
                 PREF    = PREF,
                 AMON    = 0.005,
                 ACYC    = 0.003,
                 # ACYC    = 0.005,
                 CMON    = 0.18,
                 # CCYC    = 0.18,
                 CCYC    = 0.1,
                 RD_ELA  = R_ELA_DEV,
                 RI_ELA  = R_ELA_ISO,
                 RHYS    = 0.1,
                 RMOB    = 0.5,
                 XM      = 2.,
                 RD_CYC  = R_ELA_DEV,
                 RI_CYC  = R_ELA_ISO,
                 DILA    = 1.0);

# ---- COUCHES SUIVANTES : HUJEUX
MAT1=DEFI_MATERIAU(ELAS=_F(E     = YOUNG,
                           NU    = NU,
                           RHO   = RHO,
                           ALPHA = 0.0),
                   HUJEUX=Mater_Hujeux,
                   COMP_THM='LIQU_SATU',
                   THM_INIT=_F(PRE1 = 0.0,
                               PORO = 0.35),
                   THM_DIFFU=_F(RHO       = 2105.0,
                                BIOT_COEF = 1.0,
                                PESA_X    = 0.0,
                                PESA_Y    = -9.81,
                                PESA_Z    = 0.0,
                                PERM_IN   = KINT),
                   THM_LIQU=_F(RHO        = 1000.0,
                               UN_SUR_K   = INV_K_EAU,
                               VISC       = VISCOLIQ,
                               D_VISC_TEMP= DVISCOL,),);


MAT_PAR=DEFI_MATERIAU(
# general mechanical properties of the rock
                      ELAS=_F(E = 5.0*YOUNG, NU=NU,
                              RHO=2105, ALPHA=0.0,),);

AFFMAT1=AFFE_MATERIAU(MAILLAGE=MA,
                      AFFE=(_F(GROUP_MA=list_group_ma[1:nbcouche],
                              MATER=MAT1),
                            _F(GROUP_MA=list_group_ma[0],
                              MATER=MAT0),
                            _F(GROUP_MA='BAS',
                              MATER=MAT_PAR),),);

PES=AFFE_CHAR_MECA(MODELE=MOD[0],
                   PESANTEUR=_F(GRAVITE=1.0,
                                DIRECTION=(0.0,-1.0,0.0),),);

CHPAR=AFFE_CHAR_CINE(MODELE=MOD[0],
                     MECA_IMPO=_F(GROUP_MA='BAS', DY=0.0,),);

TEMPS=DEFI_LIST_REEL(DEBUT=0.0,
                     INTERVALLE=(_F(JUSQU_A=2000000., NOMBRE=20,),
                                 _F(JUSQU_A=3000000., NOMBRE=20,),
                                 _F(JUSQU_A=4000000., NOMBRE=20,),
                                 _F(JUSQU_A=5000000., NOMBRE=20,),
                                 _F(JUSQU_A=6000000., NOMBRE=20,),
                                 _F(JUSQU_A=7000000., NOMBRE=20,),
                                 _F(JUSQU_A=8000000., NOMBRE=20,),
                                 _F(JUSQU_A=9000000., NOMBRE=20,),
                                 _F(JUSQU_A=10000000., NOMBRE=20,),
                                 _F(JUSQU_A=11000000., NOMBRE=20)));

L_ARCH0=DEFI_LIST_REEL(DEBUT=0.0,
                     INTERVALLE=(_F(JUSQU_A=2000000., NOMBRE=2,),
                                 _F(JUSQU_A=3000000., NOMBRE=2,),
                                 _F(JUSQU_A=4000000., NOMBRE=2,),
                                 _F(JUSQU_A=5000000., NOMBRE=2,),
                                 _F(JUSQU_A=6000000., NOMBRE=2,),
                                 _F(JUSQU_A=7000000., NOMBRE=2,),
                                 _F(JUSQU_A=8000000., NOMBRE=2,),
                                 _F(JUSQU_A=9000000., NOMBRE=2,),
                                 _F(JUSQU_A=10000000., NOMBRE=2,),
                                 _F(JUSQU_A=11000000., NOMBRE=2)));

F_EVOL=DEFI_FONCTION(NOM_PARA='INST',
                     PROL_DROITE='LINEAIRE',
                     PROL_GAUCHE='CONSTANT',
                     VALE=(0.      , 0.,
                           1000000., 1.,),);

FOC = DEFI_CONSTANTE(VALE=9.81) ;

#        ----------------------------------
# INIT-  Pose couches 1 et 2 = 1ere couches
#        ----------------------------------


# Consditions aux limites en deplacement pour les premieres couches
n_couche=2

CHLAT=AFFE_CHAR_CINE(MODELE=MOD[0],
                     MECA_IMPO=_F(GROUP_MA=('DR1','GA1'),DX=0.0),);

# Conditions hydrauliques
PHAUT=AFFE_CHAR_CINE(MODELE=MOD[0],
                     MECA_IMPO=_F(GROUP_MA='HA1', PRE1=0.0,),);

PBAS=AFFE_CHAR_CINE(MODELE=MOD[0],
                    MECA_IMPO=_F(GROUP_MA='HA0', PRE1=19620.,),);

SIEF=CREA_CHAMP(INFO=1,
                TYPE_CHAM='ELGA_SIEF_R',
                OPERATION='AFFE',
                MODELE=MOD[0],
                PROL_ZERO='OUI',
                AFFE=_F(GROUP_MA=list_group_ma[1],
                        NOM_CMP=('SIXX','SIYY','SIZZ'),
                        VALE=(PRES0,PRES0,PRES0),),);

DEFLISTT =DEFI_LIST_INST(DEFI_LIST=_F(LIST_INST =TEMPS ),
                        ECHEC=_F(ACTION        = 'DECOUPE',
                                 SUBD_METHODE  = 'MANUEL',
                                 SUBD_PAS=5,
                                 SUBD_NIVEAU=10),)

# Pas d Initialisation des contraintes
# Mise en place de la premiere couche et de la seconde couche simultanement = 1ere couche
# Etat initail du pb hydraulique
# On utilise une valeur de critere lache pour commencer a appliquer le
#   poids car la precision s ameliore ensuite

U[0]=STAT_NON_LINE(MODELE=MOD[0],
                 CHAM_MATER=AFFMAT1,
                 EXCIT=(_F(CHARGE=PHAUT),
                        _F(CHARGE=CHPAR),
                        _F(CHARGE=CHLAT),
                        _F(CHARGE=PES, FONC_MULT=FOC)),
                 ETAT_INIT=_F(SIGM=SIEF),
                 COMPORTEMENT=(_F(RELATION='KIT_HM',
                               ITER_INTE_PAS=-10,
                               RELATION_KIT=('ELAS','LIQU_SATU','HYDR_UTIL'),
                               GROUP_MA=list_group_ma[0]),
                            _F(ITER_INTE_MAXI=50,
                               ITER_INTE_PAS=-5,
                               ALGO_INTE='SPECIFIQUE',
                               RESI_INTE_RELA=1E-8,
                               RELATION='KIT_HM',
                               RELATION_KIT=('HUJEUX','LIQU_SATU','HYDR_UTIL'),
                               GROUP_MA=list_group_ma[1]),),
                 INCREMENT=_F(LIST_INST=DEFLISTT,
                              INST_INIT=0.,
                              INST_FIN=2000000.,),
                 ARCHIVAGE=_F(LIST_INST=TEMPS,),
                 NEWTON=_F(MATRICE='TANGENTE',
                           REAC_ITER=1),
                 CONVERGENCE=_F(ITER_GLOB_MAXI=20,
                                RESI_GLOB_RELA=1E-12,),);

DEP[0]=CREA_CHAMP(TYPE_CHAM='NOEU_DEPL_R',
                OPERATION='EXTR',
                RESULTAT=U[0],
                NOM_CHAM='DEPL',
                INST=2000000.,
                INFO=1,);

SIG[0]=CREA_CHAMP(INFO=1,
                TYPE_CHAM='ELGA_SIEF_R',
                OPERATION='EXTR',
                RESULTAT=U[0],
                NOM_CHAM='SIEF_ELGA',
                INST=2000000.,);

VAR[0]=CREA_CHAMP(INFO=2,
                TYPE_CHAM='ELGA_VARI_R',
                OPERATION='EXTR',
                RESULTAT=U[0],
                NOM_CHAM='VARI_ELGA',
                INST=2000000.,);

U[0]=CALC_CHAMP(reuse=U[0],
                GROUP_MA=list_group_ma[0:2],
                CONTRAINTE=('SIGM_ELNO'),
                VARI_INTERNE=('VARI_ELNO'),
                RESULTAT=U[0]);

CHPNUL = CREA_CHAMP(TYPE_CHAM='NOEU_DEPL_R',
                   OPERATION='AFFE',
                   MODELE=MOD[n],
                   AFFE=_F(TOUT = 'OUI',
                           NOM_CMP = ('DX','DY','PRE1'),
                           VALE = (0.,0.,0.),),);

#         -------------------------
# SUITE-  Pose couches 3 a nbcouche
#         -------------------------


# Hauteur successive de la colonne au fur et a mesure de la construction
Height = [5,7,9,11,13,15,17,19,21,23,25]

# DEFINITION FONCTION PROJECTION SUIVANT Y
def PROJ(x,Hauteur) :
    if x<=Hauteur : return x
    if x>Hauteur  : return Hauteur

# -->10: Boucle sur la pose des couches 3 a nbcouche
for n in range(1,nbcouche-1):

    DETRUIRE(INFO=1,
             OBJET=_F(CHAINE=('CHLAT','PHAUT','SIEF','CHPAR',),),);

    n_couche = n+2
    print ' > n_couche          =',n_couche

    t_init=(n+1)*1.E6
    t_fin =(n+2)*1.E6

    print ' > t_init =',t_init,' t_fin =',t_fin

    FONCH = DEFI_FONCTION(NOM_PARA='INST',
                          PROL_DROITE='CONSTANT',
                          PROL_GAUCHE='CONSTANT',
                          VALE=(t_init, 0.,
                                t_fin, 1.),);

    MAT1_f=DEFI_MATERIAU(ELAS=_F(E     = YOUNG,
                           NU    = NU,
                           RHO   = RHO,
                           ALPHA = 0.0),
                   HUJEUX=Mater_Hujeux,
                   COMP_THM='LIQU_SATU',
                   THM_INIT=_F(PRE1 = 0.0,
                               PORO = 0.35),
                   THM_DIFFU=_F(RHO       = 2105.0,
                                BIOT_COEF = 1.0,
                                PESA_X    = 0.0,
                                PESA_Y    = -9.81,
                                PESA_Z    = 0.0,
                                PESA_MULT = FONCH,
                                PERM_IN   = KINT),
                   THM_LIQU=_F(RHO        = 1000.0,
                               UN_SUR_K   = INV_K_EAU,
                               VISC       = VISCOLIQ,
                               D_VISC_TEMP= DVISCOL),);

    AFFMAT2=AFFE_MATERIAU(MAILLAGE=MA,
                      AFFE=(_F(GROUP_MA=list_group_ma[n+1],
                              MATER=MAT1_f),
                            _F(GROUP_MA=list_group_ma[1:n+1],
                              MATER=MAT1),
                            _F(GROUP_MA=list_group_ma[0],
                              MATER=MAT0),
                            _F(GROUP_MA='BAS',
                              MATER=MAT_PAR),),);

    PESHAU=AFFE_CHAR_MECA(MODELE=MOD[n],
                          PESANTEUR=_F(GRAVITE=9.81,
                                       DIRECTION=(0.0,-1.0,0.0,),
                                       GROUP_MA =list_group_ma[n+1],),);

    PESBAS=AFFE_CHAR_MECA(MODELE=MOD[n],
                          PESANTEUR=_F(GRAVITE=9.81,
                                       DIRECTION=(0.0,-1.0,0.0,),
                                       GROUP_MA =list_group_ma[:n+1],),);


    # Deplacements lateraux nuls
    CHLAT=AFFE_CHAR_CINE(INFO=1,
                         MODELE=MOD[n],
                         MECA_IMPO=(_F(GROUP_MA=('GA'+str(n+1),'DR'+str(n+1)),
                                      DX=0.0),),);

    # Pression hydraulique nulle en haut de la couche posee (numero n)
    PHAUT=AFFE_CHAR_CINE(INFO=1,
                         MODELE=MOD[n],
                         MECA_IMPO=_F(GROUP_MA='HA'+str(n+1), PRE1=0.0,),);

    CHPAR=AFFE_CHAR_CINE(MODELE=MOD[n],
                     MECA_IMPO=_F(GROUP_MA='BAS', DY=0.0,),);

    SIEF=CREA_CHAMP(INFO=1,
                    TYPE_CHAM='ELGA_SIEF_R',
                    OPERATION='AFFE',
                    MODELE=MOD[n],
                    PROL_ZERO='OUI',
                    AFFE=_F(GROUP_MA=list_group_ma[n+1],
                            NOM_CMP =('SIXX','SIYY','SIZZ'),
                            VALE    =(PRES0,PRES0,PRES0,),),);

    print ' > list_group_ma =',list_group_ma[:n+1]
    print '   list_group_ma =',list_group_ma[n+1]


    # Initialisation des champs de deplacement et de contrainte dans les couches
    # deja calculees
    GrMa = list_group_ma[:n+1];

    INIDEP=CREA_CHAMP(INFO=1,
                      TYPE_CHAM='NOEU_DEPL_R',
                      OPERATION='ASSE',
                      MODELE=MOD[n],
                      OPTION='DEPL',

                      ASSE=_F(GROUP_MA=list_group_ma[:n+1],
                               CHAM_GD=DEP[n-1]),);

    FX = FORMULE(NOM_PARA=('X'),VALE='X')
    FY = FORMULE(NOM_PARA=('Y'),VALE='PROJ(Y,%f)'%Height[n])

    DEPL_PJ = PROJ_CHAMP(INFO=1,
                         PROJECTION = 'OUI',
                         METHODE    = 'COLLOCATION',
                         MODELE_1   = MOD[n-1],
                         MODELE_2   = MOD[n],
                         CHAM_GD    = DEP[n-1],
                         VIS_A_VIS  = _F(GROUP_MA_1 = list_group_ma[:n+1],
                                         GROUP_MA_2 = list_group_ma[:n+2],
                                         TRANSF_GEOM_2 = (FX, FY),),);

    CH_BID = CREA_CHAMP(INFO=1,
                         TYPE_CHAM='NOEU_DEPL_R',
                         OPERATION='ASSE',
                         MODELE = MOD[n],
                         ASSE=_F(GROUP_MA=list_group_ma[:n+2],
                                CHAM_GD = DEPL_PJ,
                                NOM_CMP = ('DX','DY'),),);

    Y1 = Height[n+1];
    Y0 = Height[n];

    DXN = FORMULE(NOM_PARA=('DX','Y'),VALE='DX*(%f-Y)/(%f-%f)'%(Y1,Y1,Y0))
    DYN = FORMULE(NOM_PARA=('DY','Y'),VALE='DY*(%f-Y)/(%f-%f)'%(Y1,Y1,Y0))

    CH_GEOM = CREA_CHAMP(INFO=1,
                         TYPE_CHAM = 'NOEU_GEOM_R',
                         MAILLAGE = MA,
                         OPERATION='EXTR',
                         NOM_CHAM = 'GEOMETRIE',);


    CH_FONC = CREA_CHAMP(INFO=1,
                         TYPE_CHAM='NOEU_NEUT_F',
                         OPERATION='AFFE',
                         MODELE = MOD[n],
                         AFFE=_F(GROUP_MA=list_group_ma[n+1],
                                  VALE_F = (DXN,DYN),
                                  NOM_CMP= ('X1','X2'),),);

    CH_EVAL = CREA_CHAMP(INFO=1,
                         TYPE_CHAM='NOEU_NEUT_R',
                         OPERATION='EVAL',
                         CHAM_F = CH_FONC,
                         CHAM_PARA = (DEPL_PJ,CH_GEOM),);

    CH_DEPL = CREA_CHAMP(INFO=1,
                         TYPE_CHAM='NOEU_DEPL_R',
                         OPERATION='ASSE',
                         MODELE = MOD[n],
                         ASSE=_F(GROUP_MA=list_group_ma[n+1],
                                CHAM_GD = CH_EVAL,
                                NOM_CMP = ('X1','X2'),
                                NOM_CMP_RESU = ('DX','DY'),
                         ),);

    DEPL_IN=CREA_CHAMP(INFO=1,
                      TYPE_CHAM='NOEU_DEPL_R',
                      OPERATION='ASSE',
                      MODELE=MOD[n],

                      ASSE=(_F(TOUT='OUI',
                               CHAM_GD=CHPNUL,),
                            _F(GROUP_MA=GrMa,
                               CHAM_GD=INIDEP,
                               CUMUL='OUI',
                               COEF_R=1.0),
                            _F(GROUP_MA=list_group_ma[n+1],
                               CHAM_GD=CH_DEPL,
                               CUMUL='NON',
                               COEF_R=1.0,),
                               ),);

    INISIG=CREA_CHAMP(INFO=1,
                      TYPE_CHAM='ELGA_SIEF_R',
                      OPERATION='ASSE',
                      MODELE=MOD[n],
                      PROL_ZERO='OUI',
                      ASSE=(_F(GROUP_MA=list_group_ma[n+1],
                               CHAM_GD=SIEF,
                               CUMUL='OUI',
                               COEF_R=1.0),
                            _F(GROUP_MA=list_group_ma[:n+1],
                               CHAM_GD=SIG[n-1],
                               CUMUL='OUI',
                               COEF_R=1.0),
                            ),);


    INIVAR=CREA_CHAMP(INFO=1,
                      TYPE_CHAM='ELGA_VARI_R',
                      OPERATION='ASSE',
                      MODELE=MOD[n],
                      PROL_ZERO='OUI',
                      ASSE=_F(GROUP_MA=list_group_ma[:n+1],
                              CHAM_GD=VAR[n-1],
                              CUMUL='OUI',
                              COEF_R=1.0,),);

    t_init=(n+1)*1.E6
    t_fin =(n+2)*1.E6

# On utilise une valeur de critere lache pour commencer a appliquer le
#   poids car la precision s ameliore ensuite

    U[n]=STAT_NON_LINE(MODELE=MOD[n],
                 CHAM_MATER=AFFMAT2,
                 EXCIT=(_F(CHARGE=PHAUT),
                        _F(CHARGE=CHPAR),
                        _F(CHARGE=CHLAT),
                        _F(CHARGE=PESBAS,),
                        _F(CHARGE=PESHAU, FONC_MULT=FONCH,),),
                 COMPORTEMENT=(_F(RELATION='KIT_HM',
                               ITER_INTE_PAS=-10,
                               RELATION_KIT=('ELAS','LIQU_SATU','HYDR_UTIL'),
                               GROUP_MA=list_group_ma[0]),
                            _F(ITER_INTE_MAXI=50,
                               ITER_INTE_PAS=-5,
                               RESI_INTE_RELA=1E-8,
                               ALGO_INTE='SPECIFIQUE',
                               RELATION='KIT_HM',
                               RELATION_KIT=('HUJEUX','LIQU_SATU','HYDR_UTIL'),
                               GROUP_MA=list_group_ma[1:n+2]),),
                 ETAT_INIT=_F(DEPL=DEPL_IN,
                              SIGM=INISIG,
                              VARI=INIVAR),
                 INCREMENT=_F(LIST_INST=DEFLISTT,
                              INST_INIT=t_init,
                              INST_FIN=t_fin,),
                 NEWTON=_F(MATRICE='TANGENTE',
                           REAC_ITER=1),
                 SOLVEUR=_F(METHODE='MUMPS',),
                 CONVERGENCE=_F(ITER_GLOB_MAXI=13,
                                RESI_GLOB_RELA=1E-12,),);

    DEP[n]=CREA_CHAMP(TYPE_CHAM='NOEU_DEPL_R',
                      OPERATION='EXTR',
                      RESULTAT=U[n],
                      NOM_CHAM='DEPL',
                      INST = t_fin,
                      INFO=1,);

    SIG[n]=CREA_CHAMP(TYPE_CHAM='ELGA_SIEF_R',
                      OPERATION='EXTR',
                      RESULTAT=U[n],
                      NOM_CHAM='SIEF_ELGA',
                      INST = t_fin,
                      INFO=1,);

    VAR[n]=CREA_CHAMP(TYPE_CHAM='ELGA_VARI_R',
                OPERATION='EXTR',
                RESULTAT=U[n],
                NOM_CHAM='VARI_ELGA',
                INST = t_fin,
                INFO=1,);

    U[n]=CALC_CHAMP(reuse=U[n],
                    GROUP_MA=list_group_ma[:n+2],
                    CONTRAINTE=('SIGM_ELNO'),
                    VARI_INTERNE=('VARI_ELNO'),
                    RESULTAT=U[n],);

    DETRUIRE(INFO=1,CONCEPT=_F(NOM=(INIVAR,INISIG,INIDEP,DEPL_PJ,FX,FY,
                             CH_FONC,CH_EVAL,DEPL_IN,CH_GEOM,DXN,DYN,
                             CH_DEPL,CH_BID,FONCH,MAT1_f,PESHAU,PESBAS,
                             AFFMAT2),),);

#    IMPR_RESU(RESU=_F(CHAM_GD=DEP[n]));
#    IMPR_RESU(RESU=_F(CHAM_GD=VAR[n]));
#    IMPR_RESU(RESU=_F(CHAM_GD=SIG[n]));

# <--10: fin boucle for

DETRUIRE(INFO=1,
         CONCEPT=_F(NOM=(CHLAT,PHAUT,CHPAR,SIEF,),),);

PESA=AFFE_CHAR_MECA(MODELE=MOD[9],
                   PESANTEUR=_F(GRAVITE=9.81,
                                DIRECTION=(0.0,-1.0,0.0),),);
# Deplacements lateraux nuls
CHLAT=AFFE_CHAR_MECA(INFO=1,
                     MODELE=MOD[9],
                     DDL_IMPO=_F(GROUP_MA=('GA10','DR10',), DX=0.0),);

# Pression hydraulique nulle en haut de la couche posee (numero n)
PHAUT=AFFE_CHAR_MECA(INFO=1,
                     MODELE=MOD[9],
                     DDL_IMPO=_F(GROUP_NO='FREESURF', PRE1=0.0,),);

# Deplacement vertical nul a la base
CHPAR=AFFE_CHAR_MECA(MODELE=MOD[9],
                     DDL_IMPO=_F(GROUP_MA='BAS', DY=0.0,),);

# Deplacement horizontal nul a la base
NORIGID=AFFE_CHAR_MECA(MODELE=MOD[9],
                     DDL_IMPO=_F(GROUP_MA='BAS', DX=0.0,),);

# Deplacement horizontal solidaire a la base
BO_CONH0=AFFE_CHAR_MECA(MODELE=MOD[9],
                       LIAISON_UNIF=_F(GROUP_NO='BAS', DDL='DX'),);

BO_CONH1=AFFE_CHAR_MECA(MODELE=MOD[9],
                       LIAISON_GROUP=(_F(GROUP_NO_1='LAT_LEFT',
                                    GROUP_NO_2='LAT_RIGH',
                                    DDL_1=('DX',),
                                    DDL_2=('DX',),
                                    COEF_MULT_1 = 1.,
                                    COEF_MULT_2 = -1.,
                                    COEF_IMPO = 0.,),
                                 _F(GROUP_NO_1='LAT_LEFT',
                                    GROUP_NO_2='LAT_RIGH',
                                    DDL_1=('DY',),
                                    DDL_2=('DY',),
                                    COEF_MULT_1 = 1.,
                                    COEF_MULT_2 = -1.,
                                    COEF_IMPO = 0.,),),);

TI_LI_IN=DEFI_LIST_REEL(DEBUT=-1.e+2,
                        INTERVALLE=_F(JUSQU_A=0., NOMBRE=1,),);


DEFLIST3 =DEFI_LIST_INST(DEFI_LIST=_F(LIST_INST = TI_LI_IN),
                        ECHEC=_F(ACTION        = 'DECOUPE',
                                 SUBD_METHODE  = 'MANUEL',
                                 SUBD_PAS=10,
                                 SUBD_NIVEAU=10,),)

U9B=STAT_NON_LINE(MODELE=MOD[9],
                 CHAM_MATER=AFFMAT1,
                 EXCIT=(_F(CHARGE=NORIGID),
                        _F(CHARGE=PHAUT),
                        _F(CHARGE=CHPAR),
                        _F(CHARGE=BO_CONH1),
                        _F(CHARGE=PESA,),),
                 COMPORTEMENT=(_F(RELATION='KIT_HM',
                               ITER_INTE_PAS=-10,
                               RELATION_KIT=('ELAS','LIQU_SATU','HYDR_UTIL'),
                               GROUP_MA=list_group_ma[0]),
                            _F(ITER_INTE_MAXI=50,
                               ITER_INTE_PAS=-5,
                               RESI_INTE_RELA=1E-8,
                               RELATION='KIT_HM',
                               ALGO_INTE='SPECIFIQUE',
                               RELATION_KIT=('HUJEUX','LIQU_SATU','HYDR_UTIL'),
                               GROUP_MA=list_group_ma[1:nbcouche]),
                            ),
                 SOLVEUR=_F(RENUM='METIS',
                            STOP_SINGULIER='NON',
                            METHODE='MULT_FRONT',
                            NPREC=15,),
                 ETAT_INIT=_F(DEPL=DEP[9],
                              SIGM=SIG[9],
                              VARI=VAR[9]),
                 INCREMENT=_F(LIST_INST=DEFLIST3,),
                 NEWTON=_F(MATRICE='TANGENTE',
                           REAC_ITER=1),
                 CONVERGENCE=_F(ITER_GLOB_MAXI=12,
                                RESI_GLOB_RELA=1.E-10));

MONOX=AFFE_CHAR_MECA(MODELE=MOD[nbcouche-2],
                   PESANTEUR=_F(GRAVITE=1.0,
                                DIRECTION=(-1.0,0.0,0.0),),);


# SEISMIC SIGNAL Friuli_GEFDYN : FONC_MULT=ACCELE
INCLUDE(UNITE=90, INFO=1,);


T000 = 0.;
#T_END = 4. ;
#T_END = 3.15 ;
T_END = 2.9 ;
pas_gro = 0.0100;
pas_hfin = pas_gro/21. ;

# Instant list devoted to seism

L_INSTh=DEFI_LIST_REEL(DEBUT=T000,
                       INTERVALLE=(_F(JUSQU_A=T_END, PAS=pas_hfin,),),);

L_ARCH=DEFI_LIST_REEL(DEBUT=T000,
                      INTERVALLE=_F(JUSQU_A=T_END, PAS=pas_gro,),);

L_COMB=DEFI_LIST_REEL(DEBUT=T000,
                      INTERVALLE=_F(JUSQU_A=T_END, PAS=pas_gro,),);

DEFLISTh =DEFI_LIST_INST(DEFI_LIST=_F(LIST_INST =L_INSTh ),
                        ECHEC=_F(ACTION        = 'DECOUPE',
                                 SUBD_METHODE  = 'MANUEL',
                                 SUBD_PAS=2,
                                 SUBD_NIVEAU=20),)

U9B=DYNA_NON_LINE(reuse=U9B,
                 MODELE=MOD[9],
                 CHAM_MATER=AFFMAT1,
                 EXCIT=(_F(CHARGE=PHAUT),
                        _F(CHARGE=CHPAR),
                        _F(CHARGE=BO_CONH0),
                        _F(CHARGE=BO_CONH1),
                        _F(CHARGE=PESA,),
                        _F(CHARGE=MONOX, FONC_MULT=ACCELE,),),
                 COMPORTEMENT=(_F(RELATION='KIT_HM',
                               ITER_INTE_PAS=-10,
                               RELATION_KIT=('ELAS','LIQU_SATU','HYDR_UTIL'),
                               GROUP_MA=list_group_ma[0]),
                            _F(ITER_INTE_MAXI=50,
                               ITER_INTE_PAS=-5,
                               RESI_INTE_RELA=1E-8,
                               RELATION='KIT_HM',
                               ALGO_INTE='SPECIFIQUE',
                               RELATION_KIT=('HUJEUX','LIQU_SATU','HYDR_UTIL'),
                               GROUP_MA=list_group_ma[1:nbcouche]),
                             ),
                 NEWTON=_F(MATR_RIGI_SYME='OUI',),
                 SOLVEUR=_F(RENUM='METIS',
                            METHODE='MUMPS',),
                 ETAT_INIT=_F(EVOL_NOLI=U9B,
                              INST=0.0,PRECISION=1.E-6,
                              ),
                 INCREMENT=_F(LIST_INST=DEFLISTh,
                              PRECISION=1.E-6,),
                 ARCHIVAGE=_F(LIST_INST=L_ARCH,),

                 SCHEMA_TEMPS=_F(SCHEMA='TCHAMWA',
                                 COEF_MASS_SHIFT=2.E-5,
                                 FORMULATION='ACCELERATION',
                                 PHI=1.17,
                                 STOP_CFL='NON',),
               );

ACCR1X=RECU_FONCTION(RESULTAT=U9B,
                      TITRE='ACC_R1X',
                      NOM_CHAM='ACCE',
                      NOM_CMP='DX',
                      NOEUD='N1',
                      LIST_INST=L_COMB,
                      PROL_DROITE='CONSTANT',
                      PROL_GAUCHE='CONSTANT',
                      INTERPOL='LIN',);

ACCR47X=RECU_FONCTION( RESULTAT=U9B,
                        TITRE='ACC_R47X',
                        NOM_CHAM='ACCE',
                        NOM_CMP='DX',
                        NOEUD='N47',
                        LIST_INST=L_COMB,
                        PROL_DROITE='CONSTANT',
                        PROL_GAUCHE='CONSTANT',
                        INTERPOL='LIN',);


ACCA1X=CALC_FONCTION(LIST_PARA=L_COMB,
                      COMB=(_F(FONCTION = ACCR1X,COEF = 1.),
                            _F(FONCTION = ACCELE, COEF = 1.),),);

ACCA47X=CALC_FONCTION(LIST_PARA=L_COMB,
                       COMB=(_F(FONCTION = ACCR47X,COEF = 1.),
                             _F(FONCTION = ACCELE,  COEF = 1.),),);


TABINF1 = INFO_FONCTION(RMS = _F(FONCTION = ACCA47X,
                                  INST_INIT=2.80,
                                  INST_FIN =2.88,),);

## TABINF2 = INFO_FONCTION(RMS = _F(FONCTION = ACCA47X,
##                                   INST_INIT=3.06,
##                                   INST_FIN =3.14,),);


## TABINF3 = INFO_FONCTION(RMS = _F(FONCTION = ACCA47X,
##                                   INST_INIT=3.47,
##                                   INST_FIN =3.55,),);

# Les valeurs de reference correspondent a un calcul avec
# une modelisation "d_plan_hm" avec un maillage raffine
# en supposant que ce calcul est suffisamment precis.
TEST_TABLE(REFERENCE='AUTRE_ASTER',
           PRECISION=6.E-2,
           TOLE_MACHINE=3.e-4, # On ne sait pas pourquoi ...
           VALE_REFE=1.8911159616941,
           VALE_CALC=1.99722909399,
           NOM_PARA='RMS',
           TABLE=TABINF1,);

## TEST_TABLE(REFERENCE='AUTRE_ASTER',
##            PRECISION=3.E-2,
##            VALE_CALC=1.239536938699,
##            VALE_REFE=1.2720251632847,
##            NOM_PARA='RMS',
##            TABLE=TABINF2,);

## TEST_TABLE(REFERENCE='AUTRE_ASTER',
##            PRECISION=4.E-2,
##            VALE_CALC=2.3286676046922,
##            VALE_REFE=2.2606715577498,
##            NOM_PARA='RMS',
##            TABLE=TABINF3,);

## SPOSCI = CALC_FONCTION(INFO=2,
##                        SPEC_OSCI=_F(FONCTION=ACCA47X, NORME=9.81,),);
##
## MAXSP = INFO_FONCTION(MAX=_F(FONCTION = SPOSCI,),);
##
## TEST_FONCTION(VALEUR=_F(VALE_CALC=0.87475952,
##                         VALE_REFE=0.88645291,
##                         VALE_PARA=(0.02, 2.5),
##                         REFERENCE='AUTRE_ASTER',
##                         #TOLE_MACHINE=1e-3,
##                         PRECISION=1.5E-2,
##                         NOM_PARA=('AMOR', 'FREQ'),
##                         FONCTION=SPOSCI,),
##               ATTRIBUT=(_F(REFERENCE='ANALYTIQUE',
##                            PARA=0.02,
##                            ATTR_REFE='FREQ',
##                            FONCTION=SPOSCI,
##                            ATTR='NOM_PARA_FONC',),
##                         _F(REFERENCE='ANALYTIQUE',
##                            ATTR_REFE='AMOR',
##                            FONCTION=SPOSCI,
##                            ATTR='NOM_PARA',),
##                         ),);

FIN( );
