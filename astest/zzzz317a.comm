# TITRE GENERATION DE SIGNAUX SISMIQUES OPTION DSP, CAS SEPARABLE
# ======================================================================
# COPYRIGHT (C) 1991 - 2013  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY  
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY  
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR     
# (AT YOUR OPTION) ANY LATER VERSION.                                                    
#                                                                       
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT   
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF            
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU      
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.                              
#                                                                       
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE     
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,         
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.        
# ======================================================================
# person_in_charge: irmela.zentner at edf.fr 
DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON'))
#
#
from math import pi,sqrt,log,exp, ceil
import numpy as NP
###############################################
DT=0.01
NBPO=2**10
frr=2.0
amor=0.6
wg=frr*2.*pi
ecart=5.
#################################################
#
######################################################
# A : SIMULATION POUR DSP SEPARABLE (FREQ FOND CONST)
######################################################
#
#################################################
TSM=8.0
t_ini=0.5
arias =0.05#(en g)
ecart=1.0/9.81 #(en g)
pga=0.2  #(en g)
#
#Attention: ces valeurs sont les moyennes utilisees pour la simulation
# - on peut faire des tests de non regression pour une realisation
# - on teste les moyennes pour le cas TYPE=   "CONST"
#
##############################
# OPTION "JH"
##############################
#  ARIAS
#####
ACCE1a=GENE_ACCE_SEISME( INFO =2,  INIT_ALEA=100000,
              PAS_INST       =DT, PESANTEUR =9.81,DUREE_PHASE_FORTE = TSM,
              DSP        = _F(AMOR_REDUIT  = amor,FREQ_FOND =frr,),
              MODULATION = _F(TYPE = "JENNINGS_HOUSNER",  INTE_ARIAS=arias),),

FONCT1=RECU_FONCTION( TABLE=ACCE1a,
                              FILTRE=_F(  NOM_PARA = 'NUME_ORDRE',
                                       VALE_I = 1),
                              NOM_PARA_TABL='FONCTION',)

RMS1=INFO_FONCTION( ECART_TYPE=_F(  FONCTION = FONCT1))

N1_intea=INFO_FONCTION(  NOCI_SEISME=_F(OPTION='INTE_ARIAS',
                             FONCTION = FONCT1, PESANTEUR = 9.81,
                             ) )

N1_duree=INFO_FONCTION(  NOCI_SEISME=_F(OPTION='DUREE_PHAS_FORT',
                             FONCTION = FONCT1,
                             BORNE_SUP = 0.95,BORNE_INF = 0.05,
                             PESANTEUR = 9.81,
                            ) )

TEST_TABLE(
           VALE_CALC=0.0555427097231,
           NOM_PARA='INTE_ARIAS',
           TABLE=N1_intea,
           )

TEST_TABLE(
           VALE_CALC=7.34,
           NOM_PARA='DUREE_PHAS_FORT',
           TABLE=N1_duree,)

# ECART
########
ACCE1b=GENE_ACCE_SEISME(INFO = 2,  
              INIT_ALEA = 100000, NB_POIN = 2**10,
              PAS_INST  = DT, PESANTEUR = 9.81, DUREE_PHASE_FORTE = 10.,
              DSP        = _F(AMOR_REDUIT  = amor,FREQ_FOND = frr,),
              MODULATION = _F(TYPE = "JENNINGS_HOUSNER", ECART_TYPE = ecart),),


FONCT1b=RECU_FONCTION( TABLE=ACCE1b,
                              FILTRE=_F(  NOM_PARA = 'NUME_ORDRE',
                                       VALE_I = 1),
                              NOM_PARA_TABL='FONCTION',)

RMS1b=INFO_FONCTION( ECART_TYPE=_F(  FONCTION = FONCT1b))

TEST_TABLE(REFERENCE='ANALYTIQUE',
           PRECISION=0.10000000000000001,
           VALE_CALC=1.06441209604 ,
           VALE_REFE=ecart*9.81,
           NOM_PARA='ECART_TYPE',
           TABLE=RMS1b,)



##############################
# OPTION "GAMMA"
##############################
#  ARIAS
#########
ACCE3=GENE_ACCE_SEISME( INFO =2,INIT_ALEA=1000000,
              PAS_INST = DT, PESANTEUR = 9.81, DUREE_PHASE_FORTE = TSM,
              DSP         = _F(AMOR_REDUIT = amor, FREQ_FOND = frr,),
              MODULATION  = _F(TYPE =  "GAMMA",
                               INST_INI = t_ini, INTE_ARIAS = arias), )

FONCT3=RECU_FONCTION(TABLE=ACCE3,
                     FILTRE=_F(  NOM_PARA = 'NUME_ORDRE', VALE_I = 1),
                              NOM_PARA_TABL = 'FONCTION',)

N3_intea=INFO_FONCTION(  NOCI_SEISME=_F(
                         FONCTION = FONCT3, PESANTEUR = 9.81, OPTION = ('INTE_ARIAS') ))

N3_duree=INFO_FONCTION(  NOCI_SEISME=_F(
                         FONCTION = FONCT3, PESANTEUR = 9.81, OPTION = ('DUREE_PHAS_FORT') ))


RMS3=INFO_FONCTION( ECART_TYPE=_F(  FONCTION = FONCT3))
#

TEST_TABLE(
           VALE_CALC=0.0523908882612,
           NOM_PARA='INTE_ARIAS',
           TABLE=N3_intea,
           )

TEST_TABLE(
           VALE_CALC=7.13,
           NOM_PARA='DUREE_PHAS_FORT',
           TABLE=N3_duree,
           )

# ECART
########
ACCE3b=GENE_ACCE_SEISME( INFO =2, INIT_ALEA=10000,
              PAS_INST  = DT, NB_POIN = 2**10, PESANTEUR = 9.81, DUREE_PHASE_FORTE = TSM,
              DSP         = _F(AMOR_REDUIT  = amor, FREQ_FOND = frr,),
              MODULATION  = _F(TYPE = "GAMMA",
                               INST_INI = 0.5, ECART_TYPE = ecart),)

FONCT3b=RECU_FONCTION( TABLE=ACCE3b,
                       FILTRE=_F(  NOM_PARA = 'NUME_ORDRE', VALE_I = 1),
                      NOM_PARA_TABL='FONCTION',)

RMS3b=INFO_FONCTION(ECART_TYPE=_F(FONCTION = FONCT3b))


TEST_TABLE(VALE_CALC = 0.956076079023,
           NOM_PARA='ECART_TYPE',
           TABLE=RMS3b,)

#
##############################
# OPTION "CONSTANT"
##############################
# ECART
########
ACCE2a=GENE_ACCE_SEISME( INFO =2,
#        INIT_ALEA=100000,
              PAS_INST   = DT, PESANTEUR = 9.81, DUREE_PHASE_FORTE = TSM,
              DSP        = _F(AMOR_REDUIT = amor,FREQ_FOND = frr,),
              MODULATION = _F(TYPE = "CONSTANT", ECART_TYPE = ecart),)

FONCT2a=RECU_FONCTION(TABLE=ACCE2a,
                      FILTRE=_F(  NOM_PARA = 'NUME_ORDRE', VALE_I = 1),
                      NOM_PARA_TABL='FONCTION',)

RMS2a=INFO_FONCTION( ECART_TYPE=_F(  FONCTION = FONCT2a))

TEST_TABLE(REFERENCE='ANALYTIQUE',
           PRECISION=0.10000000000000001,
           VALE_CALC=1.01800184773,
           VALE_REFE=ecart*9.81,
           NOM_PARA='ECART_TYPE',
           TABLE=RMS2a,)


############################################
# TEST DE L INTERSPECTRE DES FCTS GENEREES
############################################
#
# discretisation temps et freq
Nsim=50
#courbe=[]
comp=1
FO2=[None]*(Nsim+1)
FOM=[None]*(Nsim+1)
iii=0
OM=pi/DT
FREQ_COUP=OM/2./pi
nbp=2**10  
TT=(nbp-1)*DT
fcp=0.001

#  ARIAS
############
ACCE2=GENE_ACCE_SEISME( INFO =2,INIT_ALEA=100000,
              PAS_INST  =DT, PESANTEUR = 9.81,DUREE_PHASE_FORTE = TT, 
              FREQ_FILTRE = fcp, 
              DSP         = _F(AMOR_REDUIT  =amor, FREQ_FOND = frr,),
              MODULATION  = _F(TYPE = "CONSTANT", INTE_ARIAS = arias),)

FONCT2=RECU_FONCTION(    TABLE=ACCE2,
                              FILTRE=_F(  NOM_PARA = 'NUME_ORDRE',
                                       VALE_I = 1),
                              NOM_PARA_TABL='FONCTION',)

N2_intea=INFO_FONCTION(  NOCI_SEISME=_F(
                             FONCTION = FONCT2, BORNE_SUP = 0.95,BORNE_INF = 0.05,
                             PESANTEUR = 9.81, OPTION = ('INTE_ARIAS')) )


RMS2=INFO_FONCTION( ECART_TYPE=_F(  FONCTION = FONCT2))

TEST_TABLE( VALE_CALC= 0.053589464031 ,
           NOM_PARA='INTE_ARIAS',
           TABLE=N2_intea, )

INTERS=CALC_INTE_SPEC( INST_INIT=0.0,
                       INST_FIN=TT, NB_POIN=nbp, FONCTION=( FONCT2 ),  )

FOM[iii]=RECU_FONCTION(INTE_SPEC=INTERS,NUME_ORDRE_I=1,),
DETRUIRE(CONCEPT=_F(NOM=(INTERS))) 

## --------------------------------
nbp=TT/DT+1
for iii in range(1, Nsim+1):
   print "RUN  ", iii+1
   VECT=GENE_ACCE_SEISME(
              PAS_INST = DT, PESANTEUR = 9.81, DUREE_PHASE_FORTE = TT, FREQ_CORNER = fcp,
              DSP        = _F(AMOR_REDUIT = amor, FREQ_FOND = frr,),
              MODULATION = _F(TYPE = "CONSTANT", INTE_ARIAS = arias),)

   TRI1=RECU_FONCTION( TABLE=VECT,
                       FILTRE=_F(  NOM_PARA = 'NUME_ORDRE', VALE_I = 1), NOM_PARA_TABL='FONCTION', )

   INTERS=CALC_INTE_SPEC( INST_INIT=0.0, INST_FIN=TT, NB_POIN=nbp, FONCTION=( TRI1 ), )

   FO2[iii]=RECU_FONCTION(INTE_SPEC=INTERS, NUME_ORDRE_I=1,)

   FOM[iii]=CALC_FONCTION(COMB=(_F( FONCTION = FOM[iii-1], COEF = 1.0),
                                _F( FONCTION = FO2[iii], COEF = 1.0),), )

   DETRUIRE(CONCEPT=_F(NOM=(VECT, INTERS)))
   DETRUIRE(CONCEPT=_F(NOM=(TRI1)))


FONCMF=CALC_FONCTION(  COMB=_F( FONCTION = FOM[iii],
                                    COEF = 1./Nsim), )

FONCMC=CALC_FONCTION(  COMB_C=_F( FONCTION = FONCMF,  COEF_C = 1.+0.j), )

DSP_M=DEFI_INTE_SPEC(    DIMENSION=1,PAR_FONCTION=(
                     _F(  NUME_ORDRE_I = 1,
                                    NUME_ORDRE_J = 1,
                                    FONCTION = FONCMC),  ))

POST_DSP=POST_DYNA_ALEA(INTERSPECTRE=_F(
                                    INTE_SPEC=DSP_M,
                                    OPTION='DIAG'));


##############################
# TEST DSP de  KT
##############################
#REFERENCE [ 0.00324168  0.00014989] (DSP CP)
#[  3.61724321e-03   1.48368417e-04   3.57812105e-05]
#[  3.61724321e-03   1.48368417e-04   3.57812105e-05]

TEST_FONCTION(VALEUR=(_F(VALE_CALC=1.311446340394E-04    ,
                         VALE_REFE=1.48368417e-04,
                         VALE_PARA=10.0,
                         REFERENCE='ANALYTIQUE',
                         PRECISION=0.25,
                         FONCTION=FONCMF,),
                      ),
              )
TEST_FONCTION(VALEUR=(_F(VALE_CALC=3.619808980733E-03,
                         VALE_REFE=3.61724321e-03,
                         VALE_PARA=1.0,
                         REFERENCE='ANALYTIQUE',
                         PRECISION=0.10000000000000001,
                         FONCTION=FONCMF,),
                         ),
                      ),
ecart0= 0.174711603824 # valeur theorique de la DSP cible
TEST_TABLE(REFERENCE='ANALYTIQUE',
           PRECISION=1.E-1,
           VALE_CALC=0.174217406746  ,
           VALE_REFE=ecart0,
           NOM_PARA='ECART',
           TABLE=POST_DSP,
           FILTRE=(_F(NOM_PARA='NUME_ORDRE_I',
                      VALE_I=1,),
                   _F(NOM_PARA='NUME_ORDRE_J',
                      VALE_I=1,),
                   ),
           )

#

#
FIN( )
