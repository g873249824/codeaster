# person_in_charge: mohamed.torkhani at edf.fr
# ======================================================================
# COPYRIGHT (C) 1991 - 2016  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY  
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY  
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR     
# (AT YOUR OPTION) ANY LATER VERSION.                                                    
#                                                                       
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT   
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF            
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU      
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.                              
#                                                                       
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE     
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,         
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.        
# ======================================================================
# CAS_TEST__:SDLL125A
#
import numpy as NP

DEBUT(CODE=_F(NIV_PUB_WEB='INTERNET',VISU_EFICAS='NON'),
      DEBUG=_F(SDVERI='OUI'),);

mail=LIRE_MAILLAGE();

# ---------------------
# DEFINITION DU MATERIAU
# ---------------------
acier=DEFI_MATERIAU(ELAS=_F(E=2.e11,
                            NU=0.3,
                            RHO=7800,),);

# ---------------------
# AFFECTATION DU MODELE
# ---------------------
modele=AFFE_MODELE(MAILLAGE=mail,
                   AFFE=(_F(GROUP_MA='ROTOR',
                            PHENOMENE='MECANIQUE',
                            MODELISATION='POU_D_T',),
                         _F(GROUP_MA=('DISQ1','DISQ2','PALIER1','PALIER2'),
                            PHENOMENE='MECANIQUE',
                            MODELISATION='DIS_TR',),),);

# -----------------------
# AFFECTATION DU MATERIAU
# -----------------------
chmat=AFFE_MATERIAU(MAILLAGE=mail,
                    AFFE=_F(GROUP_MA='ROTOR',
                            MATER=acier,),);

# --------------------------------
# DEF DES SECTIONS et des RAIDEURS
# --------------------------------
cara=AFFE_CARA_ELEM(MODELE=modele,
                    POUTRE=(_F(GROUP_MA='SA1',
                              SECTION='CERCLE',
                              CARA='R',
                              VALE=0.02,),
                            _F(GROUP_MA='SA2',
                              SECTION='CERCLE',
                              CARA=('R','EP'),
                              VALE=(0.035,0.03,),),
                            _F(GROUP_MA='SA3',
                              SECTION='CERCLE',
                              CARA=('R','EP'),
                              VALE=(0.02,0.015,),),),
                    DISCRET=(_F(CARA='M_TR_D_N',
                                GROUP_MA='DISQ1',
                                REPERE='LOCAL',
                                VALE=(3.50E+00,7.00E-03, 
                                3.50E-03,3.50E-03,0,0,0,0,0,0,),),
                             _F(CARA='K_TR_D_N',
                                GROUP_MA='DISQ1',
                                REPERE='LOCAL',
                                VALE=(0,0,0,0,0,0,),),
                             _F(CARA='A_TR_D_N',
                                GROUP_MA='DISQ1',
                                REPERE='LOCAL',
                                VALE=(0,0,0,0,0,0,),),
                             _F(CARA='M_TR_D_N',
                                GROUP_MA='DISQ2',
                                REPERE='LOCAL',
                                VALE=(3.00E+00,6.00E-03, 
                                3.00E-03,3.00E-03,0,0,0,0,0,0,),),
                             _F(GROUP_MA='PALIER1',
                                   CARA='K_TR_N',
                                   SYME='NON',
                                   VALE = ( 1.0E8,   -1.0E7,   0.,   0.,   0.,   0.,  -6.0E7,   8.0E7,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,),),
                             _F(GROUP_MA='PALIER1',
                                   CARA='A_TR_N',
                                   SYME='NON',
                                   VALE = ( 1.2E4,   -3.0E3,   0.,   0.,   0.,   0.,  -3.0E3,   8.0E3,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,),),
                             _F(GROUP_MA='PALIER2',
                                   CARA='K_TR_N',
                                   SYME='NON',
                                   VALE = ( 7.0E7,   -2.0E6,   0.,   0.,   0.,   0.,  -4.0E7,   5.0E7,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,),),
                             _F(GROUP_MA='PALIER2',
                                   CARA='A_TR_N',
                                   SYME='NON',
                                   VALE = ( 8.0E3,   -1.5E3,   0.,   0.,   0.,   0.,  -1.5E3,   6.0E3,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,
                                   0.,   0.,   0.,   0.,   0.,   0.,),),
                           ),
                      ORIENTATION=_F(GROUP_MA=('DISQ1','DISQ2'),
                                      CARA='ANGL_NAUT',
                                      VALE=(0.,-90.,0.,),),
                        );

# ------------------
# CONDITIONS AUX LIMITES
# ------------------
blocage=AFFE_CHAR_MECA(MODELE=modele,
                        DDL_IMPO=(_F(GROUP_NO=('PALIER1',),
                                     DZ=0,
                                     ),))
                                    
# --------------------------------
#MATRICES ASSEMBLEES K, M
# --------------------------------
ASSEMBLAGE(MODELE=modele,
                CHAM_MATER=chmat,
                CARA_ELEM=cara,
                CHARGE=blocage,
                NUME_DDL=CO('NUMEDDL'),
                MATR_ASSE=(_F(MATRICE=CO('RIGIDITE'),
                              OPTION='RIGI_MECA',),
                           _F(MATRICE=CO('MASSE'),
                              OPTION='MASS_MECA',),
                           _F(MATRICE=CO('AMOR'),
                              OPTION='AMOR_MECA',),),);
                              
              

GYELEM=CALC_MATR_ELEM(OPTION='MECA_GYRO',
                      MODELE=modele,
                      CHAM_MATER=chmat,
                      CARA_ELEM=cara,);

GYASS=ASSE_MATRICE(MATR_ELEM=GYELEM,
                   NUME_DDL=NUMEDDL,);

DEBV=1E-12;
FINV=60000;
PASV = 5000.0;
VIT=NP.arange(DEBV,FINV+1,PASV);
nbF=14;
nbF_camp=10;
nbV=len(VIT);

# --------------------------------------------------------------
# APPEL MACRO DE CALCUL DES FREQUENCES ET DES MODES EN ROTATION
# --------------------------------------------------------------

L_VITROT=[VIT[ii]*pi/30. for ii in range(nbV)];
Methode = 'QZ'
#Methode = 'SORENSEN'

l_mod=CALC_MODE_ROTATION(MATR_RIGI =RIGIDITE,
                 MATR_MASS   =MASSE, 
                 MATR_AMOR=AMOR, 
                 MATR_GYRO =GYASS, 
                 VITE_ROTA =L_VITROT,
                 METHODE  =Methode,
                 CALC_FREQ=_F(OPTION='PLUS_PETITE',NMAX_FREQ=nbF),
                 VERI_MODE=_F(STOP_ERREUR='NON',
                              SEUIL=5.9999999999999995E-02));

IMPR_TABLE(TABLE=l_mod);

lmod=[None]*nbV
for ii in range(0,nbV):
   lmod[ii]=EXTR_TABLE(TYPE_RESU='MODE_MECA',
                       TABLE=l_mod,
                       NOM_PARA='NOM_SD',
                       FILTRE=_F(NOM_PARA='NUME_VITE',VALE_I=ii),);
   IMPR_RESU(FORMAT='RESULTAT',
             RESU=_F(RESULTAT=lmod[ii],
                     NOM_PARA=('NUME_MODE','FREQ','OMEGA2'),
                     FORM_TABL='OUI'),)

#VITESSE DE ROTATION OMEGA=0
TEST_RESU(RESU=(_F(NUME_ORDRE=1,
                   PARA='FREQ',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_0,
                   VALE_CALC=216.087144913,
                   VALE_REFE=216.21000000000001,
                   CRITERE='RELATIF',
                   PRECISION=1.E-3,),
                _F(NUME_ORDRE=1,
                   PARA='AMOR_REDUIT',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_0,
                   VALE_CALC=0.047696156,
                   VALE_REFE=0.047697000000000003,
                   CRITERE='RELATIF',
                   PRECISION=1.E-3,),
                _F(NUME_ORDRE=2,
                   PARA='FREQ',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_0,
                   VALE_CALC=263.398074875,
                   VALE_REFE=263.52100000000002,
                   CRITERE='RELATIF',
                   PRECISION=1.E-3,),
                _F(NUME_ORDRE=2,
                   PARA='AMOR_REDUIT',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_0,
                   VALE_CALC=0.078395680,
                   VALE_REFE=0.078851000000000004,
                   CRITERE='RELATIF',
                   PRECISION=6.0000000000000001E-3,),
                _F(NUME_ORDRE=3,
                   PARA='FREQ',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_0,
                   VALE_CALC=382.969162663,
                   VALE_REFE=383.20999999999998,
                   CRITERE='RELATIF',
                   PRECISION=1.E-3,),
                _F(NUME_ORDRE=3,
                   PARA='AMOR_REDUIT',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_0,
                   VALE_CALC=0.050785019,
                   VALE_REFE=0.050144000000000001,
                   CRITERE='RELATIF',
                   PRECISION=0.014,),
                _F(NUME_ORDRE=4,
                   PARA='FREQ',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_0,
                   VALE_CALC=439.434018997,
                   VALE_REFE=439.63999999999999,
                   CRITERE='RELATIF',
                   PRECISION=1.E-3,),
                _F(NUME_ORDRE=4,
                   PARA='AMOR_REDUIT',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_0,
                   VALE_CALC=0.059554176,
                   VALE_REFE=0.060227000000000003,
                   CRITERE='RELATIF',
                   PRECISION=0.012,),
                _F(NUME_ORDRE=5,
                   PARA='FREQ',
                   RESULTAT=lmod_0,
                   VALE_CALC=749.06802060366,
                   CRITERE='RELATIF',
                   ),
                _F(NUME_ORDRE=5,
                   PARA='AMOR_REDUIT',
                   RESULTAT=lmod_0,
                   VALE_CALC=0.0,
                   CRITERE='ABSOLU',
                   ),
                _F(NUME_ORDRE=10,
                   PARA='FREQ',
                   RESULTAT=lmod_0,
                   VALE_CALC=2506.2171409091,
                   CRITERE='RELATIF',
                   ),
                _F(NUME_ORDRE=10,
                   PARA='AMOR_REDUIT',
                   RESULTAT=lmod_0,
                   VALE_CALC=0.0,
                   CRITERE='ABSOLU',
                   ),
                ),
          )

#VITESSE DE ROTATION OMEGA=60000
TEST_RESU(RESU=(_F(NUME_ORDRE=1,
                   PARA='FREQ',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_12,
                   VALE_CALC=185.203539662,
                   VALE_REFE=185.37,
                   CRITERE='RELATIF',
                   PRECISION=1.E-3,),
                _F(NUME_ORDRE=1,
                   PARA='AMOR_REDUIT',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_12,
                   VALE_CALC=-0.051675779,
                   VALE_REFE=-0.051713000000000002,
                   CRITERE='RELATIF',
                   PRECISION=1.1000000000000001E-3,),
                _F(NUME_ORDRE=2,
                   PARA='FREQ',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_12,
                   VALE_CALC=295.994061666,
                   VALE_REFE=296.01999999999998,
                   CRITERE='RELATIF',
                   PRECISION=1.E-3,),
                _F(NUME_ORDRE=2,
                   PARA='AMOR_REDUIT',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_12,
                   VALE_CALC=0.154962090,
                   VALE_REFE=0.15570999999999999,
                   CRITERE='RELATIF',
                   PRECISION=5.0000000000000001E-3,),
                _F(NUME_ORDRE=3,
                   PARA='FREQ',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_12,
                   VALE_CALC=324.479031355,
                   VALE_REFE=324.72000000000003,
                   CRITERE='RELATIF',
                   PRECISION=1.E-3,),
                _F(NUME_ORDRE=3,
                   PARA='AMOR_REDUIT',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_12,
                   VALE_CALC= 1.66602434E-03,
                   VALE_REFE=1.5749E-3,
                   CRITERE='RELATIF',
                   PRECISION=0.070000000000000007,),
                _F(NUME_ORDRE=4,
                   PARA='FREQ',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_12,
                   VALE_CALC=472.822882943,
                   VALE_REFE=472.54000000000002,
                   CRITERE='RELATIF',
                   PRECISION=1.1999999999999999E-3,),
                _F(NUME_ORDRE=4,
                   PARA='AMOR_REDUIT',
                   REFERENCE='SOURCE_EXTERNE',
                   RESULTAT=lmod_12,
                   VALE_CALC=0.159291300,
                   VALE_REFE=0.15967999999999999,
                   CRITERE='RELATIF',
                   PRECISION=3.0000000000000001E-3,),
                _F(NUME_ORDRE=5,
                   PARA='FREQ',
                   RESULTAT=lmod_12,
                   VALE_CALC=749.06799999999998,
                   CRITERE='RELATIF',
                   ),
                _F(NUME_ORDRE=5,
                   PARA='AMOR_REDUIT',
                   RESULTAT=lmod_12,
                   VALE_CALC=0.0,
                   CRITERE='ABSOLU',
                   ),
                _F(NUME_ORDRE=9,
                   PARA='FREQ',
                   RESULTAT=lmod_12,
                   VALE_CALC=2506.2171409569,
                   CRITERE='RELATIF',
                   ),
                _F(NUME_ORDRE=9,
                   PARA='AMOR_REDUIT',
                   RESULTAT=lmod_12,
                   VALE_CALC=0.0,
                   CRITERE='ABSOLU',
                   ),
                ),
          )

#TYPE DE PRECESSION (1 SOMME, 2 PLUS GRANDE ORBITE)
typ_prec =1
#TYPE DE SUIVI, (0 SANS_TRI, 1 TRI_PREC, 2 TRI_FORM_MOD)
typ_tri=2

# UNITES DES FICHIERS DE SORTIE DES TRACES
unit_fle = 29;
unit_tor = 28; 
uniy_lon = 27;
unit_tot = 26;
unit_int = 25;

L_S=[1.0, 1.0];
# ---------------------------------------------------
# APPEL MACRO PERMETTANT DE TRACER LE DIAGRAMME DE CAMPBELL
# ---------------------------------------------------
IMPR_DIAG_CAMPBELL(MAILLAGE   =mail, 
                 MODES      =l_mod,
                 NFREQ_CAMP =nbF_camp,
                 TYP_PREC   =typ_prec, 
                 TYP_TRI    =typ_tri,
                 UNIT_FLE   = unit_fle,
                 UNIT_TOR   = unit_tor, 
                 UNIT_LON   = uniy_lon, 
                 UNIT_TOT   = unit_tot,
                 UNIT_INT   = unit_int,
                 L_S        = L_S);

FIN();
