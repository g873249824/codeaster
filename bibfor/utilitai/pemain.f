      SUBROUTINE PEMAIN(RESU,MODELE,MATE,CARA,NCHAR,LCHAR,NH,NBOCC,
     &                  DEFORM)
      IMPLICIT   NONE
      INCLUDE 'jeveux.h'

      CHARACTER*32 JEXNOM
      INTEGER NCHAR,NH,NBOCC
      CHARACTER*(*) RESU,MODELE,MATE,CARA,LCHAR(*),DEFORM
C     ------------------------------------------------------------------
C            CONFIGURATION MANAGEMENT OF EDF VERSION
C MODIF UTILITAI  DATE 25/02/2013   AUTEUR SELLENET N.SELLENET 
C ======================================================================
C COPYRIGHT (C) 1991 - 2013  EDF R&D                  WWW.CODE-ASTER.ORG
C THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
C (AT YOUR OPTION) ANY LATER VERSION.

C THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
C WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
C MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
C GENERAL PUBLIC LICENSE FOR MORE DETAILS.

C YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
C ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
C    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
C ======================================================================
C     OPERATEUR   POST_ELEM
C     TRAITEMENT DU MOT CLE-FACTEUR "MASS_INER"
C     ------------------------------------------------------------------

      INTEGER MXVALE,NBPARR,IBID,IRET,LVALE,IOCC,NT,NG,NR,NM,NBGRMA,JGR,
     &        IG,NBMA,JAD,NBMAIL,JMA,IM,NUME,NB,IFM,NIV,MXVAL1,NBPAR1,
     &        MXVAL2,NBPAR2,IORIG,NRE,ICAGE
      PARAMETER (MXVAL1=16,NBPAR1=18)
      PARAMETER (MXVAL2=25,NBPAR2=27)
      REAL*8 ZERO,ORIG(3),R8B
      CHARACTER*8 K8B,NOMA,LPAIN(16),LPAOUT(5),TYPARR(NBPAR2),
     &            VALEK(2)
      CHARACTER*16 NOPARR(NBPAR2)
      CHARACTER*19 CHELEM,CHDEF
      CHARACTER*24 LCHIN(16),LCHOUT(1),MLGGMA,MLGNMA,VALE2(2)
      CHARACTER*24 CHGEOM,CHGEO2,CHCARA(18),CHHARM,LIGREL
      COMPLEX*16 C16B
      INTEGER      IARG

      DATA NOPARR/'LIEU','ENTITE','MASSE','CDG_X','CDG_Y','CDG_Z',
     &     'IX_G','IY_G','IZ_G','IXY_G','IXZ_G','IYZ_G','IX_PRIN_G',
     &     'IY_PRIN_G','IZ_PRIN_G','ALPHA','BETA','GAMMA','X_P','Y_P',
     &     'Z_P','IX_P','IY_P','IZ_P','IXY_P','IXZ_P','IYZ_P'/
      DATA TYPARR/'K24','K8','R','R','R','R','R','R','R','R','R','R',
     &     'R','R','R','R','R','R','R','R','R','R','R','R','R','R','R'/
C     ------------------------------------------------------------------

      CALL JEMARQ()

C --- RECUPERATION DU NIVEAU D'IMPRESSION
      CALL INFNIV(IFM,NIV)

      ICAGE = 0
      ZERO = 0.0D0
      R8B = 0.0D0
      CHDEF = DEFORM
      CALL MECHAM('MASS_INER',MODELE,CARA,NH,CHGEOM,CHCARA,CHHARM,IRET)
      IF (IRET.NE.0) GO TO 60
      NOMA = CHGEOM(1:8)
      MLGNMA = NOMA//'.NOMMAI'
      MLGGMA = NOMA//'.GROUPEMA'

      CALL EXLIM3('MASS_INER','V',MODELE,LIGREL)

C     --- CALCUL DE L'OPTION ---
      CHELEM = '&&PEMAIN.MASS_INER'
      LPAIN(1) = 'PGEOMER'
      IF (CHDEF.NE.' ') THEN
        CHGEO2 = '&&PEMAIN.CH_GEOMER'
        CALL VTGPLD('CUMU',CHGEOM,1.D0  ,CHDEF ,'V'   ,
     &              CHGEO2)
        LCHIN(1) = CHGEO2
      ELSE
        LCHIN(1) = CHGEOM
      END IF
      LPAIN(2) = 'PMATERC'
      LCHIN(2) = MATE
      LPAIN(3) = 'PCAORIE'
      LCHIN(3) = CHCARA(1)
      LPAIN(4) = 'PCADISM'
      LCHIN(4) = CHCARA(3)
      LPAIN(5) = 'PCAGNPO'
      LCHIN(5) = CHCARA(6)
      LPAIN(6) = 'PCACOQU'
      LCHIN(6) = CHCARA(7)
      LPAIN(7) = 'PCASECT'
      LCHIN(7) = CHCARA(8)
      LPAIN(8) = 'PCAARPO'
      LCHIN(8) = CHCARA(9)
      LPAIN(9) = 'PCAGNBA'
      LCHIN(9) = CHCARA(11)
      LPAIN(10) = 'PCAGEPO'
      LCHIN(10) = CHCARA(5)
      LPAIN(11)  = 'PNBSP_I'
      LCHIN(11)  = CHCARA(16)
      LPAIN(12)  = 'PFIBRES'
      LCHIN(12)  = CHCARA(17)
      LPAIN(13)  = 'PCOMPOR'
      LCHIN(13)  = MATE(1:8)//'.COMPOR'
      LPAIN(14)  = 'PCAPOUF'
      LCHIN(14)  = CHCARA(13)
      LPAIN(15)  = 'PCINFDI'
      LCHIN(15)  = CHCARA(15)
      NB = 15
      LPAOUT(1) = 'PMASSINE'
      LCHOUT(1) = CHELEM

      CALL CALCUL('S','MASS_INER',LIGREL,NB,LCHIN,LPAIN,1,LCHOUT,LPAOUT,
     &            'V','OUI')

      MXVALE = MXVAL1
      NBPARR = NBPAR1
      DO 10 IOCC = 1,NBOCC
        CALL GETVR8('MASS_INER','ORIG_INER',IOCC,IARG,0,R8B,NR)
        IF (NR.NE.0) THEN
          MXVALE = MXVAL2
          NBPARR = NBPAR2
          GO TO 20
        END IF
   10 CONTINUE
   20 CONTINUE

C     --- CREATION DE LA TABLE ---
      CALL TBCRSD(RESU,'G')
      CALL TBAJPA(RESU,NBPARR,NOPARR,TYPARR)

      CALL WKVECT('&&PEMAIN.TRAV1','V V R',MXVALE,LVALE)
      DO 50 IOCC = 1,NBOCC
        IORIG = 0
        ORIG(1) = ZERO
        ORIG(2) = ZERO
        ORIG(3) = ZERO
        CALL GETVTX('MASS_INER','TOUT',IOCC,IARG,0,K8B,NT)
        CALL GETVEM(NOMA,'GROUP_MA','MASS_INER','GROUP_MA',IOCC,IARG,0,
     &              K8B,
     &              NG)
        CALL GETVEM(NOMA,'MAILLE','MASS_INER','MAILLE',IOCC,IARG,0,K8B,
     &              NM)
        CALL GETVR8('MASS_INER','ORIG_INER',IOCC,IARG,0,R8B,NR)
        IF (NR.NE.0) THEN
          IORIG = 1
          NRE = -NR
          CALL GETVR8('MASS_INER','ORIG_INER',IOCC,IARG,NRE,ORIG,NR)
        END IF
        IF (NT.NE.0) THEN
          CALL PEMICA(CHELEM,MXVALE,ZR(LVALE),0,IBID,ORIG,IORIG,ICAGE)
          VALEK(1) = NOMA
          VALEK(2) = 'TOUT'
          CALL TBAJLI(RESU,NBPARR,NOPARR,IBID,ZR(LVALE),C16B,VALEK,0)
        END IF
        IF (NG.NE.0) THEN
          NBGRMA = -NG
          CALL WKVECT('&&PEMAIN_GROUPM','V V K24',NBGRMA,JGR)
          CALL GETVEM(NOMA,'GROUP_MA','MASS_INER','GROUP_MA',IOCC,IARG,
     &                NBGRMA,ZK24(JGR),NG)
          VALE2(2) = 'GROUP_MA'
          DO 30 IG = 1,NBGRMA
            CALL JEEXIN(JEXNOM(MLGGMA,ZK24(JGR+IG-1)),IRET)
            IF (IRET.EQ.0) THEN
              CALL U2MESK('A','UTILITAI3_46',1,ZK24(JGR+IG-1))
              GO TO 30
            END IF
            CALL JELIRA(JEXNOM(MLGGMA,ZK24(JGR+IG-1)),'LONUTI',NBMA,K8B)
            IF (NBMA.EQ.0) THEN
              CALL U2MESK('A','UTILITAI3_47',1,ZK24(JGR+IG-1))
              GO TO 30
            END IF
            CALL JEVEUO(JEXNOM(NOMA//'.GROUPEMA',
     &                  ZK24(JGR+IG-1)),'L',JAD)
            CALL PEMICA(CHELEM,MXVALE,ZR(LVALE),NBMA,ZI(JAD),ORIG,IORIG,
     &                  ICAGE)
            VALE2(1) = ZK24(JGR+IG-1)
            CALL TBAJLI(RESU,NBPARR,NOPARR,IBID,ZR(LVALE),C16B,VALE2,0)
   30     CONTINUE
          CALL JEDETR('&&PEMAIN_GROUPM')
        END IF
        IF (NM.NE.0) THEN
          NBMAIL = -NM
          CALL WKVECT('&&PEMAIN_MAILLE','V V K8',NBMAIL,JMA)
          CALL GETVEM(NOMA,'MAILLE','MASS_INER','MAILLE',IOCC,IARG,
     &                NBMAIL,
     &                ZK8(JMA),NM)
          VALEK(2) = 'MAILLE'
          DO 40 IM = 1,NBMAIL
            CALL JEEXIN(JEXNOM(MLGNMA,ZK8(JMA+IM-1)),IRET)
            IF (IRET.EQ.0) THEN
              CALL U2MESK('A','UTILITAI3_49',1,ZK8(JMA+IM-1))
              GO TO 40
            END IF
            CALL JENONU(JEXNOM(MLGNMA,ZK8(JMA+IM-1)),NUME)
            CALL PEMICA(CHELEM,MXVALE,ZR(LVALE),1,NUME,ORIG,IORIG,ICAGE)
            VALEK(1) = ZK8(JMA+IM-1)
            CALL TBAJLI(RESU,NBPARR,NOPARR,IBID,ZR(LVALE),C16B,VALEK,0)
   40     CONTINUE
          CALL JEDETR('&&PEMAIN_MAILLE')
        END IF
   50 CONTINUE

C --- MENAGE
      CALL DETRSD('CHAM_ELEM','&&PEMAIN.MASS_INER')
      CALL DETRSD('CHAMP_GD','&&PEMAIN.CH_GEOMER')
      CALL JEDETR('&&PEMAIN.TRAV1')

   60 CONTINUE

      CALL JEDEMA()
      END
