      SUBROUTINE MERIME(MODELZ,NCHAR,LCHAR,MATE,CARAZ,EXITIM,TIME,
     &                  COMPOR,MATELZ,NH,BASEZ)
      IMPLICIT NONE
      INCLUDE 'jeveux.h'
      INTEGER NCHAR,NH
      REAL*8 TIME
      CHARACTER*(*) MODELZ,CARAZ,MATELZ
      CHARACTER*8 MODELE,CARA
      CHARACTER*19 MATEL
      CHARACTER*(*) LCHAR(*),MATE,BASEZ,COMPOR
      CHARACTER*(1) BASE
      LOGICAL EXITIM
C ----------------------------------------------------------------------
C MODIF CALCULEL  DATE 03/07/2012   AUTEUR PELLET J.PELLET 
C ======================================================================
C            CONFIGURATION MANAGEMENT OF EDF VERSION
C COPYRIGHT (C) 1991 - 2012  EDF R&D                  WWW.CODE-ASTER.ORG
C THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
C (AT YOUR OPTION) ANY LATER VERSION.

C THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
C WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
C MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
C GENERAL PUBLIC LICENSE FOR MORE DETAILS.

C YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
C ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
C    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
C ======================================================================
C                          DE MERIME...  PROSPER YOUP-LA-BOUM!

C     CALCUL DES MATRICES ELEMENTAIRES DE RIGIDITE MECA

C ----------------------------------------------------------------------
C IN  : MODELZ : NOM DU MODELE
C IN  : NCHAR  : NOMBRE DE CHARGES
C IN  : LCHAR  : LISTE DES CHARGES
C IN  : MATE   : CARTE DE MATERIAU
C IN  : CARAZ  : CHAMP DE CARAC_ELEM
C IN  : MATELZ : NOM DU MATR_ELEM RESULTAT
C IN  : EXITIM : VRAI SI L'INSTANT EST DONNE
C IN  : TIME   : INSTANT DE CALCUL
C IN  : NH     : NUMERO D'HARMONIQUE DE FOURIER
C IN  : BASEZ  : NOM DE LA BASE
C IN  : COMPOR : COMPOR POUR LES MULTIFIBRE (POU_D_EM)
C ----------------------------------------------------------------------
C     ------------------------------------------------------------------
      CHARACTER*2 CODRET
      CHARACTER*8 LPAIN(32),LPAOUT(2),KBID
      CHARACTER*16 OPTION,NOMCMD,TYPRES
      CHARACTER*19 NOMFON,CHVARC
      CHARACTER*19 PINTTO,CNSETO,HEAVTO,LONCHA,BASLOC,LSN,LST,STANO
      CHARACTER*19 PMILTO,FISSNO,PINTER
      CHARACTER*24 LIGRMO,LIGRCH,LCHIN(32),LCHOUT(2)
      CHARACTER*24 CHGEOM,CHCARA(18),CHHARM
      CHARACTER*24 CHCHAR,ARGU,CHTIME
      COMPLEX*16 CBID
C-----------------------------------------------------------------------
      INTEGER IAREFE ,IBID ,ICHA ,ICODE ,IER ,ILIRES ,IRET 
      INTEGER IRET1 
C-----------------------------------------------------------------------
      DATA CHVARC/'&&MERIME.CH_VARC_R'/

      CALL JEMARQ()
      MODELE = MODELZ
      CALL ASSERT(MODELE.NE.' ')
      CARA = CARAZ
      MATEL = MATELZ
      BASE = BASEZ

      CALL GETRES(NOMFON,TYPRES,NOMCMD)
      OPTION = 'RIGI_MECA'
      CALL MECHAM(OPTION,MODELE,NCHAR,LCHAR,CARA,NH,CHGEOM,CHCARA,
     &            CHHARM,ICODE)

      CALL MECHPE(MODELE(1:8),NCHAR,LCHAR,CHCHAR)

      IF (.NOT.EXITIM) TIME = 0.D0
      CHTIME = '&&MERIME.CHAMP_INST'
      CALL MECACT('V',CHTIME,'MODELE',MODELE//'.MODELE','INST_R',1,
     &            'INST',IBID,TIME,CBID,KBID)


      IF (NOMCMD.EQ.'MECA_STATIQUE'.OR.NOMCMD.EQ.'CALC_MATR_ELEM') THEN
        CALL VRCINS(MODELE,MATE,CARA,TIME,CHVARC,CODRET)
      END IF


      CALL MEMARE(BASE,MATEL,MODELE,MATE,CARA,OPTION)
C     SI LA RIGIDITE EST CALCULEE SUR LE MODELE, ON ACTIVE LES S_STRUC:
      IF (ICODE.EQ.0 .OR. ICODE.EQ.2) THEN
        CALL JEVEUO(MATEL//'.RERR','E',IAREFE)
        ZK24(IAREFE-1+3) (1:3) = 'OUI'
      END IF

      CALL JEEXIN(MATEL//'.RELR',IRET1)
      IF (IRET1.GT.0) CALL JEDETR(MATEL//'.RELR')

      ILIRES = 0

      LPAOUT(1) = 'PMATUUR'
      LCHOUT(1) = MATEL(1:8)//'.ME001'
      LPAOUT(2) = 'PMATUNS'
      LCHOUT(2) = MATEL(1:8)//'.ME002'
      LIGRMO = MODELE//'.MODELE'

C  ---VERIFICATION DE L'EXISTENCE D'UN MODELE X-FEM-------
      CALL EXIXFE(MODELE,IER)

      IF (IER.NE.0) THEN

C  ---  CAS DU MODELE X-FEM-----------

        ILIRES = ILIRES+1
        PINTTO = MODELE(1:8)//'.TOPOSE.PIN'
        CNSETO = MODELE(1:8)//'.TOPOSE.CNS'
        HEAVTO = MODELE(1:8)//'.TOPOSE.HEA'
        LONCHA = MODELE(1:8)//'.TOPOSE.LON'
        PMILTO = MODELE(1:8)//'.TOPOSE.PMI'
        BASLOC = MODELE(1:8)//'.BASLOC'
        LSN    = MODELE(1:8)//'.LNNO'
        LST    = MODELE(1:8)//'.LTNO'
        STANO  = MODELE(1:8)//'.STNO'
        FISSNO = MODELE(1:8)//'.FISSNO'
        PINTER = MODELE(1:8)//'.TOPOFAC.OE'
      ELSE
        PINTTO = '&&MERIMO.PINTTO.BID'
        CNSETO = '&&MERIMO.CNSETO.BID'
        HEAVTO = '&&MERIMO.HEAVTO.BID'
        LONCHA = '&&MERIMO.LONCHA.BID'
        BASLOC = '&&MERIMO.BASLOC.BID'
        PMILTO = '&&MERIMO.PMILTO.BID'
        LSN    = '&&MERIMO.LNNO.BID'
        LST    = '&&MERIMO.LTNO.BID'
        STANO  = '&&MERIMO.STNO.BID'
        FISSNO  = '&&MERIMO.FISSNO.BID'
        PINTER  = '&&MERIMO.PINTER.BID'
      ENDIF

C ----- REMPLISSAGE DES CHAMPS D'ENTREE
C
      IF ((IER.NE.0).OR.((IER.EQ.0).AND.(ICODE.EQ.0))) THEN
        LPAIN(1) = 'PGEOMER'
        LCHIN(1) = CHGEOM
        LPAIN(2) = 'PMATERC'
        LCHIN(2) = MATE
        LPAIN(3) = 'PCAORIE'
        LCHIN(3) = CHCARA(1)
        LPAIN(4) = 'PCADISK'
        LCHIN(4) = CHCARA(2)
        LPAIN(5) = 'PCAGNPO'
        LCHIN(5) = CHCARA(6)
        LPAIN(6) = 'PCACOQU'
        LCHIN(6) = CHCARA(7)
        LPAIN(7) = 'PCASECT'
        LCHIN(7) = CHCARA(8)
        LPAIN(8) = 'PCAARPO'
        LCHIN(8) = CHCARA(9)
        LPAIN(9) = 'PHARMON'
        LCHIN(9) = CHHARM
        LPAIN(10) = 'PPESANR'
        LCHIN(10) = CHCHAR
        LPAIN(11) = 'PGEOME2'
        LCHIN(11) = CHGEOM
C        LPAIN(12) = ' '
C        LCHIN(12) = ' '
        LPAIN(12) = 'PCAGNBA'
        LCHIN(12) = CHCARA(11)
        LPAIN(13) = 'PCAMASS'
        LCHIN(13) = CHCARA(12)
        LPAIN(14) = 'PCAPOUF'
        LCHIN(14) = CHCARA(13)
        LPAIN(15) = 'PCAGEPO'
        LCHIN(15) = CHCARA(5)
        LPAIN(16) = 'PVARCPR'
        LCHIN(16) = CHVARC
        LPAIN(17) = 'PTEMPSR'
        LCHIN(17) = CHTIME
        LPAIN(18) = 'PNBSP_I'
        LCHIN(18) = CHCARA(16)
        LPAIN(19) = 'PFIBRES'
        LCHIN(19) = CHCARA(17)
        LPAIN(20) = 'PCOMPOR'
        LCHIN(20) = COMPOR
        LPAIN(21) = 'PCINFDI'
        LCHIN(21) = CHCARA(15)
        LPAIN(22) = 'PPINTTO'
        LCHIN(22) = PINTTO
        LPAIN(23) = 'PHEAVTO'
        LCHIN(23) = HEAVTO
        LPAIN(24) = 'PLONCHA'
        LCHIN(24) = LONCHA
        LPAIN(25) = 'PCNSETO'
        LCHIN(25) = CNSETO
        LPAIN(26) = 'PBASLOR'
        LCHIN(26) = BASLOC
        LPAIN(27) = 'PLSN'
        LCHIN(27) = LSN
        LPAIN(28) = 'PLST'
        LCHIN(28) = LST
        LPAIN(29) = 'PSTANO'
        LCHIN(29) = STANO
        LPAIN(30) = 'PPMILTO'
        LCHIN(30) = PMILTO
        LPAIN(31) = 'PFISNO'
        LCHIN(31) = FISSNO
        LPAIN(32) = 'PPINTER'
        LCHIN(32) = PINTER

        CALL CALCUL('S',OPTION,LIGRMO,32,LCHIN,LPAIN,2,LCHOUT,LPAOUT,
     &              BASE,'OUI')
        CALL REAJRE(MATEL,LCHOUT(1),BASE)
        CALL REAJRE(MATEL,LCHOUT(2),BASE)
        ILIRES = ILIRES +2      
      ENDIF
      DO 10 ICHA = 1,NCHAR
        LIGRCH = LCHAR(ICHA) (1:8)//'.CHME.LIGRE'
        ARGU = LCHAR(ICHA) (1:8)//'.CHME.LIGRE.LIEL'
        CALL JEEXIN(ARGU,IRET)
        IF (IRET.LE.0) GO TO 10
        LCHIN(1) = LCHAR(ICHA) (1:8)//'.CHME.CMULT'
        ARGU = LCHAR(ICHA) (1:8)//'.CHME.CMULT.DESC'
        CALL JEEXIN(ARGU,IRET)
        IF (IRET.LE.0) GO TO 10

        LPAIN(1) = 'PDDLMUR'
        ILIRES=ILIRES+1
        CALL CODENT(ILIRES,'D0',LCHOUT(1) (12:14))
        OPTION = 'MECA_DDLM_R'
        CALL CALCUL('S',OPTION,LIGRCH,1,LCHIN,LPAIN,1,LCHOUT,LPAOUT,
     &              BASE,'OUI')
        CALL REAJRE(MATEL,LCHOUT(1),BASE)
   10 CONTINUE

C     -- DESTRUCTION DES RESUELEM NULS :
      CALL REDETR(MATEL)

      CALL DETRSD('CHAMP_GD',CHTIME)

      CALL JEDEMA()
      END
