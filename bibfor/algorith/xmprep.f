      SUBROUTINE XMPREP(CFACE ,CONTAC,ELREF ,ELREFC,ELC   ,
     &                  FFC   ,FFP   ,FPG   ,IAINT ,IBASEC,
     &                  IPTINT,IFA   ,IGEOM ,IPGF  ,JAC   ,
     &                  JLST  ,LACT  ,ND    ,NDIM  ,NINTER,
     &                  NLACT ,NNO   ,NNOS  ,NPTF  ,NVIT  ,
     &                  RR    ,SINGU ,TAU1  ,TAU2)
      IMPLICIT NONE
      INCLUDE 'jeveux.h'
C            CONFIGURATION MANAGEMENT OF EDF VERSION
C MODIF ALGORITH  DATE 19/12/2012   AUTEUR PELLET J.PELLET 
C ======================================================================
C COPYRIGHT (C) 1991 - 2012  EDF R&D                  WWW.CODE-ASTER.ORG
C THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY  
C IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY  
C THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR     
C (AT YOUR OPTION) ANY LATER VERSION.                                   
C                                                                       
C THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT   
C WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF            
C MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU      
C GENERAL PUBLIC LICENSE FOR MORE DETAILS.                              
C                                                                       
C YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE     
C ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,         
C   1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.         
C ======================================================================
C TOLE CRP_21
C PREPARATION MATRICE OU VECTEUR EL DE CONTACT DANS UN TE
C IN CFACE  : TABLEAU CONNECTIVITE FACETTES DE CONTACT
C IN CONTAC : TYPE DE CONTACT (1: P1P1, 3: P2P1)
C IN ELREF  : TYPE ELEMENT PARENT
C IN ELREFC : EQUIVALENT LINEAIRE DE ELREF (POUR LE P2P1)
C OUT FFC   : FONCTIONS DE FORME DE CONTACT
C OUT FFP   : FONCTIONS DE FORME ELEMENT PARENT
C IN  IAINT : ADRESSE TOPOFAC.AI FISSURE COURANTE
C IN  IFA   : NUMERO DE FACETTE
C IN IGEOM  : ADRESSE COORDONNEES NOEUD EL PARENT
C IN IPGF   : NUMERO PT GAUSS FACETTE
C OUT JAC   : PRODUIT JACOBIEN*POIDS
C IN JLSN   : ADRESSE LSN
C IN JLST   : ADRESSE LST
C IN LACT   : LAGRANGES ACTIFS
C OUT ND    : NORMALE A SURFACE DE CONTACT AU PG
C IN  NDIM
C IN NINTER
C IN NLACT
C IN NNO
C IN NNOS
C OUT NVIT  : ARETE VITALE OU NON
C OUT RR    : RACINE DU RAYON A LE POINTE DE FISSURE
C IN SINGU  : PRESENCE OU NON DE LA SINGULARITE
C OUT TAU1  : 1ERE TANGENTE A LE SURFACE DE CONTACT AU PG
C OUT TAU2  : 2EME TANGENTE (EN 3D)
      INTEGER CFACE(5,3),CONTAC
      INTEGER I,IAINT,IBASEC,IFA,IGEOM,IPGF,IPTINT,J
      INTEGER JLST,K,LACT(8),NDIM,NINTER,NLACT,NNO
      INTEGER NNOS,NPTF,NVIT,SINGU,XXMMVD,ZXAIN
      REAL*8  DFBID(27,3),FFC(8),FFP(27),FFPC(27),G(3),JAC
      REAL*8  ND(3),LST,R,RR,TAU1(3),TAU2(3),X(4)
      CHARACTER*8  ELC,ELREF,ELREFC,FPG

C
C --- CALCUL DE JAC (PRODUIT DU JACOBIEN ET DU POIDS)
C --- ET DES FF DE L'ELEMENT PARENT AU POINT DE GAUSS
C --- ET LA NORMALE ND ORIENTÉE DE ESCL -> MAIT
C            
      IF (NDIM.EQ.3) THEN
      CALL XJACFF(ELREF,ELREFC,ELC,NDIM,FPG,IPTINT,IFA,CFACE,IPGF,
     &            NNO,IGEOM,IBASEC,G,JAC,FFP,FFPC,DFBID,ND,
     &            TAU1,TAU2)
      ELSEIF (NDIM.EQ.2) THEN
      CALL XJACF2(ELREF,ELREFC,ELC,NDIM,FPG,IPTINT,IFA,CFACE,NPTF,
     &            IPGF,NNO,IGEOM,IBASEC,G,JAC,FFP,FFPC,
     &            DFBID,ND,TAU1)
      ENDIF
C
C --- CALCUL DES FONCTIONS DE FORMES DE CONTACT
C
      IF (CONTAC.EQ.1) THEN
         CALL XMOFFC(LACT,NLACT,NNO,FFP,FFC)
      ELSEIF (CONTAC.EQ.3) THEN
         CALL XMOFFC(LACT,NLACT,NNOS,FFPC,FFC)
      ENDIF
C
C --- CE POINT DE GAUSS EST-IL SUR UNE ARETE?
C
      K=0
      DO 17 I=1,NINTER
        IF (K.EQ.0) THEN
           X(4)=0.D0
           DO 20 J=1,NDIM
              X(J)=ZR(IPTINT-1+NDIM*(I-1)+J)
 20        CONTINUE
           DO 21 J=1,NDIM
              X(4) = X(4) + (X(J)-G(J))*(X(J)-G(J))
 21        CONTINUE
           X(4) = SQRT(X(4))
           IF (X(4).LT.1.D-12) THEN
              K=I
              GOTO 17
           ENDIF
        ENDIF
 17    CONTINUE
C
       ZXAIN = XXMMVD('ZXAIN')
       IF (K.NE.0) THEN
          NVIT = NINT(ZR(IAINT-1+ZXAIN*(K-1)+5))
       ELSE
          NVIT = 0
       ENDIF
C      IL NE FAUT PAS UTILISER NVIT SI LE SCHEMA D'INTEGRATION
C      NE CONTIENT PAS DE NOEUDS
       IF ((FPG(1:3).EQ.'FPG').OR.(FPG.EQ.'GAUSS')
     &     .OR.(FPG.EQ.'XCON')) NVIT=1
C
C --- CALCUL DE RR = SQRT(DISTANCE AU FOND DE FISSURE)
C
       IF (SINGU.EQ.1) THEN
           LST=0.D0
           DO 112 I=1,NNO
              LST=LST+ZR(JLST-1+I)*FFP(I)
 112       CONTINUE
           R=ABS(LST)
           RR=SQRT(R)
       ENDIF
C
      END
