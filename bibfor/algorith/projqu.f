      SUBROUTINE PROJQU (NUTYP,NDIM,NBNO,PROJ,COORDA,COORDB,COORDC,
     &                   COORDD,COORDP,NORM,COORDM,COEF,
     &                   OLDJEU,JEU,TANG,PRONOR,TANGDF,VLISSA)
C ======================================================================
C            CONFIGURATION MANAGEMENT OF EDF VERSION
C MODIF ALGORITH  DATE 21/05/2002   AUTEUR PABHHHH N.TARDIEU 
C ======================================================================
C COPYRIGHT (C) 1991 - 2001  EDF R&D                  WWW.CODE-ASTER.ORG
C THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR   
C (AT YOUR OPTION) ANY LATER VERSION.                                 
C
C THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT 
C WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF          
C MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU    
C GENERAL PUBLIC LICENSE FOR MORE DETAILS.                            
C
C YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE   
C ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,       
C    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.      
C ======================================================================
C
      IMPLICIT NONE
C
      INTEGER      NUTYP,NBNO,PROJ,PRONOR,TANGDF,NDIM
      REAL*8       COORDA(3),COORDB(3),COORDC(3),COORDD(3),COORDP(3)
      REAL*8       NORM(3),COORDM(3),COEF(NBNO),OLDJEU,JEU,VLISSA(24)
C
C ----------------------------------------------------------------------
C ROUTINE APPELEE PAR : PROJEC
C ----------------------------------------------------------------------
C
C "PROJECTION" D'UN NOEUD ESCLAVE P SUR UN QUADRANGLE MAITRE.
C EN FAIT ON CHERCHE LE TRIANGLE (CONTENANT 3 SOMMETS DU QUADRANGLE)
C DONT IL EST LE PLUS PROCHE ET ON ECRIT LA RELATION DE NON PENETRATION
C ENTRE LE NOEUD ESCLAVE ET LES 3 SOMMETS DE CE TRIANGLE.
C LES NOEUDS MILIEUX NE SONT JAMAIS PRIS EN COMPTE.
C
C IN  NUTYP  : TYPE DE MAILLE (QUAD4 , QUAD8 , QUAD9 )
C IN  NDIM   : DIMENSION DU PB
C IN  NBNO   : NOMBRE DE NOEUDS (4, 8 OU 9)
C IN  PROJ   : PROJECTION LINEAIRE (1) OU QUADRATIQUE (2) SUR LA MAILLE
C              OU PAS DE NOUVELLE PROJECTION (0)
C IN  COORDA : COORDONNEES DU SOMMET A DU QUADRANGLE
C IN  COORDB : COORDONNEES DU SOMMET B DU QUADRANGLE
C IN  COORDC : COORDONNEES DU SOMMET C DU QUADRANGLE
C IN  COORDD : COORDONNEES DU SOMMET D DU QUADRANGLE
C IN  COORDP : COORDONNEES DU NOEUD ESCLAVE P
C OUT NORM   : DIRECTION PM (NORMEE POUR ETRE UNITAIRE)
C OUT COORDM : COORDONNEES DE LA "PROJECTION" M
C OUT COEF   : VALEURS EN M DES FONCTIONS DE FORME ASSOCIEES
C              AUX NOEUDS MAITRES
C OUT OLDJEU : JEU AVANT CORRECTION DES PROJECTIONS TOMBANT HORS DE
C              LA MAILLE MAITRE
C OUT JEU    : JEU DANS LA DIRECTION (NORM) DE LA NORMALE ENTRANTE
C              A LA MAILLE MAITRE (PM.NORM)
C
C ----------------------------------------------------------------------
C
      INTEGER K, KMIN, NTQUA4, NTQUA8, NTQUA9
      REAL*8  OLDJ(4),NEWJ(4),COORM(12),NORMAL(12),COEFFI(12),JEUMIN
      REAL*8  R8GAEM,TANG(6),TANGEN(24)
      CHARACTER*32   JEXNOM
C
C ----------------------------------------------------------------------
C
      CALL JENONU(JEXNOM('&CATA.TM.NOMTM','QUAD4') , NTQUA4 )
      CALL JENONU(JEXNOM('&CATA.TM.NOMTM','QUAD8') , NTQUA8 )
      CALL JENONU(JEXNOM('&CATA.TM.NOMTM','QUAD9') , NTQUA9 )
      DO 10 K = 1,NBNO
        COEF(K) = 0.D0
 10   CONTINUE
C
C ======================================================================
C                             PROJECTION LINEAIRE
C ======================================================================
C
      IF ((NUTYP.EQ.NTQUA4).OR.(PROJ.EQ.1)) THEN
C
C --- ON CHERCHE LE TRIANGLE (CONTENANT 3 SOMMETS DU QUADRANGLE)
C --- DONT LE NOEUD ESCLAVE EST LE PLUS PROCHE.
C
        NORMAL(1) = NORM(1)
        NORMAL(2) = NORM(2)
        NORMAL(3) = NORM(3)
        TANGEN(1) = TANG(1)
        TANGEN(2) = TANG(2)
        TANGEN(3) = TANG(3)
        CALL PROJTR (6,NDIM,3,PROJ,COORDA,COORDB,COORDC,COORDP,
     &    NORMAL(1),COORM(1),COEFFI(1),OLDJ(1),NEWJ(1),TANGEN(1),
     &    PRONOR,TANGDF,VLISSA)
        NORMAL(4) = NORM(1)
        NORMAL(5) = NORM(2)
        NORMAL(6) = NORM(3)
        TANGEN(7) = TANG(1)
        TANGEN(8) = TANG(2)
        TANGEN(9) = TANG(3)
        CALL PROJTR (6,NDIM,3,PROJ,COORDA,COORDC,COORDD,COORDP,
     &    NORMAL(4),COORM(4),COEFFI(4),OLDJ(2),NEWJ(2),TANGEN(7),
     &    PRONOR,TANGDF,VLISSA)
        NORMAL(7)  = NORM(1)
        NORMAL(8)  = NORM(2)
        NORMAL(9)  = NORM(3)
        TANGEN(13) = TANG(1)
        TANGEN(14) = TANG(2)
        TANGEN(15) = TANG(3)
        CALL PROJTR (6,NDIM,3,PROJ,COORDA,COORDB,COORDD,COORDP,
     &    NORMAL(7),COORM(7),COEFFI(7),OLDJ(3),NEWJ(3),TANGEN(13),
     &    PRONOR,TANGDF,VLISSA)
        NORMAL(10) = NORM(1)
        NORMAL(11) = NORM(2)
        NORMAL(12) = NORM(3)
        TANGEN(19) = TANG(1)
        TANGEN(20) = TANG(2)
        TANGEN(21) = TANG(3)
        CALL PROJTR (6,NDIM,3,PROJ,COORDB,COORDC,COORDD,COORDP,
     &    NORMAL(10),COORM(10),COEFFI(10),OLDJ(4),NEWJ(4),TANGEN(19),
     &    PRONOR,TANGDF,VLISSA)
C
C --- ON CHOISIT LE TRIANGLE REALISANT LA PLUS PETITE DISTANCE
C --- AVANT CORRECTION. LA RELATION DE NON PENETRATION EST
C --- ECRITE ENTRE LE NOEUD ESCLAVE ET LES 3 SOMMETS DE CE TRIANGLE.
C
        JEUMIN = R8GAEM()
        DO 20 K = 1,4
          IF (OLDJ(K).LT.JEUMIN) THEN
            KMIN = K
            JEUMIN = OLDJ(K)
          END IF
 20     CONTINUE
        JEU    = NEWJ(KMIN)
        OLDJEU = OLDJ(KMIN)
        DO 30 K = 1,3
          NORM(K)   = NORMAL(3*(KMIN-1)+K)
          COORDM(K) = COORM(3*(KMIN-1)+K)
          TANG(K)   = TANGEN(6*(KMIN-1)+K)
          TANG(K+3) = TANGEN(6*(KMIN-1)+K+3)
 30     CONTINUE
        IF (KMIN.EQ.1) THEN
          COEF(1) = COEFFI(1)
          COEF(2) = COEFFI(2)
          COEF(3) = COEFFI(3)
          COEF(4) = 0.D0
        ELSE IF (KMIN.EQ.2) THEN
          COEF(1) = COEFFI(4)
          COEF(2) = 0.D0
          COEF(3) = COEFFI(5)
          COEF(4) = COEFFI(6)
        ELSE IF (KMIN.EQ.3) THEN
          COEF(1) = COEFFI(7)
          COEF(2) = COEFFI(8)
          COEF(3) = 0.D0
          COEF(4) = COEFFI(9)
        ELSE
          COEF(1) = 0.D0
          COEF(2) = COEFFI(10)
          COEF(3) = COEFFI(11)
          COEF(4) = COEFFI(12)
        END IF
C
      END IF
C
C ======================================================================
C                  PROJECTION QUADRATIQUE (PROJ = 2)
C ======================================================================
C
      IF (((NUTYP.EQ.NTQUA8).OR.(NUTYP.EQ.NTQUA9)).AND.(PROJ.EQ.2)) THEN
        CALL UTMESS ('F','PROJQU_02',
     &               'LA PROJECTION QUADRATIQUE POUR LES QUADRANGLES '
     &               //'N''EST PAS DISPONIBLE')
      END IF
C
C ----------------------------------------------------------------------
C
      END
