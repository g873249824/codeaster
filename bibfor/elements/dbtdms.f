      SUBROUTINE DBTDMS(NB1,NB2,INTSR,XR,VECTPT,
     &                  DHSJ1M,HSJ1S,DHSJ1S,DBTDM,DBTDS)
C 
C            CONFIGURATION MANAGEMENT OF EDF VERSION
C MODIF ELEMENTS  DATE 03/07/2012   AUTEUR PELLET J.PELLET 
C ======================================================================
C COPYRIGHT (C) 1991 - 2012  EDF R&D                  WWW.CODE-ASTER.ORG
C THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY  
C IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY  
C THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR     
C (AT YOUR OPTION) ANY LATER VERSION.                                   
C                                                                       
C THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT   
C WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF            
C MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU      
C GENERAL PUBLIC LICENSE FOR MORE DETAILS.                              
C                                                                       
C YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE     
C ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,         
C   1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.         
C ======================================================================
C
      IMPLICIT NONE
      INTEGER NB1,NB2,INTE,INTSR
      REAL*8 XR(*),VECTPT(9,2,3),DBTDM(4,3,42),DBTDS(4,2,42)
      REAL*8 DHSJ1M(3,9),HSJ1S(2,9),DHSJ1S(2,9),DZICDH
      REAL*8 DNSDS(9,42),DDNSDS(9,42),DNSDSM(9,42)
      COMMON /COUCHE/NBCOU,ICOU,INTE
      COMMON /DNSMS/DNSDSM,DNSDS
C
C-----------------------------------------------------------------------
      INTEGER I ,I3 ,I4 ,I5 ,ICOU ,INTSR2 ,J 
      INTEGER J1 ,JB ,K ,K1 ,L3 ,L4 ,L5 
      INTEGER NBCOU 
C-----------------------------------------------------------------------
      DZICDH = (ICOU-1+(INTE-1)/2.D0)/NBCOU
C
         L3=351
         L4=387
         L5=423
C
      DO 15 I=1,9
      DO 16 J=1,5*NB1+2
          DDNSDS(I,J)=0.D0
         IF (I.LE.3) DBTDM(INTSR,I,J)=0.D0
         IF (I.LE.2) DBTDS(INTSR,I,J)=0.D0
 16   CONTINUE
 15   CONTINUE
C
         INTSR2=9*(INTSR-1)
C
         I3=L3+INTSR2
         I4=L4+INTSR2
         I5=L5+INTSR2
C
      DO 30 J=1,NB1
         J1=5*(J-1)
C
          DDNSDS(1,J1+1)=0.D0
          DDNSDS(1,J1+4)=-XR(I4+J)*VECTPT(J,2,1)*DZICDH
          DDNSDS(1,J1+5)= XR(I4+J)*VECTPT(J,1,1)*DZICDH
C
          DDNSDS(2,J1+1)=0.D0
          DDNSDS(2,J1+4)=-XR(I5+J)*VECTPT(J,2,1)*DZICDH
          DDNSDS(2,J1+5)= XR(I5+J)*VECTPT(J,1,1)*DZICDH
C
          DDNSDS(3,J1+4)=-XR(I3+J)/2*(VECTPT(J,2,1)/NBCOU)
          DDNSDS(3,J1+5)= XR(I3+J)/2*(VECTPT(J,1,1)/NBCOU)
C
          DDNSDS(4,J1+2)=0.D0
          DDNSDS(4,J1+4)=-XR(I4+J)*VECTPT(J,2,2)*DZICDH
          DDNSDS(4,J1+5)= XR(I4+J)*VECTPT(J,1,2)*DZICDH
C
          DDNSDS(5,J1+2)=0.D0
          DDNSDS(5,J1+4)=-XR(I5+J)*VECTPT(J,2,2)*DZICDH
          DDNSDS(5,J1+5)= XR(I5+J)*VECTPT(J,1,2)*DZICDH
C
          DDNSDS(6,J1+4)=-XR(I3+J)/2*(VECTPT(J,2,2)/NBCOU)
          DDNSDS(6,J1+5)= XR(I3+J)/2*(VECTPT(J,1,2)/NBCOU)
C
          DDNSDS(7,J1+3)=0.D0
          DDNSDS(7,J1+4)=-XR(I4+J)*VECTPT(J,2,3)*DZICDH
          DDNSDS(7,J1+5)= XR(I4+J)*VECTPT(J,1,3)*DZICDH
C
          DDNSDS(8,J1+3)=0.D0
          DDNSDS(8,J1+4)=-XR(I5+J)*VECTPT(J,2,3)*DZICDH
          DDNSDS(8,J1+5)= XR(I5+J)*VECTPT(J,1,3)*DZICDH
C
          DDNSDS(9,J1+4)=-XR(I3+J)/2*(VECTPT(J,2,3)/NBCOU)
          DDNSDS(9,J1+5)= XR(I3+J)/2*(VECTPT(J,1,3)/NBCOU)
 30   CONTINUE
C
          DDNSDS(1,5*NB1+1)=-XR(I4+NB2)*VECTPT(NB2,2,1)*DZICDH
          DDNSDS(1,5*NB1+2)= XR(I4+NB2)*VECTPT(NB2,1,1)*DZICDH
C
          DDNSDS(2,5*NB1+1)=-XR(I5+NB2)*VECTPT(NB2,2,1)*DZICDH
          DDNSDS(2,5*NB1+2)= XR(I5+NB2)*VECTPT(NB2,1,1)*DZICDH
C
          DDNSDS(3,5*NB1+1)=-XR(I3+NB2)/2*(VECTPT(NB2,2,1)/NBCOU)
          DDNSDS(3,5*NB1+2)= XR(I3+NB2)/2*(VECTPT(NB2,1,1)/NBCOU)
C
          DDNSDS(4,5*NB1+1)=-XR(I4+NB2)*VECTPT(NB2,2,2)*DZICDH
          DDNSDS(4,5*NB1+2)= XR(I4+NB2)*VECTPT(NB2,1,2)*DZICDH
C
          DDNSDS(5,5*NB1+1)=-XR(I5+NB2)*VECTPT(NB2,2,2)*DZICDH
          DDNSDS(5,5*NB1+2)= XR(I5+NB2)*VECTPT(NB2,1,2)*DZICDH
C
          DDNSDS(6,5*NB1+1)=-XR(I3+NB2)/2*(VECTPT(NB2,2,2)/NBCOU)
          DDNSDS(6,5*NB1+2)= XR(I3+NB2)/2*(VECTPT(NB2,1,2)/NBCOU)
C
          DDNSDS(7,5*NB1+1)=-XR(I4+NB2)*VECTPT(NB2,2,3)*DZICDH
          DDNSDS(7,5*NB1+2)= XR(I4+NB2)*VECTPT(NB2,1,3)*DZICDH
C
          DDNSDS(8,5*NB1+1)=-XR(I5+NB2)*VECTPT(NB2,2,3)*DZICDH
          DDNSDS(8,5*NB1+2)= XR(I5+NB2)*VECTPT(NB2,1,3)*DZICDH
C
          DDNSDS(9,5*NB1+1)=-XR(I3+NB2)/2*(VECTPT(NB2,2,3)/NBCOU)
          DDNSDS(9,5*NB1+2)= XR(I3+NB2)/2*(VECTPT(NB2,1,3)/NBCOU)
C
C     CONSTRUCTION DE DBTILDM = DHSJ1M * DNSDSM  : (3,5*NB1+2)
C
      DO 40  I=1,3
      DO 50 JB=1,NB1
      DO 60  J=1,3
         J1=J+5*(JB-1)
         DBTDM(INTSR,I,J1)=0.D0
      DO 70  K=1,2
         K1=K+3*(J-1)
         DBTDM(INTSR,I,J1)=DBTDM(INTSR,I,J1)+DHSJ1M(I,K1)*DNSDSM(K1,J1)
 70   CONTINUE
 60   CONTINUE
 50   CONTINUE
         DBTDM(INTSR,I,5*NB1+1)=0.D0
         DBTDM(INTSR,I,5*NB1+2)=0.D0
 40   CONTINUE
C
C CONSTRUCTION DE DBTILDS = DHSJ1S * DNSDS + HSJ1S * DDNSDS: (2,5*NB1+2)
C
      DO  80  I=1,2
      DO  90 JB=1,NB1
      DO 100  J=1,5
          J1=J+5*(JB-1)
          DBTDS(INTSR,I,J1)=0
      IF (J.LE.3) THEN
      DO 110  K=1,2
          K1=K+3*(J-1)
          DBTDS(INTSR,I,J1)=DBTDS(INTSR,I,J1)+DHSJ1S(I,K1)*DNSDS(K1,J1)
     &                                       +HSJ1S(I,K1)*DDNSDS(K1,J1)
 110  CONTINUE
      ELSE
      DO 120  K=1,9
          DBTDS(INTSR,I,J1)=DBTDS(INTSR,I,J1)+DHSJ1S(I,K)*DNSDS(K,J1)
     &                                       +HSJ1S(I,K)*DDNSDS(K,J1)
 120  CONTINUE
      ENDIF
 100  CONTINUE
 90   CONTINUE
      DO 130  J=1,2
          J1=5*NB1+J
          DBTDS(INTSR,I,J1)=0.D0
      DO 140  K=1,9
          DBTDS(INTSR,I,J1)=DBTDS(INTSR,I,J1)+DHSJ1S(I,K)*DNSDS(K,J1)
     &                                       +HSJ1S(I,K)*DDNSDS(K,J1)
 140  CONTINUE
 130  CONTINUE
 80   CONTINUE
      END
